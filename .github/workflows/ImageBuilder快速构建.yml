#
# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# Description: Build ImmortalWrt using Official ImageBuilder
#

name: ImageBuilderå¿«é€Ÿæž„å»º

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      REPO_VERSION:
        description: 'ImmortalWrt ç‰ˆæœ¬ (å¦‚: 24.10.3)'
        required: true
        default: '24.10.3'
        type: string
      DEVICE_MODEL:
        description: 'é€‰æ‹©è®¾å¤‡åž‹å·'
        required: true
        default: 'rax3000m'
        type: choice
        options:
          - rax3000m
          - ax6000
      LAN_IP:
        description: 'è®¾ç½®LAN IPåœ°å€'
        required: true
        default: '192.168.1.1'
      PACKAGES_ADD:
        description: 'è¦å®‰è£…çš„è½¯ä»¶åŒ… (ç©ºæ ¼åˆ†éš”)'
        required: false
        default: 'luci-theme-argon luci-app-ttyd luci-app-diskman'
        type: string
      PACKAGES_REMOVE:
        description: 'è¦ç§»é™¤çš„è½¯ä»¶åŒ… (ç©ºæ ¼åˆ†éš”ï¼Œå‰é¢åŠ -)'
        required: false
        default: ''
        type: string
      RUN_CUSTOM_SCRIPT:
        description: 'æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬'
        required: false
        default: true
        type: boolean
      UPLOAD_FIRMWARE:
        description: 'ä¸Šä¼ å›ºä»¶åˆ°Artifacts'
        required: false
        default: true
        type: boolean
      UPLOAD_RELEASE:
        description: 'å‘å¸ƒå›ºä»¶åˆ°Release'
        required: false
        default: true
        type: boolean

env:
  CUSTOM_SCRIPT: imagebuilder-custom.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    
    permissions:
      contents: write
    
    steps:
    - name: æ£€æŸ¥é¡¹ç›®åˆ†æ”¯
      uses: actions/checkout@main

    - name: è®¾ç½®ç‰ˆæœ¬å˜é‡
      run: |
        # æ£€æŸ¥ç‰ˆæœ¬è¾“å…¥
        if [ -z "${{ github.event.inputs.REPO_VERSION }}" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæŒ‡å®šç‰ˆæœ¬ä¿¡æ¯"
          exit 1
        fi
        
        REPO_VERSION="${{ github.event.inputs.REPO_VERSION }}"
        echo "REPO_VERSION=$REPO_VERSION" >> $GITHUB_ENV
        
        echo "======================================"
        echo "ðŸ“‹ ç¼–è¯‘ä¿¡æ¯"
        echo "======================================"
        echo "ImageBuilderç‰ˆæœ¬: $REPO_VERSION"
        echo "ç¼–è¯‘æ¨¡å¼: ImageBuilder (å¿«é€Ÿæž„å»º)"
        echo "======================================"

    - name: è®¾ç½®è®¾å¤‡å˜é‡
      run: |
        DEVICE_MODEL="${{ github.event.inputs.DEVICE_MODEL }}"
        if [ -z "$DEVICE_MODEL" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæŒ‡å®šè®¾å¤‡åž‹å·"
          exit 1
        fi
        
        echo "DEVICE_MODEL=$DEVICE_MODEL" >> $GITHUB_ENV
        echo "CONFIG_FILE=${DEVICE_MODEL}.config" >> $GITHUB_ENV
        
        # æ ¹æ®è®¾å¤‡åž‹å·è®¾ç½®å˜é‡
        case "$DEVICE_MODEL" in
          "rax3000m")
            echo "DEVICE_NAME=cmcc_rax3000m" >> $GITHUB_ENV
            echo "DEVICE_PROFILE=cmcc_rax3000m" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=CMCC-RAX3000M" >> $GITHUB_ENV
            echo "TARGET_NAME=mediatek-filogic" >> $GITHUB_ENV
            ;;
          "ax6000")
            echo "DEVICE_NAME=jdcloud_re-cp-03" >> $GITHUB_ENV
            echo "DEVICE_PROFILE=jdcloud_re-cp-03" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=JDCloud-AX6000" >> $GITHUB_ENV
            echo "TARGET_NAME=mediatek-filogic" >> $GITHUB_ENV
            ;;
          *)
            echo "âŒ é”™è¯¯ï¼šä¸æ”¯æŒçš„è®¾å¤‡åž‹å·: $DEVICE_MODEL"
            exit 1
            ;;
        esac
        
        echo "FILE_DATE=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV
        
        echo "======================================"
        echo "è®¾å¤‡åž‹å·: $DEVICE_MODEL"
        echo "è®¾å¤‡åç§°: $DEVICE_FULL_NAME"
        echo "ç›®æ ‡å¹³å°: $TARGET_NAME"
        echo "======================================"

    - name: åˆå§‹åŒ–ç¼–è¯‘çŽ¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        # ImageBuilderéœ€è¦çš„ä¾èµ–æ›´å°‘
        sudo -E apt-get -qq install -y \
          build-essential libncurses5-dev libncursesw5-dev \
          zlib1g-dev gawk git gettext libssl-dev xsltproc \
          rsync wget unzip python3 python3-distutils zstd
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        echo "======================================"
        echo "âœ… ç¼–è¯‘çŽ¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
        echo "======================================"

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: false
        swap-storage: false

    - name: ä¸‹è½½å®˜æ–¹ImageBuilder
      working-directory: /workdir
      run: |
        df -hT $PWD
        echo "======================================"
        echo "ðŸ“¦ ä¸‹è½½å®˜æ–¹ ImageBuilder"
        echo "======================================"
        
        VERSION="${{ github.event.inputs.REPO_VERSION }}"
        TARGET_PATH=$(echo "${{ env.TARGET_NAME }}" | tr '-' '/')
        
        # æž„å»ºImageBuilderä¸‹è½½URLï¼ˆæ³¨æ„æ–‡ä»¶åæ ¼å¼å’Œæ‰©å±•åï¼‰
        IB_NAME="immortalwrt-imagebuilder-${VERSION}-${{ env.TARGET_NAME }}.Linux-x86_64.tar.zst"
        IB_URL="https://downloads.immortalwrt.org/releases/${VERSION}/targets/${TARGET_PATH}/${IB_NAME}"
        
        echo "ImageBuilderæ–‡ä»¶: $IB_NAME"
        echo "ä¸‹è½½åœ°å€: $IB_URL"
        
        # ä¸‹è½½ImageBuilder
        echo "å¼€å§‹ä¸‹è½½..."
        if ! wget --show-progress "$IB_URL" -O imagebuilder.tar.zst; then
          echo "âŒ é”™è¯¯ï¼šä¸‹è½½å¤±è´¥"
          echo "å°è¯•æŸ¥çœ‹å¯ç”¨æ–‡ä»¶..."
          wget -qO- "https://downloads.immortalwrt.org/releases/${VERSION}/targets/${TARGET_PATH}/" | grep -o 'immortalwrt-imagebuilder[^"]*' | head -5
          exit 1
        fi
        
        # è§£åŽ‹ImageBuilderï¼ˆä½¿ç”¨zstdï¼‰
        echo "è§£åŽ‹ImageBuilder..."
        tar -I zstd -xf imagebuilder.tar.zst
        
        # é‡å‘½åä¸ºç»Ÿä¸€çš„ç›®å½•å
        mv immortalwrt-imagebuilder-* ImmortalWrt
        ln -sf /workdir/ImmortalWrt $GITHUB_WORKSPACE/ImmortalWrt
        
        cd ImmortalWrt
        
        # æ˜¾ç¤ºImageBuilderä¿¡æ¯
        echo "======================================"
        echo "ImageBuilder ä¿¡æ¯:"
        
        # æ˜¾ç¤ºå¯ç”¨çš„è®¾å¤‡é…ç½®
        echo "å¯ç”¨çš„è®¾å¤‡é…ç½®:"
        make info | grep -A 5 "Default Packages:" || true
        
        echo "ç›®å½•ç»“æž„:"
        ls -la
        
        # æ˜¾ç¤ºä»“åº“é…ç½®
        if [ -f "repositories.conf" ]; then
          echo "è½¯ä»¶ä»“åº“é…ç½®:"
          cat repositories.conf
        fi
        
        echo "======================================"
        echo "âœ… ImageBuilder å‡†å¤‡å®Œæˆ"
        echo "======================================"

    - name: é…ç½®è‡ªå®šä¹‰æ–‡ä»¶
      run: |
        cd ImmortalWrt
        
        # åˆ›å»ºè‡ªå®šä¹‰æ–‡ä»¶ç›®å½•
        mkdir -p files/etc/config
        mkdir -p files/etc/uci-defaults
        
        # è®¾ç½®é»˜è®¤IPåœ°å€
        SET_IP="${{ github.event.inputs.LAN_IP }}"
        
        # éªŒè¯IPåœ°å€æ ¼å¼
        if ! [[ $SET_IP =~ ^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$ ]]; then
            echo "âŒ é”™è¯¯ï¼šIPåœ°å€æ ¼å¼æ— æ•ˆ: $SET_IP"
            exit 1
        fi
        
        # åˆ›å»ºé¦–æ¬¡å¯åŠ¨è„šæœ¬è®¾ç½®IP
        cat > files/etc/uci-defaults/99-custom-settings <<EOF
        #!/bin/sh
        
        # è®¾ç½®LAN IP
        uci set network.lan.ipaddr='$SET_IP'
        uci commit network
        
        # è®¾ç½®ä¸»æœºå
        uci set system.@system[0].hostname='ImmortalWrt'
        uci set system.@system[0].timezone='CST-8'
        uci set system.@system[0].zonename='Asia/Shanghai'
        uci commit system
        
        # è®¾ç½®é»˜è®¤ä¸»é¢˜ï¼ˆå¦‚æžœå®‰è£…äº†argonï¼‰
        if [ -f /usr/lib/lua/luci/themes/argon/cascade.css ]; then
          uci set luci.main.mediaurlbase='/luci-static/argon'
          uci commit luci
        fi
        
        exit 0
        EOF
        
        chmod +x files/etc/uci-defaults/99-custom-settings
        
        echo "IP_ADDR=$SET_IP" >> $GITHUB_ENV
        echo "======================================"
        echo "âœ… è‡ªå®šä¹‰æ–‡ä»¶é…ç½®å®Œæˆ"
        echo "âœ… LAN IP è®¾ç½®ä¸º: $SET_IP"
        echo "======================================"

    - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
      if: ${{ github.event.inputs.RUN_CUSTOM_SCRIPT == 'true' }}
      run: |
        if [ -f "$CUSTOM_SCRIPT" ]; then
          chmod +x $CUSTOM_SCRIPT
          cd ImmortalWrt
          echo "======================================"
          echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬..."
          echo "======================================"
          $GITHUB_WORKSPACE/$CUSTOM_SCRIPT
        else
          echo "è‡ªå®šä¹‰è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi

    - name: å‡†å¤‡è½¯ä»¶åŒ…åˆ—è¡¨
      run: |
        cd ImmortalWrt
        
        echo "======================================"
        echo "ðŸ“¦ å‡†å¤‡è½¯ä»¶åŒ…åˆ—è¡¨"
        echo "======================================"
        
        # åŸºç¡€åŒ…åˆ—è¡¨
        BASE_PACKAGES="luci luci-i18n-base-zh-cn luci-i18n-firewall-zh-cn luci-i18n-opkg-zh-cn"
        BASE_PACKAGES="$BASE_PACKAGES luci-theme-bootstrap default-settings-chn"
        
        # ä»Žé…ç½®æ–‡ä»¶è¯»å–åŒ…åˆ—è¡¨ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
        if [ -f "$GITHUB_WORKSPACE/${{ env.CONFIG_FILE }}" ]; then
          echo "ä»Žé…ç½®æ–‡ä»¶è¯»å–è½¯ä»¶åŒ…..."
          # æå–CONFIG_PACKAGE_xxx=yçš„åŒ…å
          CONFIG_PACKAGES=$(grep "^CONFIG_PACKAGE_.*=y" "$GITHUB_WORKSPACE/${{ env.CONFIG_FILE }}" | \
                           sed 's/CONFIG_PACKAGE_//;s/=y//' | tr '\n' ' ')
          echo "é…ç½®æ–‡ä»¶ä¸­çš„åŒ…: $CONFIG_PACKAGES"
        else
          CONFIG_PACKAGES=""
        fi
        
        # ç”¨æˆ·æŒ‡å®šçš„é¢å¤–åŒ…
        ADD_PACKAGES="${{ github.event.inputs.PACKAGES_ADD }}"
        REMOVE_PACKAGES="${{ github.event.inputs.PACKAGES_REMOVE }}"
        
        # ç»„åˆæ‰€æœ‰åŒ…
        ALL_PACKAGES="$BASE_PACKAGES $CONFIG_PACKAGES $ADD_PACKAGES"
        
        # æ·»åŠ è¦ç§»é™¤çš„åŒ…ï¼ˆå‰é¢åŠ -ï¼‰
        if [ -n "$REMOVE_PACKAGES" ]; then
          for pkg in $REMOVE_PACKAGES; do
            ALL_PACKAGES="$ALL_PACKAGES -$pkg"
          done
        fi
        
        # ä¿å­˜åˆ°çŽ¯å¢ƒå˜é‡
        echo "PACKAGES=$ALL_PACKAGES" >> $GITHUB_ENV
        
        echo "æœ€ç»ˆè½¯ä»¶åŒ…åˆ—è¡¨:"
        echo "$ALL_PACKAGES" | tr ' ' '\n' | sort | uniq
        echo "======================================"

    
    - name: æž„å»ºå›ºä»¶ï¼ˆç®€åŒ–ç‰ˆï¼‰
      id: compile
      run: |
        cd ImmortalWrt
        echo "======================================"
        echo "ðŸ”¨ å¼€å§‹æž„å»ºå›ºä»¶ï¼ˆImageBuilderæ¨¡å¼ï¼‰"
        echo "======================================"
        
        # æ–¹æ¡ˆ1ï¼šä½¿ç”¨ImageBuilderé»˜è®¤åŒ…
        echo "ä½¿ç”¨é»˜è®¤é…ç½®æž„å»º..."
        make image PROFILE="${{ env.DEVICE_PROFILE }}"
        
        # æ£€æŸ¥ç»“æžœ
        if ls bin/targets/mediatek/filogic/*.bin >/dev/null 2>&1; then
          echo "âœ… é»˜è®¤æž„å»ºæˆåŠŸ"
          
          # å¦‚æžœé»˜è®¤æž„å»ºæˆåŠŸï¼Œå°è¯•æ·»åŠ è‡ªå®šä¹‰åŒ…
          echo "å°è¯•æ·»åŠ è‡ªå®šä¹‰åŒ…..."
          
          # æ¸…ç†ä¹‹å‰çš„æž„å»º
          make clean
          
          # åªæ·»åŠ ä¸ä¼šå†²çªçš„åŒ…
          SAFE_PACKAGES="luci-theme-argon luci-app-ttyd luci-i18n-base-zh-cn"
          
          if make image PROFILE="${{ env.DEVICE_PROFILE }}" PACKAGES="$SAFE_PACKAGES" FILES="files"; then
            echo "âœ… è‡ªå®šä¹‰æž„å»ºæˆåŠŸ"
          else
            echo "âš ï¸ è‡ªå®šä¹‰æž„å»ºå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æž„å»º"
            # é‡æ–°æž„å»ºé»˜è®¤
            make clean
            make image PROFILE="${{ env.DEVICE_PROFILE }}"
          fi
          
          echo "status=success" >> $GITHUB_OUTPUT
          
        else
          echo "âŒ æž„å»ºå¤±è´¥"
          exit 1
        fi
        
        # æ˜¾ç¤ºç»“æžœ
        echo "======================================"
        echo "æž„å»ºç»“æžœ:"
        ls -lah bin/targets/mediatek/filogic/
        echo "======================================"

    - name: æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
      if: (!cancelled())
      run: df -hT

    - name: èŽ·å–å®˜æ–¹ABIå¯¹æ¯”
      run: |
        echo "======================================"
        echo "ðŸ” ABI ä¿¡æ¯èŽ·å–"
        echo "======================================"
        
        cd ImmortalWrt
        
        VERSION="${{ github.event.inputs.REPO_VERSION }}"
        TARGET_NAME="${{ env.TARGET_NAME }}"
        TARGET_PATH=$(echo "$TARGET_NAME" | tr '-' '/')
        
        # èŽ·å–å®˜æ–¹ABI
        OFFICIAL_MANIFEST_URL="https://downloads.immortalwrt.org/releases/$VERSION/targets/$TARGET_PATH/immortalwrt-$VERSION-$TARGET_NAME.manifest"
        echo "èŽ·å–å®˜æ–¹manifest: $OFFICIAL_MANIFEST_URL"
        
        if wget -q -O official.manifest "$OFFICIAL_MANIFEST_URL"; then
          OFFICIAL_ABI=$(grep '^kernel ' official.manifest | awk '{print $3}' | head -1)
          echo "å®˜æ–¹ ABI: ${OFFICIAL_ABI:-èŽ·å–å¤±è´¥}"
          echo "OFFICIAL_ABI=$OFFICIAL_ABI" >> $GITHUB_ENV
        else
          echo "å®˜æ–¹ ABI: èŽ·å–å¤±è´¥"
          echo "OFFICIAL_ABI=èŽ·å–å¤±è´¥" >> $GITHUB_ENV
        fi
        
        # èŽ·å–æœ¬åœ°æž„å»ºçš„ABIï¼ˆImageBuilderä½¿ç”¨å®˜æ–¹å†…æ ¸ï¼Œæ‰€ä»¥ABIåº”è¯¥ä¸€è‡´ï¼‰
        LOCAL_MANIFEST=$(find bin/targets -name "*.manifest" 2>/dev/null | head -1)
        if [ -n "$LOCAL_MANIFEST" ]; then
          LOCAL_ABI=$(grep '^kernel ' "$LOCAL_MANIFEST" | awk '{print $3}' | head -1)
          echo "æœ¬åœ° ABI: ${LOCAL_ABI:-èŽ·å–å¤±è´¥}"
          echo "LOCAL_ABI=$LOCAL_ABI" >> $GITHUB_ENV
        else
          echo "æœ¬åœ° ABI: èŽ·å–å¤±è´¥"
          echo "LOCAL_ABI=èŽ·å–å¤±è´¥" >> $GITHUB_ENV
        fi
        
        # ABIå¯¹æ¯”ï¼ˆImageBuilderæž„å»ºçš„å›ºä»¶ABIåº”è¯¥ä¸Žå®˜æ–¹å®Œå…¨ä¸€è‡´ï¼‰
        echo "======================================"
        if [ -n "$OFFICIAL_ABI" ] && [ "$OFFICIAL_ABI" != "èŽ·å–å¤±è´¥" ] && [ -n "$LOCAL_ABI" ] && [ "$LOCAL_ABI" != "èŽ·å–å¤±è´¥" ]; then
          if [ "$OFFICIAL_ABI" = "$LOCAL_ABI" ]; then
            echo "âœ… ABI å¯¹æ¯”ç»“æžœ: å®Œå…¨ä¸€è‡´ (é¢„æœŸç»“æžœ)"
            echo "ABI_STATUS=âœ… ä¸€è‡´" >> $GITHUB_ENV
          else
            echo "âš ï¸ ABI å¯¹æ¯”ç»“æžœ: ä¸ä¸€è‡´ (å¼‚å¸¸)"
            echo "å®˜æ–¹: $OFFICIAL_ABI"
            echo "æœ¬åœ°: $LOCAL_ABI"
            echo "ABI_STATUS=âš ï¸ ä¸ä¸€è‡´" >> $GITHUB_ENV
          fi
        else
          echo "âš ï¸ ABI å¯¹æ¯”ç»“æžœ: æ— æ³•å¯¹æ¯”"
          echo "ABI_STATUS=âš ï¸ æ— æ³•å¯¹æ¯”" >> $GITHUB_ENV
        fi
        echo "======================================"

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: github.event.inputs.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd ImmortalWrt/bin/targets/*/*
        rm -rf packages
        
        # é‡å‘½åå›ºä»¶æ–‡ä»¶
        for file in *; do
          if [[ -f "$file" ]]; then
            # æå–æ–‡ä»¶æ‰©å±•å
            ext="${file##*.}"
            # æ ¹æ®æ–‡ä»¶ç±»åž‹é‡å‘½å
            case "$file" in
              *sysupgrade*)
                new_name="${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-ImageBuilder-sysupgrade.$ext"
                ;;
              *factory*)
                new_name="${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-ImageBuilder-factory.$ext"
                ;;
              *)
                new_name="${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-ImageBuilder-${file#*${{ env.DEVICE_NAME }}-}"
                ;;
            esac
            mv "$file" "$new_name" 2>/dev/null || mv "$file" "${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-ImageBuilder-$file"
          fi
        done
        
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        
        echo "======================================"
        echo "ðŸ“¦ å›ºä»¶æ–‡ä»¶åˆ—è¡¨:"
        echo "======================================"
        ls -lh *.bin *.img.gz 2>/dev/null || ls -lh
        echo "======================================"

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifacts
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && github.event.inputs.UPLOAD_FIRMWARE == 'true'
      with:
        name: ${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-ImageBuilder-Firmware
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: github.event.inputs.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        echo "release_tag=${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-ImageBuilder" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT
        
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        cat > release.txt <<EOF
        # ${{ env.DEVICE_FULL_NAME }} å›ºä»¶ (ImageBuilderæž„å»º)
        
        ## ðŸ“‹ å›ºä»¶ä¿¡æ¯
        
        - **è®¾å¤‡åž‹å·**: ${{ env.DEVICE_FULL_NAME }}
        - **æž„å»ºæ–¹å¼**: å®˜æ–¹ImageBuilder (å¿«é€Ÿæž„å»º)
        - **ç›®æ ‡å¹³å°**: ${{ env.TARGET_NAME }}
        - **æž„å»ºæ—¶é—´**: ${{ env.FILE_DATE }}
        - **ç™»å½•åœ°å€**: ${{ env.IP_ADDR }}
        - **é»˜è®¤å¯†ç **: æ— å¯†ç æˆ– password
        
        ## ðŸ“¦ ç‰ˆæœ¬ä¿¡æ¯
        
        - **ImageBuilderç‰ˆæœ¬**: ${{ env.REPO_VERSION }}
        - **å®‰è£…çš„è½¯ä»¶åŒ…**: 
          - æ·»åŠ : ${{ github.event.inputs.PACKAGES_ADD }}
          - ç§»é™¤: ${{ github.event.inputs.PACKAGES_REMOVE }}
        
        ## ðŸ” ABI ä¿¡æ¯
        
        - **å®˜æ–¹ ABI**: ${{ env.OFFICIAL_ABI }}
        - **æœ¬åœ° ABI**: ${{ env.LOCAL_ABI }}
        - **å¯¹æ¯”ç»“æžœ**: ${{ env.ABI_STATUS }}
        
        ## âš¡ ImageBuilderä¼˜åŠ¿
        
        - âœ… æž„å»ºé€Ÿåº¦æžå¿«ï¼ˆä»…éœ€å‡ åˆ†é’Ÿï¼‰
        - âœ… ABIä¸Žå®˜æ–¹å›ºä»¶100%ä¸€è‡´
        - âœ… å¯ç›´æŽ¥å®‰è£…å®˜æ–¹ä»“åº“æ‰€æœ‰è½¯ä»¶åŒ…
        - âœ… ç¨³å®šæ€§ä¸Žå®˜æ–¹å›ºä»¶ç›¸åŒ
        - âš ï¸ ä»…æ”¯æŒé¢„ç¼–è¯‘åŒ…ï¼Œæ— æ³•ç¼–è¯‘æ–°çš„å†…æ ¸æ¨¡å—
        
        ## âš ï¸ æ³¨æ„äº‹é¡¹
        
        - æ­¤å›ºä»¶ä½¿ç”¨å®˜æ–¹ImageBuilderæž„å»º
        - å†…æ ¸ä¸Žå®˜æ–¹å›ºä»¶å®Œå…¨ç›¸åŒ
        - å‡çº§å‰è¯·å¤‡ä»½é‡è¦é…ç½®
        
        ---
        *è‡ªåŠ¨æž„å»º by GitHub Actions*
        EOF

    - name: å‘å¸ƒå›ºä»¶åˆ°Release
      uses: softprops/action-gh-release@v2.1.0
      if: steps.tag.outputs.status == 'success' && github.event.inputs.UPLOAD_RELEASE == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.FIRMWARE }}/*
        name: ${{ env.DEVICE_FULL_NAME }} - ${{ env.FILE_DATE }} (ImageBuilder)
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        draft: false
        prerelease: false

    - name: åˆ é™¤æ—§çš„workflowè¿è¡Œè®°å½•
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 7
        keep_minimum_runs: 10

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@v0.3.2
      if: github.event.inputs.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 10
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
