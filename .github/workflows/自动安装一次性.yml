name: è‡ªåŠ¨å®‰è£…ä¸€æ¬¡æ€§
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      REPO_VERSION:
        description: 'é€‰æ‹© ImmortalWrt ç‰ˆæœ¬ (æ ¼å¼: 24.10.2 æˆ–åˆ†æ”¯å)'
        required: true
        default: '24.10.2'
        type: string
      DEVICE_MODEL:
        description: 'é€‰æ‹©é…ç½®æ–‡ä»¶'
        required: true
        default: 'rax3000m'
        type: choice
        options:
          - rax3000m
          - ax6000
      LAN_IP:
        description: 'è®¾ç½®LAN IPåœ°å€'
        required: true
        default: '192.168.1.1'
      FIX_VERMAGIC:
        description: 'ä¿®å¤ vermagic ä»¥å…¼å®¹å®˜æ–¹è½¯ä»¶æº'
        required: false
        default: true
        type: boolean
      UPLOAD_BIN_DIR:
        description: 'ä¸Šä¼ binç›®å½•'
        required: false
        default: false
        type: boolean
      UPLOAD_FIRMWARE:
        description: 'ä¸Šä¼ å›ºä»¶åˆ°Artifacts'
        required: false
        default: true
        type: boolean
      UPLOAD_RELEASE:
        description: 'å‘å¸ƒå›ºä»¶åˆ°Release'
        required: false
        default: true
        type: boolean

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  FEEDS_CONF: feeds.conf.default
  DIY_P1_SH: part1.sh
  DIY_P2_SH: part2.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    
    permissions:
      contents: write
    
    steps:
    - name: æ£€æŸ¥é¡¹ç›®åˆ†æ”¯
      uses: actions/checkout@main

    - name: è®¾ç½®ç‰ˆæœ¬å˜é‡
      run: |
        if [ -z "${{ github.event.inputs.REPO_VERSION }}" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæŒ‡å®šç‰ˆæœ¬ä¿¡æ¯"
          echo "è¯·åœ¨å·¥ä½œæµè¿è¡Œæ—¶æŒ‡å®š ImmortalWrt ç‰ˆæœ¬ï¼ˆtagæˆ–branchï¼‰"
          exit 1
        fi
        
        REPO_VERSION="${{ github.event.inputs.REPO_VERSION }}"
        echo "REPO_VERSION=$REPO_VERSION" >> $GITHUB_ENV
        
        echo "======================================"
        echo "ç”¨æˆ·æŒ‡å®šçš„ç‰ˆæœ¬: $REPO_VERSION"
        echo "æºç ä»“åº“: $REPO_URL"
        echo "======================================"
        
    - name: è®¾ç½®è®¾å¤‡å˜é‡
      run: |
        DEVICE_MODEL="${{ github.event.inputs.DEVICE_MODEL }}"
        if [ -z "$DEVICE_MODEL" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæŒ‡å®šè®¾å¤‡å‹å·"
          echo "è¯·åœ¨å·¥ä½œæµè¿è¡Œæ—¶é€‰æ‹©è®¾å¤‡å‹å·"
          exit 1
        fi
        
        echo "DEVICE_MODEL=$DEVICE_MODEL" >> $GITHUB_ENV
        echo "CONFIG_FILE=${DEVICE_MODEL}.config" >> $GITHUB_ENV
        
        case "$DEVICE_MODEL" in
          "rax3000m")
            echo "DEVICE_NAME=cmcc_rax3000m" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=CMCC-RAX3000M" >> $GITHUB_ENV
            ;;
          "ax6000")
            echo "DEVICE_NAME=jdcloud_re-cp-03" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=JDCloud-AX6000" >> $GITHUB_ENV
            ;;
          *)
            echo "âŒ é”™è¯¯ï¼šä¸æ”¯æŒçš„è®¾å¤‡å‹å·: $DEVICE_MODEL"
            exit 1
            ;;
        esac
        
        echo "FILE_DATE=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV
        echo "======================================"
        echo "è®¾å¤‡å‹å·: $DEVICE_MODEL"
        echo "é…ç½®æ–‡ä»¶: ${DEVICE_MODEL}.config"
        echo "======================================"

    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
          git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
          libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
          mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools \
          libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
          vim wget xmlto xxd zlib1g-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        echo "======================================"
        echo "ç¼–è¯‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
        echo "======================================"

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: ä¸‹è½½æºç 
      working-directory: /workdir
      run: |
        df -hT $PWD
        echo "æ­£åœ¨å…‹éš† ImmortalWrt æºç ..."
        echo "ä»“åº“: $REPO_URL"
        echo "ç‰ˆæœ¬: $REPO_VERSION"
        
        echo "======================================"
        echo "æ£€æµ‹ç‰ˆæœ¬ç±»å‹..."
        
        if git ls-remote --tags "$REPO_URL" | grep -q "refs/tags/$REPO_VERSION$"; then
          echo "âœ… æ£€æµ‹åˆ° Tag: $REPO_VERSION"
          echo "æ‰§è¡Œå‘½ä»¤: git clone --depth 1 $REPO_URL -b $REPO_VERSION ImmortalWrt"
          
          if ! git clone --depth 1 "$REPO_URL" -b "$REPO_VERSION" ImmortalWrt; then
            echo "âŒ é”™è¯¯ï¼šæ— æ³•å…‹éš† tag '$REPO_VERSION'"
            echo "è¯·æ£€æŸ¥ tag æ˜¯å¦å­˜åœ¨"
            exit 1
          fi
          
          VERSION_TYPE="Tag"
          
        elif [[ "$REPO_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
          VERSION_WITH_V="v$REPO_VERSION"
          echo "æ£€æµ‹åˆ°ç‰ˆæœ¬å·æ ¼å¼ï¼Œå°è¯•æ·»åŠ  v å‰ç¼€: $VERSION_WITH_V"
          
          if git ls-remote --tags "$REPO_URL" | grep -q "refs/tags/$VERSION_WITH_V$"; then
            echo "âœ… æ£€æµ‹åˆ° Tag: $VERSION_WITH_V"
            echo "æ‰§è¡Œå‘½ä»¤: git clone --depth 1 $REPO_URL -b $VERSION_WITH_V ImmortalWrt"
            
            if ! git clone --depth 1 "$REPO_URL" -b "$VERSION_WITH_V" ImmortalWrt; then
              echo "âŒ é”™è¯¯ï¼šæ— æ³•å…‹éš† tag '$VERSION_WITH_V'"
              echo "è¯·æ£€æŸ¥ tag æ˜¯å¦å­˜åœ¨"
              exit 1
            fi
            
            VERSION_TYPE="Tag"
            REPO_VERSION="$VERSION_WITH_V"
            echo "REPO_VERSION=$REPO_VERSION" >> $GITHUB_ENV
            
          else
            if git ls-remote --heads "$REPO_URL" | grep -q "refs/heads/$REPO_VERSION$"; then
              echo "âœ… æ£€æµ‹åˆ° Branch: $REPO_VERSION"
              echo "æ‰§è¡Œå‘½ä»¤: git clone --depth 1 $REPO_URL -b $REPO_VERSION ImmortalWrt"
              
              if ! git clone --depth 1 "$REPO_URL" -b "$REPO_VERSION" ImmortalWrt; then
                echo "âŒ é”™è¯¯ï¼šæ— æ³•å…‹éš†åˆ†æ”¯ '$REPO_VERSION'"
                echo "è¯·æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨"
                exit 1
              fi
              
              VERSION_TYPE="Branch"
            else
              echo "âŒ é”™è¯¯ï¼š'$REPO_VERSION' å’Œ '$VERSION_WITH_V' éƒ½ä¸æ˜¯æœ‰æ•ˆçš„ tag æˆ– branch"
              echo ""
              echo "å¯ç”¨çš„ Tagsï¼ˆæœ€è¿‘10ä¸ªï¼‰ï¼š"
              git ls-remote --tags "$REPO_URL" | tail -10 | awk '{print "  - " $2}' | sed 's|refs/tags/||'
              echo ""
              echo "å¯ç”¨çš„ Branchesï¼š"
              git ls-remote --heads "$REPO_URL" | awk '{print "  - " $2}' | sed 's|refs/heads/||'
              exit 1
            fi
          fi
          
        elif git ls-remote --heads "$REPO_URL" | grep -q "refs/heads/$REPO_VERSION$"; then
          echo "âœ… æ£€æµ‹åˆ° Branch: $REPO_VERSION"
          echo "æ‰§è¡Œå‘½ä»¤: git clone --depth 1 $REPO_URL -b $REPO_VERSION ImmortalWrt"
          
          if ! git clone --depth 1 "$REPO_URL" -b "$REPO_VERSION" ImmortalWrt; then
            echo "âŒ é”™è¯¯ï¼šæ— æ³•å…‹éš†åˆ†æ”¯ '$REPO_VERSION'"
            echo "è¯·æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨"
            exit 1
          fi
          
          VERSION_TYPE="Branch"
          
        else
          echo "âŒ é”™è¯¯ï¼š'$REPO_VERSION' æ—¢ä¸æ˜¯æœ‰æ•ˆçš„ tag ä¹Ÿä¸æ˜¯æœ‰æ•ˆçš„ branch"
          echo ""
          echo "å¯ç”¨çš„ Tagsï¼ˆæœ€è¿‘10ä¸ªï¼‰ï¼š"
          git ls-remote --tags "$REPO_URL" | tail -10 | awk '{print "  - " $2}' | sed 's|refs/tags/||'
          echo ""
          echo "å¯ç”¨çš„ Branchesï¼š"
          git ls-remote --heads "$REPO_URL" | awk '{print "  - " $2}' | sed 's|refs/heads/||'
          exit 1
        fi
        
        ln -sf /workdir/ImmortalWrt $GITHUB_WORKSPACE/ImmortalWrt
        cd ImmortalWrt
        
        echo "======================================"
        echo "ImmortalWrt æºç ä¿¡æ¯:"
        echo "ç‰ˆæœ¬ç±»å‹: $VERSION_TYPE"
        echo "ç‰ˆæœ¬åç§°: $REPO_VERSION"
        echo "å½“å‰HEAD: $(git rev-parse --short HEAD)"
        echo "æœ€æ–°æäº¤: $(git log --oneline -1)"
        
        if [ -f "include/version.mk" ]; then
          VERSION_NUMBER=$(grep 'VERSION_NUMBER' include/version.mk | cut -d'=' -f2 | tr -d ' ' || echo "æœªæ‰¾åˆ°")
          echo "ç‰ˆæœ¬å·: $VERSION_NUMBER"
        fi
        
        if [ -f "Makefile" ]; then
          VERSION=$(grep '^VERSION' Makefile | head -1 | cut -d'=' -f2 | tr -d ' ' || echo "æœªæ‰¾åˆ°")
          PATCHLEVEL=$(grep '^PATCHLEVEL' Makefile | head -1 | cut -d'=' -f2 | tr -d ' ' || echo "æœªæ‰¾åˆ°")
          SUBLEVEL=$(grep '^SUBLEVEL' Makefile | head -1 | cut -d'=' -f2 | tr -d ' ' || echo "æœªæ‰¾åˆ°")
          if [ "$VERSION" != "æœªæ‰¾åˆ°" ]; then
            echo "ImmortalWrt ç‰ˆæœ¬: $VERSION.$PATCHLEVEL.$SUBLEVEL"
          fi
        fi
        
        echo "å…‹éš†çŠ¶æ€: âœ… æˆåŠŸ"
        echo "======================================"

    - name: åŠ è½½é…ç½®æ–‡ä»¶å¹¶è·å– TARGET
      run: |
        echo "======================================"
        echo "ğŸ“‹ åŠ è½½é…ç½®æ–‡ä»¶å¹¶æå– TARGET ä¿¡æ¯"
        echo "======================================"
        
        if [ ! -f "${{ env.CONFIG_FILE }}" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ ${{ env.CONFIG_FILE }}"
          exit 1
        fi
        
        # ä»é…ç½®æ–‡ä»¶æå– TARGET ä¿¡æ¯
        # æ ¼å¼: CONFIG_TARGET_mediatek_filogic_DEVICE_xxx=y
        TARGET_LINE=$(grep "^CONFIG_TARGET_.*_DEVICE_.*=y" "${{ env.CONFIG_FILE }}" | head -1)
        echo "é…ç½®è¡Œ: $TARGET_LINE"
        
        if [ -n "$TARGET_LINE" ]; then
          # æå– mediatek_filogic éƒ¨åˆ†
          # æ–¹æ³•1ï¼šä½¿ç”¨ awkï¼ˆæ›´å¯é ï¼‰
          TARGET_NAME=$(echo "$TARGET_LINE" | awk -F'_' '{print $3"_"$4}')
          echo "æå–çš„ TARGET: $TARGET_NAME"
          
          # è½¬æ¢ä¸ºè·¯å¾„æ ¼å¼ mediatek_filogic -> mediatek/filogic
          TARGET_PATH=$(echo "$TARGET_NAME" | tr '_' '/')
          echo "TARGET_PATH: $TARGET_PATH"
          
          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "TARGET_NAME=$TARGET_NAME" >> $GITHUB_ENV
          echo "TARGET_PATH=$TARGET_PATH" >> $GITHUB_ENV
        else
          echo "âš ï¸ æ— æ³•ä»é…ç½®æ–‡ä»¶æå– TARGETï¼Œä½¿ç”¨é»˜è®¤å€¼"
          echo "TARGET_NAME=mediatek_filogic" >> $GITHUB_ENV
          echo "TARGET_PATH=mediatek/filogic" >> $GITHUB_ENV
        fi
        
        echo "======================================"
        
    - name: è·å–å®˜æ–¹ kmods ç›®å½•å’Œ vermagic å€¼
      if: ${{ github.event.inputs.FIX_VERMAGIC == 'true' }}
      run: |
        echo "======================================"
        echo "ğŸ” åŠ¨æ€è·å–å®˜æ–¹ kmods ç›®å½•å’Œ vermagic"
        echo "======================================"
        
        cd ImmortalWrt
        
        VERSION="${{ env.REPO_VERSION }}"
        TARGET_PATH="${{ env.TARGET_PATH }}"
        
        # ç§»é™¤ç‰ˆæœ¬å·ä¸­çš„ 'v' å‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        CLEAN_VERSION=$(echo "$VERSION" | sed 's/^v//')
        echo "ImmortalWrt ç‰ˆæœ¬: $CLEAN_VERSION"
        echo "ç›®æ ‡è·¯å¾„: $TARGET_PATH"
        
        # æ„å»º kmods ç›®å½• URL
        KMODS_BASE_URL="https://downloads.immortalwrt.org/releases/$CLEAN_VERSION/targets/$TARGET_PATH/kmods/"
        echo "kmods ç›®å½• URL: $KMODS_BASE_URL"
        
        # è·å– kmods ç›®å½•å
        echo "æ­£åœ¨è·å– kmods ç›®å½•åˆ—è¡¨..."
        KERNEL_DIR=$(wget -qO- "$KMODS_BASE_URL" | grep -oP '(?<=href=")[0-9.]+-[0-9]+-[0-9a-f]+(?=/)' | head -1)
        
        if [ -z "$KERNEL_DIR" ]; then
          echo "å°è¯•å¤‡ç”¨æ–¹æ³•ï¼ˆcurlï¼‰..."
          KERNEL_DIR=$(curl -sL "$KMODS_BASE_URL" | grep -oP '(?<=href=")[0-9.]+-[0-9]+-[0-9a-f]+(?=/)' | head -1)
        fi
        
        if [ -n "$KERNEL_DIR" ]; then
          echo "âœ… è·å–åˆ° kmods ç›®å½•å: $KERNEL_DIR"
          
          # æå– vermagicï¼ˆ32ä½å“ˆå¸Œå€¼ï¼‰
          OFFICIAL_VERMAGIC=$(echo "$KERNEL_DIR" | grep -oE '[0-9a-f]{32}')
          echo "è§£æå‡ºçš„å®˜æ–¹ vermagic: $OFFICIAL_VERMAGIC"
          
          # ä¿å­˜åŸå§‹çš„ kernel ç›®å½•åç”¨äºå¯¹æ¯”
          echo "å®˜æ–¹ kernel ç‰ˆæœ¬æ ‡è¯†: $KERNEL_DIR"
          
          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "KERNEL_DIR=$KERNEL_DIR" >> $GITHUB_ENV
          echo "OFFICIAL_VERMAGIC=$OFFICIAL_VERMAGIC" >> $GITHUB_ENV
          
          if [ -n "$OFFICIAL_VERMAGIC" ]; then
            # åœ¨æºç æ ¹ç›®å½•åˆ›å»º .vermagic æ–‡ä»¶
            echo "$OFFICIAL_VERMAGIC" > .vermagic
            echo "âœ… å®˜æ–¹ vermagic å€¼å·²å†™å…¥ .vermagic æ–‡ä»¶"
            echo "æ–‡ä»¶å†…å®¹: $(cat .vermagic)"
            echo "VERMAGIC_STATUS=âœ… å·²è·å–" >> $GITHUB_ENV
          else
            echo "âŒ æ— æ³•è§£æ vermagic å€¼"
            echo "VERMAGIC_STATUS=âŒ è§£æå¤±è´¥" >> $GITHUB_ENV
          fi
        else
          echo "âŒ æ— æ³•è·å– kmods ç›®å½•å"
          echo "VERMAGIC_STATUS=âŒ è·å–å¤±è´¥" >> $GITHUB_ENV
          exit 1
        fi
        
        echo "======================================"
    
    - name: ä¿®æ”¹å†…æ ¸ç¼–è¯‘è„šæœ¬ä»¥ä½¿ç”¨å›ºå®š vermagic
      if: ${{ github.event.inputs.FIX_VERMAGIC == 'true' && env.VERMAGIC_STATUS == 'âœ… å·²è·å–' }}
      run: |
        echo "======================================"
        echo "ğŸ”§ ä¿®æ”¹å†…æ ¸ç¼–è¯‘è„šæœ¬"
        echo "======================================"
        
        cd ImmortalWrt
        
        if [ ! -f ".vermagic" ]; then
          echo "âŒ é”™è¯¯ï¼š.vermagic æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "å½“å‰ç›®å½•çš„ .vermagic å†…å®¹: $(cat .vermagic)"
        
        KERNEL_DEFAULTS_FILE="include/kernel-defaults.mk"
        echo "æŸ¥æ‰¾æ–‡ä»¶: $KERNEL_DEFAULTS_FILE"
        
        if [ ! -f "$KERNEL_DEFAULTS_FILE" ]; then
          echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶ $KERNEL_DEFAULTS_FILE ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "âœ… æ–‡ä»¶å­˜åœ¨ï¼Œå¼€å§‹ä¿®æ”¹..."
        
        cp "$KERNEL_DEFAULTS_FILE" "${KERNEL_DEFAULTS_FILE}.backup"
        echo "å·²å¤‡ä»½æ–‡ä»¶"
        
        echo "æ­£åœ¨æŸ¥æ‰¾ vermagic ç”Ÿæˆè¡Œ..."
        
        TARGET_LINE_NUM=""
        
        # æŸ¥æ‰¾åŒ…å« > $(LINUX_DIR)/.vermagic çš„è¡Œ
        TARGET_LINE_NUM=$(grep -n "> \$(LINUX_DIR)/\.vermagic" "$KERNEL_DEFAULTS_FILE" 2>/dev/null | head -1 | cut -d: -f1)
        
        if [ -z "$TARGET_LINE_NUM" ]; then
          # å¤‡ç”¨æœç´¢ï¼šåªæœç´¢ .vermagic
          TARGET_LINE_NUM=$(grep -n "\.vermagic" "$KERNEL_DEFAULTS_FILE" | grep -v "^#" | head -1 | cut -d: -f1)
        fi
        
        if [ -n "$TARGET_LINE_NUM" ]; then
          echo "æ‰¾åˆ°ç›®æ ‡è¡Œå·: $TARGET_LINE_NUM"
          
          ORIGINAL_LINE=$(sed -n "${TARGET_LINE_NUM}p" "$KERNEL_DEFAULTS_FILE")
          echo "åŸå§‹å†…å®¹: $ORIGINAL_LINE"
          
          echo "å¼€å§‹æ›¿æ¢ç¬¬ $TARGET_LINE_NUM è¡Œ..."
          
          # ä½¿ç”¨ awk æ›¿æ¢æŒ‡å®šè¡Œï¼ˆæœ€å¯é çš„æ–¹æ³•ï¼‰
          awk -v n="$TARGET_LINE_NUM" 'NR==n {print "\tcp $(TOPDIR)/.vermagic $(LINUX_DIR)/.vermagic"; next} 1' "$KERNEL_DEFAULTS_FILE" > "${KERNEL_DEFAULTS_FILE}.tmp"
          
          if [ -f "${KERNEL_DEFAULTS_FILE}.tmp" ]; then
            mv "${KERNEL_DEFAULTS_FILE}.tmp" "$KERNEL_DEFAULTS_FILE"
            echo "âœ… æ›¿æ¢å®Œæˆ"
          else
            echo "âŒ æ›¿æ¢å¤±è´¥"
            cp "${KERNEL_DEFAULTS_FILE}.backup" "$KERNEL_DEFAULTS_FILE"
            exit 1
          fi
        else
          echo "âŒ æ— æ³•æ‰¾åˆ°ç›®æ ‡è¡Œ"
          echo "æ˜¾ç¤ºæ‰€æœ‰åŒ…å« .vermagic çš„è¡Œ:"
          grep -n "\.vermagic" "$KERNEL_DEFAULTS_FILE"
          exit 1
        fi
        
        echo "======================================"
        echo "éªŒè¯ä¿®æ”¹ç»“æœ..."
        
        if grep -q "cp \$(TOPDIR)/.vermagic \$(LINUX_DIR)/.vermagic" "$KERNEL_DEFAULTS_FILE"; then
          echo "âœ… ä¿®æ”¹æˆåŠŸï¼"
          echo "ä¿®æ”¹åçš„è¡Œ:"
          grep -n "cp \$(TOPDIR)/.vermagic" "$KERNEL_DEFAULTS_FILE"
          echo "======================================"
          echo "âœ… å†…æ ¸ç¼–è¯‘è„šæœ¬ä¿®æ”¹æˆåŠŸ"
          echo "======================================"
        else
          echo "âŒ ä¿®æ”¹å¤±è´¥"
          cp "${KERNEL_DEFAULTS_FILE}.backup" "$KERNEL_DEFAULTS_FILE"
          echo "======================================"
          echo "âŒ å†…æ ¸ç¼–è¯‘è„šæœ¬ä¿®æ”¹å¤±è´¥"
          echo "======================================"
          exit 1
        fi

    - name: åˆ›å»º kmods è½¯ä»¶æºé…ç½®å’Œè‡ªåŠ¨å®‰è£…è„šæœ¬
      if: ${{ github.event.inputs.FIX_VERMAGIC == 'true' && env.VERMAGIC_STATUS == 'âœ… å·²è·å–' }}
      run: |
        echo "======================================"
        echo "ğŸ”§ åˆ›å»º kmods è½¯ä»¶æºé…ç½®å’Œè‡ªåŠ¨å®‰è£…è„šæœ¬"
        echo "======================================"
        
        cd ImmortalWrt
        
        # è·å–ç‰ˆæœ¬å·å’Œç›®å½•ä¿¡æ¯
        VERSION="${{ env.REPO_VERSION }}"
        CLEAN_VERSION=$(echo "$VERSION" | sed 's/^v//')
        TARGET_PATH="${{ env.TARGET_PATH }}"
        KERNEL_DIR="${{ env.KERNEL_DIR }}"
        
        echo "ImmortalWrt ç‰ˆæœ¬: $CLEAN_VERSION"
        echo "ç›®æ ‡è·¯å¾„: $TARGET_PATH"
        echo "Kernel ç›®å½•: $KERNEL_DIR"
        
        # æ„å»º kmods URL
        KMODS_URL="src/gz immortalwrt_kmods https://mirrors.vsean.net/openwrt/releases/$CLEAN_VERSION/targets/$TARGET_PATH/kmods/$KERNEL_DIR"
        echo ""
        echo "kmods URL:"
        echo "$KMODS_URL"
        echo ""
        
        # ä½¿ç”¨ auto-setup-kmods.sh åˆ›å»º uci-defaults è„šæœ¬
        if [ -f "$GITHUB_WORKSPACE/auto-setup-kmods.sh" ]; then
            # æ‰§è¡Œè„šæœ¬ç”Ÿæˆå†…å®¹
            bash "$GITHUB_WORKSPACE/auto-setup-kmods.sh" > temp-auto-setup.sh
            
            # åˆ›å»º uci-defaults ç›®å½•
            mkdir -p files/etc/uci-defaults
            
            # å¤åˆ¶å¹¶ä¿®æ”¹è„šæœ¬
            cp temp-auto-setup.sh files/etc/uci-defaults/99-auto-setup
            
            # æ›¿æ¢ kmods URL
            sed -i "s|KMODS_URL_PLACEHOLDER|$KMODS_URL|g" files/etc/uci-defaults/99-auto-setup
            
            chmod +x files/etc/uci-defaults/99-auto-setup
            
            echo "âœ… åˆ›å»ºäº† uci-defaults è‡ªåŠ¨é…ç½®è„šæœ¬"
            echo "è„šæœ¬è·¯å¾„: files/etc/uci-defaults/99-auto-setup"
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f temp-auto-setup.sh
        else
            echo "âš ï¸ auto-setup-kmods.sh ä¸å­˜åœ¨ï¼Œåˆ›å»ºåŸºç¡€ç‰ˆæœ¬"
            
            # åˆ›å»ºåŸºç¡€çš„ uci-defaults è„šæœ¬
            mkdir -p files/etc/uci-defaults
            cat > files/etc/uci-defaults/99-auto-setup <<'EOFD'
        #!/bin/sh
        
        # ç®€å•ç‰ˆæœ¬ï¼šåªæ·»åŠ  kmods æº
        KMODS_URL="$KMODS_URL"
        
        # æ·»åŠ  kmods æº
        if [ -f /etc/opkg/distfeeds.conf ]; then
            if ! grep -q "immortalwrt_kmods" /etc/opkg/distfeeds.conf; then
                sed -i "2a\\$KMODS_URL" /etc/opkg/distfeeds.conf
                echo "kmods feed added" > /tmp/kmods-added.log
            fi
        fi
        
        exit 0
        EOFD
            
            # æ›¿æ¢å˜é‡
            sed -i "s|\$KMODS_URL|$KMODS_URL|g" files/etc/uci-defaults/99-auto-setup
            chmod +x files/etc/uci-defaults/99-auto-setup
        fi
        
        echo "======================================"
        
    - name: åŠ è½½è‡ªå®šä¹‰feedså’Œæ‰§è¡Œè„šæœ¬Part1
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF ImmortalWrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd ImmortalWrt
        echo "======================================"
        echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ Part1..."
        echo "======================================"
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: æ›´æ–°å¹¶å®‰è£…feeds
      run: |
        cd ImmortalWrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "Feeds æ›´æ–°å®‰è£…å®Œæˆ"

    - name: åŠ è½½è®¾å¤‡é…ç½®å’Œæ‰§è¡Œè„šæœ¬Part2
      run: |
        # é…ç½®æ–‡ä»¶å·²åœ¨å‰é¢åŠ è½½ï¼Œè¿™é‡Œç›´æ¥å¤åˆ¶
        echo "ä½¿ç”¨é…ç½®æ–‡ä»¶: ${{ env.CONFIG_FILE }}"
        cp ${{ env.CONFIG_FILE }} ImmortalWrt/.config
        
        chmod +x $DIY_P2_SH
        cd ImmortalWrt
        echo "======================================"
        echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ Part2..."
        echo "======================================"
        $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: è®¾ç½®LAN IPåœ°å€
      run: |
        cd ImmortalWrt
        SET_IP="${{ github.event.inputs.LAN_IP }}"
        
        if [ -z "$SET_IP" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæŒ‡å®šLAN IPåœ°å€"
          echo "è¯·åœ¨å·¥ä½œæµè¿è¡Œæ—¶è®¾ç½®LAN IPåœ°å€"
          exit 1
        fi
        
        if ! [[ $SET_IP =~ ^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$ ]]; then
            echo "âŒ é”™è¯¯ï¼šIPåœ°å€æ ¼å¼æ— æ•ˆ: $SET_IP"
            echo "è¯·è¾“å…¥æœ‰æ•ˆçš„IPv4åœ°å€ï¼Œå¦‚: 192.168.1.1"
            exit 1
        fi
        
        sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" package/base-files/files/bin/config_generate
        
        if [ -d "feeds/luci/modules/luci-mod-system" ]; then
          find feeds/luci/modules/luci-mod-system -type f -name "flash.js" -exec sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" {} + 2>/dev/null || true
        fi
        
        echo "IP_ADDR=$SET_IP" >> $GITHUB_ENV
        echo "======================================"
        echo "LAN IP åœ°å€è®¾ç½®ä¸º: $SET_IP"
        echo "======================================"

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      id: package
      run: |
        cd ImmortalWrt
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        echo "======================================"
        echo "è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"
        echo "======================================"

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd ImmortalWrt
        echo -e "$(nproc) çº¿ç¨‹ç¼–è¯‘"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        echo "======================================"
        echo "å›ºä»¶ç¼–è¯‘å®Œæˆ"
        echo "======================================"

    - name: æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
      if: (!cancelled())
      run: df -hT

    - name: ä¸Šä¼ binç›®å½•
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && github.event.inputs.UPLOAD_BIN_DIR == 'true'
      with:
        name: ImmortalWrt_bin_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}
        path: ImmortalWrt/bin

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: github.event.inputs.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd ImmortalWrt/bin/targets/*/*
        rm -rf packages
        for file in *; do
          if [[ -f "$file" ]]; then
            new_name="${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-${file#*${{ env.DEVICE_NAME }}-}"
            mv "$file" "$new_name" 2>/dev/null || mv "$file" "${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-$file"
          fi
        done
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        echo "======================================"
        echo "å›ºä»¶æ•´ç†å®Œæˆï¼Œæ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -lh
        echo "======================================"

    - name: éªŒè¯ vermagic ä¿®æ”¹æ•ˆæœ
      if: ${{ github.event.inputs.FIX_VERMAGIC == 'true' }}
      run: |
        echo "======================================"
        echo "ğŸ” éªŒè¯ vermagic ä¿®æ”¹æ•ˆæœ"
        echo "======================================"
        
        cd ImmortalWrt
        
        # è·å–æœ¬åœ°ç¼–è¯‘çš„å›ºä»¶ vermagic
        LOCAL_MANIFEST=$(find bin -name "*.manifest" 2>/dev/null | head -1)
        if [ -n "$LOCAL_MANIFEST" ]; then
          LOCAL_KERNEL_LINE=$(grep '^kernel ' "$LOCAL_MANIFEST" | head -1)
          echo "æœ¬åœ° kernel å®Œæ•´è¡Œ: $LOCAL_KERNEL_LINE"
          
          # æå–ç‰ˆæœ¬éƒ¨åˆ†ï¼ˆç¬¬3ä¸ªå­—æ®µï¼‰
          LOCAL_VERMAGICA=$(echo "$LOCAL_KERNEL_LINE" | awk '{print $3}')
          echo "æœ¬åœ°ç¼–è¯‘ kernel ç‰ˆæœ¬: ${LOCAL_VERMAGICA:-è·å–å¤±è´¥}"
          echo "LOCAL_VERMAGICA=$LOCAL_VERMAGICA" >> $GITHUB_ENV
          
          # æå– vermagic å“ˆå¸Œå€¼
          LOCAL_VERMAGIC=$(echo "$LOCAL_VERMAGICA" | grep -oE '[0-9a-f]{32}')
          echo "æå–åˆ°çš„ vermagic: ${LOCAL_VERMAGIC:-è·å–å¤±è´¥}"
          echo "LOCAL_VERMAGIC=$LOCAL_VERMAGIC" >> $GITHUB_ENV
        else
          echo "æœ¬åœ°ç¼–è¯‘ vermagic: è·å–å¤±è´¥"
          echo "LOCAL_VERMAGICA=è·å–å¤±è´¥" >> $GITHUB_ENV
          echo "LOCAL_VERMAGIC=è·å–å¤±è´¥" >> $GITHUB_ENV
        fi
        
        # vermagic å¯¹æ¯”
        echo "======================================"
        KERNEL_DIR="${{ env.KERNEL_DIR }}"
        OFFICIAL_VERMAGIC="${{ env.OFFICIAL_VERMAGIC }}"
        
        echo "å®˜æ–¹ kernel ç›®å½•: ${KERNEL_DIR:-æœªè·å–}"
        echo "å®˜æ–¹ vermagic: ${OFFICIAL_VERMAGIC:-æœªè·å–}"
        echo "æœ¬åœ° kernel ç‰ˆæœ¬: ${LOCAL_VERMAGICA:-æœªè·å–}"
        echo "æœ¬åœ° vermagic: ${LOCAL_VERMAGIC:-æœªè·å–}"
        
        # ç®€åŒ–å¯¹æ¯”ï¼šæ£€æŸ¥æœ¬åœ°ç‰ˆæœ¬æ˜¯å¦åŒ…å«å®˜æ–¹çš„å†…æ ¸ç‰ˆæœ¬æ ‡è¯†
        if [ -n "$KERNEL_DIR" ] && [ -n "$LOCAL_VERMAGICA" ] && [ "$LOCAL_VERMAGICA" != "è·å–å¤±è´¥" ]; then
          # å»æ‰å¯èƒ½çš„åç¼€ï¼ˆå¦‚ -r1ï¼‰è¿›è¡Œå¯¹æ¯”
          LOCAL_VERSION_CLEAN=$(echo "$LOCAL_VERMAGICA" | sed 's/-r[0-9]*$//')
          
          # æ£€æŸ¥æ˜¯å¦åŒ…å«ç›¸åŒçš„å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
          if echo "$LOCAL_VERSION_CLEAN" | grep -q "$OFFICIAL_VERMAGIC"; then
            echo "âœ… vermagic å¯¹æ¯”ç»“æœ: ä¸€è‡´"
            echo "å›ºä»¶å·²å…¼å®¹å®˜æ–¹è½¯ä»¶æº"
            echo "VERMAGIC_COMPARE=âœ… ä¸€è‡´" >> $GITHUB_ENV
          else
            echo "âŒ vermagic å¯¹æ¯”ç»“æœ: ä¸ä¸€è‡´"
            echo "å®˜æ–¹åŒ…å«: $OFFICIAL_VERMAGIC"
            echo "æœ¬åœ°åŒ…å«: $LOCAL_VERMAGIC"
            echo "VERMAGIC_COMPARE=âŒ ä¸ä¸€è‡´" >> $GITHUB_ENV
          fi
        else
          echo "âš ï¸ vermagic å¯¹æ¯”ç»“æœ: æ— æ³•å¯¹æ¯”ï¼ˆæ•°æ®ä¸å®Œæ•´ï¼‰"
          echo "VERMAGIC_COMPARE=âš ï¸ æ— æ³•å¯¹æ¯”" >> $GITHUB_ENV
        fi
        echo "======================================"

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifacts
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && github.event.inputs.UPLOAD_FIRMWARE == 'true'
      with:
        name: ${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-Firmware
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: github.event.inputs.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        echo "release_tag=${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT
        
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜
        cat > release.txt <<EOF
        # ${{ env.DEVICE_FULL_NAME }} å›ºä»¶
        
        ## ğŸ“‹ å›ºä»¶ä¿¡æ¯
        
        - **è®¾å¤‡å‹å·**: ${{ env.DEVICE_FULL_NAME }}
        - **ç›®æ ‡å¹³å°**: ${{ env.TARGET_PATH }}
        - **ç¼–è¯‘æ—¶é—´**: ${{ env.FILE_DATE }}
        - **ç™»å½•åœ°å€**: ${{ env.IP_ADDR }}
        - **é»˜è®¤å¯†ç **: æ— å¯†ç æˆ– password
        
        ## ğŸ“¦ æºç ä¿¡æ¯
        
        - **æºç ä»“åº“**: ${{ env.REPO_URL }}
        - **æºç ç‰ˆæœ¬**: ${{ env.REPO_VERSION }}
        
        ## ğŸ”§ vermagic ä¿¡æ¯
        
        - **å®˜æ–¹ vermagic**: ${{ env.KERNEL_DIR }}
        - **æœ¬åœ° vermagic**: ${{ env.LOCAL_VERMAGICA }}
        - **å¯¹æ¯”ç»“æœ**: ${{ env.VERMAGIC_COMPARE }}
        - **è½¯ä»¶æºå…¼å®¹**: ${{ env.VERMAGIC_COMPARE == 'âœ… ä¸€è‡´' && 'âœ… å…¼å®¹å®˜æ–¹è½¯ä»¶æº' || 'âŒ ä¸å…¼å®¹å®˜æ–¹è½¯ä»¶æº' }}
        
        ---
        
        ## â„¹ï¸ æ³¨æ„äº‹é¡¹
        
        ${{ env.VERMAGIC_COMPARE == 'âœ… ä¸€è‡´' && 'âœ… æ­¤å›ºä»¶å¯ä»¥ä½¿ç”¨ ImmortalWrt å®˜æ–¹è½¯ä»¶æºå®‰è£…é¢å¤–è½¯ä»¶åŒ…' || 'âš ï¸ æ­¤å›ºä»¶å¯èƒ½æ— æ³•ç›´æ¥ä½¿ç”¨å®˜æ–¹è½¯ä»¶æºï¼Œè¯·è°¨æ…å®‰è£…å†…æ ¸ç›¸å…³è½¯ä»¶åŒ…' }}
        EOF

    - name: å‘å¸ƒå›ºä»¶åˆ°Release
      uses: softprops/action-gh-release@v2.1.0
      if: steps.tag.outputs.status == 'success' && github.event.inputs.UPLOAD_RELEASE == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.FIRMWARE }}/*
        name: ${{ env.DEVICE_FULL_NAME }} - ${{ env.FILE_DATE }}
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        draft: false
        prerelease: false

    - name: åˆ é™¤æ—§çš„workflowè¿è¡Œè®°å½•
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 7
        keep_minimum_runs: 10

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@v0.3.2
      if: github.event.inputs.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 10
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
