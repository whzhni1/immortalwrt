name: èŽ·å–configé…ç½®æ–‡ä»¶

on:
  workflow_dispatch:
    inputs:
      REPO_VERSION:
        description: 'è¾“å…¥ ImmortalWrt ç‰ˆæœ¬ï¼ˆå¦‚ v24.10.2ï¼‰'
        required: false
        default: 'v24.10.2'
        type: string
      CONFIG_NAME:
        description: 'é…ç½®æ–‡ä»¶åï¼ˆä¸å«.configåŽç¼€ï¼‰'
        required: true
        default: 'my-config'
        type: string
      LOAD_CUSTOM_FEEDS:
        description: 'åŠ è½½è‡ªå®šä¹‰æ’ä»¶åº“ï¼ˆæ‰§è¡Œpart1.shï¼‰'
        required: false
        default: false
        type: boolean
      DEVICE_PROFILE:
        description: 'è®¾å¤‡åž‹å·ï¼ˆå¦‚ï¼šcmcc_rax3000m ï¼‰ï¼Œç•™ç©ºåˆ™è¿›å…¥ menuconfig æ‰‹åŠ¨é€‰æ‹©'
        required: false
        default: ''
        type: string

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  TZ: Asia/Shanghai

# æ·»åŠ æƒé™å£°æ˜Ž
permissions:
  contents: write
  discussions: write

jobs:
  pure-menuconfig:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
    - name: æ£€æŸ¥é¡¹ç›®åˆ†æ”¯
      uses: actions/checkout@main

    - name: è®¾ç½®å˜é‡
      run: |
        REPO_VERSION="${{ github.event.inputs.REPO_VERSION }}"
        if [ -z "$REPO_VERSION" ]; then
          REPO_VERSION="v24.10"
        fi
        REPO_TAG="$REPO_VERSION"
        
        CONFIG_NAME="${{ github.event.inputs.CONFIG_NAME }}"
        LOAD_CUSTOM_FEEDS="${{ github.event.inputs.LOAD_CUSTOM_FEEDS }}"
        DEVICE_PROFILE="${{ github.event.inputs.DEVICE_PROFILE }}"
        
        echo "REPO_TAG=$REPO_TAG" >> $GITHUB_ENV
        echo "CONFIG_NAME=$CONFIG_NAME" >> $GITHUB_ENV
        echo "LOAD_CUSTOM_FEEDS=$LOAD_CUSTOM_FEEDS" >> $GITHUB_ENV
        echo "DEVICE_PROFILE=$DEVICE_PROFILE" >> $GITHUB_ENV
        echo "RELEASE_TIME=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
        echo "RELEASE_TAG=config-${CONFIG_NAME}-$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV
        
        echo "ä½¿ç”¨ç‰ˆæœ¬æ ‡ç­¾: $REPO_TAG"
        echo "é…ç½®æ–‡ä»¶å: $CONFIG_NAME.config"
        echo "åŠ è½½è‡ªå®šä¹‰æ’ä»¶åº“: $LOAD_CUSTOM_FEEDS"
        echo "è®¾å¤‡åž‹å·: $DEVICE_PROFILE"

    - name: åˆå§‹åŒ–ç¼–è¯‘çŽ¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses5-dev \
          git \
          python3 \
          rsync
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: ä¸‹è½½æºç  (ä½¿ç”¨ Tag)
      working-directory: /workdir
      run: |
        echo "æ­£åœ¨å…‹éš† ImmortalWrt æºç ..."
        echo "ç‰ˆæœ¬æ ‡ç­¾: $REPO_TAG"
        echo "ç›®æ ‡åœ°å€: $REPO_URL/tree/$REPO_TAG"
        
        # å…ˆå…‹éš†ä»“åº“ï¼ˆæµ…å…‹éš†ï¼‰
        git clone --depth 1 --branch "$REPO_TAG" "$REPO_URL" ImmortalWrt 2>/dev/null || {
          echo "âŒ æ— æ³•ç›´æŽ¥å…‹éš†æ ‡ç­¾ $REPO_TAGï¼Œå°è¯•å®Œæ•´å…‹éš†..."
          git clone "$REPO_URL" ImmortalWrt
          cd ImmortalWrt
          
          # åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„ tags
          echo "å¯ç”¨çš„ç‰ˆæœ¬æ ‡ç­¾ï¼š"
          git tag -l "v*" | tail -20
          
          # å°è¯•åˆ‡æ¢åˆ°æŒ‡å®šçš„ tag
          if git checkout "tags/$REPO_TAG" 2>/dev/null; then
            echo "âœ… æˆåŠŸåˆ‡æ¢åˆ°æ ‡ç­¾: $REPO_TAG"
          else
            echo "âŒ æ ‡ç­¾ $REPO_TAG ä¸å­˜åœ¨"
            echo "ä½¿ç”¨æœ€æ–°çš„æ ‡ç­¾..."
            LATEST_TAG=$(git describe --tags --abbrev=0)
            git checkout "tags/$LATEST_TAG"
            echo "ä½¿ç”¨æ ‡ç­¾: $LATEST_TAG"
            echo "REPO_TAG=$LATEST_TAG" >> $GITHUB_ENV
          fi
          cd ..
        }
        
        # éªŒè¯ç‰ˆæœ¬
        cd ImmortalWrt
        echo "å½“å‰ç‰ˆæœ¬ä¿¡æ¯ï¼š"
        git describe --tags --always
        cd ..
        
        ln -sf /workdir/ImmortalWrt $GITHUB_WORKSPACE/ImmortalWrt
        echo "æºç å‡†å¤‡å®Œæˆ"

    - name: åŠ è½½è‡ªå®šä¹‰æ’ä»¶åº“ï¼ˆå¦‚æžœå¯ç”¨ï¼‰
      if: env.LOAD_CUSTOM_FEEDS == 'true'
      run: |
        echo "æ­£åœ¨åŠ è½½è‡ªå®šä¹‰æ’ä»¶åº“..."
        cd ImmortalWrt
        if [ -f "$GITHUB_WORKSPACE/part1.sh" ]; then
          chmod +x "$GITHUB_WORKSPACE/part1.sh"
          "$GITHUB_WORKSPACE/part1.sh"
          echo "è‡ªå®šä¹‰æ’ä»¶åº“åŠ è½½å®Œæˆ"
        else
          echo "æœªæ‰¾åˆ° part1.shï¼Œè·³è¿‡"
        fi

    - name: æ›´æ–°å¹¶å®‰è£…feeds
      run: |
        cd ImmortalWrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: åˆå§‹åŒ–é…ç½®çŽ¯å¢ƒ
      run: |
        cd ImmortalWrt
        rm -f .config .config.old
        echo "çŽ¯å¢ƒå‡†å¤‡å®Œæˆ"

    - name: ç”Ÿæˆé…ç½®æ–‡ä»¶
      run: |
        cd ImmortalWrt
        rm -f .config
        
        if [ -z "$DEVICE_PROFILE" ]; then
          echo "æœªæŒ‡å®šè®¾å¤‡åž‹å·ï¼Œä½¿ç”¨é»˜è®¤æœ€å°é…ç½®..."
          echo "CONFIG_TARGET_mediatek=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
          echo "# ç”¨æˆ·åŽç»­å¯æ‰‹åŠ¨ä¿®æ”¹" >> .config
          make defconfig
        else
          echo "ä½¿ç”¨è®¾å¤‡åž‹å·: $DEVICE_PROFILE"
          echo "CONFIG_TARGET_mediatek=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_${DEVICE_PROFILE}=y" >> .config
          make defconfig
        fi

    - name: å‡†å¤‡ä¸Šä¼ æ–‡ä»¶
      id: prepare
      run: |
        cd ImmortalWrt
        if [ ! -f .config ]; then
          echo "âŒ æœªç”Ÿæˆé…ç½®æ–‡ä»¶"
          exit 1
        fi
        
        # åˆ›å»ºä¸Šä¼ ç›®å½•
        mkdir -p $GITHUB_WORKSPACE/upload
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp .config "$GITHUB_WORKSPACE/upload/$CONFIG_NAME.config"
        
        # éªŒè¯æ–‡ä»¶
        echo "éªŒè¯ä¸Šä¼ æ–‡ä»¶ï¼š"
        ls -la "$GITHUB_WORKSPACE/upload/"
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "status=success" >> $GITHUB_OUTPUT
        echo "âœ… é…ç½®æ–‡ä»¶å·²å‡†å¤‡: $CONFIG_NAME.config"

    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
      run: |
        cat > $GITHUB_WORKSPACE/release.md << END
        ## ðŸ“‹ é…ç½®æ–‡ä»¶ä¿¡æ¯
        
        | é¡¹ç›® | å†…å®¹ |
        |------|------|
        | **ç”Ÿæˆæ—¶é—´** | $RELEASE_TIME |
        | **æºç ç‰ˆæœ¬** | $REPO_TAG |
        | **è‡ªå®šä¹‰æ’ä»¶åº“** | $LOAD_CUSTOM_FEEDS |
        | **é…ç½®æ–‡ä»¶** | $CONFIG_NAME.config |
        | **è®¾å¤‡åž‹å·** | ${DEVICE_PROFILE:-æœªæŒ‡å®š} |
        
        ## ðŸ“¥ ä¸‹è½½æ–‡ä»¶
        
        ç‚¹å‡»ä¸‹æ–¹çš„ **$CONFIG_NAME.config** æ–‡ä»¶ä¸‹è½½é…ç½®
        
        ## ðŸ“– ä½¿ç”¨è¯´æ˜Ž
        
        1. ä¸‹è½½é…ç½®æ–‡ä»¶ \`$CONFIG_NAME.config\`
        2. é‡å‘½åä¸ºå¯¹åº”è®¾å¤‡çš„é…ç½®æ–‡ä»¶åï¼š
           - RAX3000M: é‡å‘½åä¸º \`rax3000m.config\`
           - AX6000: é‡å‘½åä¸º \`ax6000.config\`
        3. å°†é…ç½®æ–‡ä»¶æ”¾åœ¨ç¼–è¯‘ä»“åº“çš„æ ¹ç›®å½•
        4. è§¦å‘ç¼–è¯‘å·¥ä½œæµä½¿ç”¨æ­¤é…ç½®
        
        ## ðŸ”— æºç åœ°å€
        
        æœ¬é…ç½®åŸºäºŽ: [$REPO_URL/tree/$REPO_TAG]($REPO_URL/tree/$REPO_TAG)
        
        ---
        *è‡ªåŠ¨ç”ŸæˆäºŽ GitHub Actions*
        END
        
        echo "å‘å¸ƒè¯´æ˜Žå·²ç”Ÿæˆ"
        cat $GITHUB_WORKSPACE/release.md

    - name: ä¸Šä¼ é…ç½®æ–‡ä»¶åˆ° Artifacts (å¤‡ä»½)
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.CONFIG_NAME }}-config
        path: upload/*.config

    - name: åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ env.RELEASE_TAG }}
        name: "é…ç½®æ–‡ä»¶ - ${{ env.CONFIG_NAME }} [${{ env.REPO_TAG }}]"
        bodyFile: "${{ github.workspace }}/release.md"
        artifacts: "${{ github.workspace }}/upload/*.config"
        allowUpdates: true
        removeArtifacts: false
        replacesArtifacts: false
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: æ˜¾ç¤ºå®Œæˆä¿¡æ¯
      run: |
        echo "=========================================="
        echo "           âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
        echo "=========================================="
        echo "ðŸ“ é…ç½®æ–‡ä»¶: $CONFIG_NAME.config"
        echo "ðŸ·ï¸ å‘å¸ƒæ ‡ç­¾: $RELEASE_TAG"
        echo "ðŸ“Œ æºç ç‰ˆæœ¬: $REPO_TAG"
        echo "ðŸ”Œ è‡ªå®šä¹‰æ’ä»¶: $LOAD_CUSTOM_FEEDS"
        echo "ðŸ“¦ è®¾å¤‡åž‹å·: ${DEVICE_PROFILE:-æœªæŒ‡å®š}"
        echo ""
        echo "ðŸ“¥ æ–‡ä»¶å·²ä¸Šä¼ åˆ°:"
        echo "   1. Release é¡µé¢ (æ°¸ä¹…ä¿å­˜)"
        echo "   2. Artifacts (ä¸´æ—¶å¤‡ä»½)"
        echo "=========================================="
        echo ""
        echo "ðŸ”— æŸ¥çœ‹ Release: https://github.com/${{ github.repository }}/releases/tag/$RELEASE_TAG"
