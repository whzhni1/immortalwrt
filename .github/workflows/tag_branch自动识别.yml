#
# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-ImmortalWrt
# Description: Build ImmortalWrt for Multiple Devices
#

name: tag_branchè‡ªåŠ¨è¯†åˆ«

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      REPO_VERSION:
        description: 'é€‰æ‹© ImmortalWrt ç‰ˆæœ¬ (æ ¼å¼: v24.10.2 æˆ–åˆ†æ”¯å)'
        required: true
        default: 'v24.10.2'
        type: string
      DEVICE_MODEL:
        description: 'é€‰æ‹©è·¯ç”±å™¨åž‹å·'
        required: true
        default: 'rax3000m'
        type: choice
        options:
          - rax3000m
          - ax6000
      LAN_IP:
        description: 'è®¾ç½®LAN IPåœ°å€'
        required: true
        default: '192.168.1.1'
      UPLOAD_BIN_DIR:
        description: 'ä¸Šä¼ binç›®å½•'
        required: false
        default: false
        type: boolean
      UPLOAD_FIRMWARE:
        description: 'ä¸Šä¼ å›ºä»¶åˆ°Artifacts'
        required: false
        default: true
        type: boolean
      UPLOAD_RELEASE:
        description: 'å‘å¸ƒå›ºä»¶åˆ°Release'
        required: false
        default: true
        type: boolean
  

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  FEEDS_CONF: feeds.conf.default
  DIY_P1_SH: part1.sh
  DIY_P2_SH: part2.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    
    permissions:
      contents: write
    
    steps:
    - name: æ£€æŸ¥é¡¹ç›®åˆ†æ”¯
      uses: actions/checkout@main

    - name: è®¾ç½®ç‰ˆæœ¬å˜é‡
      run: |
        # æ£€æŸ¥ç‰ˆæœ¬è¾“å…¥
        if [ -z "${{ github.event.inputs.REPO_VERSION }}" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæŒ‡å®šç‰ˆæœ¬ä¿¡æ¯"
          echo "è¯·åœ¨å·¥ä½œæµè¿è¡Œæ—¶æŒ‡å®š ImmortalWrt ç‰ˆæœ¬ï¼ˆtagæˆ–branchï¼‰"
          exit 1
        fi
        
        REPO_VERSION="${{ github.event.inputs.REPO_VERSION }}"
        echo "REPO_VERSION=$REPO_VERSION" >> $GITHUB_ENV
        
        echo "======================================"
        echo "ç”¨æˆ·æŒ‡å®šçš„ç‰ˆæœ¬: $REPO_VERSION"
        echo "æºç ä»“åº“: $REPO_URL"
        echo "======================================"
        
    - name: è®¾ç½®è®¾å¤‡å˜é‡
      run: |
        # æ£€æŸ¥è®¾å¤‡åž‹å·è¾“å…¥
        DEVICE_MODEL="${{ github.event.inputs.DEVICE_MODEL }}"
        if [ -z "$DEVICE_MODEL" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæŒ‡å®šè®¾å¤‡åž‹å·"
          echo "è¯·åœ¨å·¥ä½œæµè¿è¡Œæ—¶é€‰æ‹©è®¾å¤‡åž‹å·"
          exit 1
        fi
        
        echo "DEVICE_MODEL=$DEVICE_MODEL" >> $GITHUB_ENV
        echo "CONFIG_FILE=${DEVICE_MODEL}.config" >> $GITHUB_ENV
        
        # æ ¹æ®è®¾å¤‡åž‹å·è®¾ç½®å˜é‡
        case "$DEVICE_MODEL" in
          "rax3000m")
            echo "DEVICE_NAME=cmcc_rax3000m" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=CMCC-RAX3000M" >> $GITHUB_ENV
            echo "TARGET_NAME=mediatek-filogic" >> $GITHUB_ENV
            ;;
          "ax6000")
            echo "DEVICE_NAME=jdcloud_re-cp-03" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=JDCloud-AX6000" >> $GITHUB_ENV
            echo "TARGET_NAME=mediatek-filogic" >> $GITHUB_ENV
            ;;
          *)
            echo "âŒ é”™è¯¯ï¼šä¸æ”¯æŒçš„è®¾å¤‡åž‹å·: $DEVICE_MODEL"
            exit 1
            ;;
        esac
        
        echo "FILE_DATE=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV
        
        echo "======================================"
        echo "è®¾å¤‡åž‹å·: $DEVICE_MODEL"
        echo "é…ç½®æ–‡ä»¶: ${DEVICE_MODEL}.config"
        echo "======================================"

    - name: åˆå§‹åŒ–ç¼–è¯‘çŽ¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
          git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
          libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
          mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools \
          libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
          vim wget xmlto xxd zlib1g-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        echo "======================================"
        echo "ç¼–è¯‘çŽ¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
        echo "======================================"

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: ä¸‹è½½æºç 
      working-directory: /workdir
      run: |
        df -hT $PWD
        echo "æ­£åœ¨å…‹éš† ImmortalWrt æºç ..."
        echo "ä»“åº“: $REPO_URL"
        echo "ç‰ˆæœ¬: $REPO_VERSION"
        
        # è‡ªåŠ¨è¯†åˆ«æ˜¯ tag è¿˜æ˜¯ branch
        echo "======================================"
        echo "æ£€æµ‹ç‰ˆæœ¬ç±»åž‹..."
        
        # å…ˆå°è¯•èŽ·å–è¿œç¨‹ä»“åº“çš„tagså’Œbranchesåˆ—è¡¨
        echo "èŽ·å–è¿œç¨‹ä»“åº“ä¿¡æ¯..."
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºtagï¼ˆé€šå¸¸ä»¥vå¼€å¤´ï¼Œå¦‚v24.10.2ï¼‰
        if git ls-remote --tags "$REPO_URL" | grep -q "refs/tags/$REPO_VERSION$"; then
          echo "âœ… æ£€æµ‹åˆ° Tag: $REPO_VERSION"
          echo "æ‰§è¡Œå‘½ä»¤: git clone --depth 1 $REPO_URL -b $REPO_VERSION ImmortalWrt"
          
          if ! git clone --depth 1 "$REPO_URL" -b "$REPO_VERSION" ImmortalWrt; then
            echo "âŒ é”™è¯¯ï¼šæ— æ³•å…‹éš† tag '$REPO_VERSION'"
            echo "è¯·æ£€æŸ¥ tag æ˜¯å¦å­˜åœ¨"
            exit 1
          fi
          
          VERSION_TYPE="Tag"
          
        # æ£€æŸ¥æ˜¯å¦ä¸ºbranch
        elif git ls-remote --heads "$REPO_URL" | grep -q "refs/heads/$REPO_VERSION$"; then
          echo "âœ… æ£€æµ‹åˆ° Branch: $REPO_VERSION"
          echo "æ‰§è¡Œå‘½ä»¤: git clone --depth 1 $REPO_URL -b $REPO_VERSION ImmortalWrt"
          
          if ! git clone --depth 1 "$REPO_URL" -b "$REPO_VERSION" ImmortalWrt; then
            echo "âŒ é”™è¯¯ï¼šæ— æ³•å…‹éš†åˆ†æ”¯ '$REPO_VERSION'"
            echo "è¯·æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨"
            exit 1
          fi
          
          VERSION_TYPE="Branch"
          
        else
          echo "âŒ é”™è¯¯ï¼š'$REPO_VERSION' æ—¢ä¸æ˜¯æœ‰æ•ˆçš„ tag ä¹Ÿä¸æ˜¯æœ‰æ•ˆçš„ branch"
          echo ""
          echo "å¯ç”¨çš„ Tagsï¼ˆæœ€è¿‘10ä¸ªï¼‰ï¼š"
          git ls-remote --tags "$REPO_URL" | tail -10 | awk '{print "  - " $2}' | sed 's|refs/tags/||'
          echo ""
          echo "å¯ç”¨çš„ Branchesï¼š"
          git ls-remote --heads "$REPO_URL" | awk '{print "  - " $2}' | sed 's|refs/heads/||'
          exit 1
        fi
        
        ln -sf /workdir/ImmortalWrt $GITHUB_WORKSPACE/ImmortalWrt
        cd ImmortalWrt
        
        # æ˜¾ç¤ºè¯¦ç»†çš„ç‰ˆæœ¬ä¿¡æ¯
        echo "======================================"
        echo "ImmortalWrt æºç ä¿¡æ¯:"
        echo "ç‰ˆæœ¬ç±»åž‹: $VERSION_TYPE"
        echo "ç‰ˆæœ¬åç§°: $REPO_VERSION"
        echo "å½“å‰HEAD: $(git rev-parse --short HEAD)"
        echo "æœ€æ–°æäº¤: $(git log --oneline -1)"
        
        # å°è¯•èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
        if [ -f "include/version.mk" ]; then
          VERSION_NUMBER=$(grep 'VERSION_NUMBER' include/version.mk | cut -d'=' -f2 | tr -d ' ' || echo "æœªæ‰¾åˆ°")
          echo "ç‰ˆæœ¬å·: $VERSION_NUMBER"
        fi
        
        if [ -f "Makefile" ]; then
          VERSION=$(grep '^VERSION' Makefile | head -1 | cut -d'=' -f2 | tr -d ' ' || echo "æœªæ‰¾åˆ°")
          PATCHLEVEL=$(grep '^PATCHLEVEL' Makefile | head -1 | cut -d'=' -f2 | tr -d ' ' || echo "æœªæ‰¾åˆ°")
          SUBLEVEL=$(grep '^SUBLEVEL' Makefile | head -1 | cut -d'=' -f2 | tr -d ' ' || echo "æœªæ‰¾åˆ°")
          if [ "$VERSION" != "æœªæ‰¾åˆ°" ]; then
            echo "ImmortalWrt ç‰ˆæœ¬: $VERSION.$PATCHLEVEL.$SUBLEVEL"
          fi
        fi
        
        echo "å…‹éš†çŠ¶æ€: âœ… æˆåŠŸ"
        echo "======================================"

    - name: åŠ è½½è‡ªå®šä¹‰feedså’Œæ‰§è¡Œè„šæœ¬Part1
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF ImmortalWrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd ImmortalWrt
        echo "======================================"
        echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ Part1..."
        echo "======================================"
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: æ›´æ–°å¹¶å®‰è£…feeds
      run: |
        cd ImmortalWrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "======================================"
        echo "Feeds æ›´æ–°å®‰è£…å®Œæˆ"
        echo "======================================"

    - name: åŠ è½½è®¾å¤‡é…ç½®å’Œæ‰§è¡Œè„šæœ¬Part2
      run: |
        # æ£€æŸ¥è®¾å¤‡é…ç½®æ–‡ä»¶
        if [ ! -f "${{ env.CONFIG_FILE }}" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ ${{ env.CONFIG_FILE }}"
          echo "è¯·ç¡®ä¿é¡¹ç›®æ ¹ç›®å½•å­˜åœ¨è¯¥é…ç½®æ–‡ä»¶"
          ls -la *.config 2>/dev/null || echo "å½“å‰ç›®å½•æ²¡æœ‰æ‰¾åˆ°ä»»ä½• .config æ–‡ä»¶"
          exit 1
        fi
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        echo "ä½¿ç”¨é…ç½®æ–‡ä»¶: ${{ env.CONFIG_FILE }}"
        cp ${{ env.CONFIG_FILE }} ImmortalWrt/.config
        
        # æ‰§è¡Œ Part2 è„šæœ¬
        chmod +x $DIY_P2_SH
        cd ImmortalWrt
        echo "======================================"
        echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ Part2..."
        echo "======================================"
        $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: è®¾ç½®LAN IPåœ°å€
      run: |
        cd ImmortalWrt
        SET_IP="${{ github.event.inputs.LAN_IP }}"
        
        # æ£€æŸ¥IPåœ°å€è¾“å…¥
        if [ -z "$SET_IP" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæŒ‡å®šLAN IPåœ°å€"
          echo "è¯·åœ¨å·¥ä½œæµè¿è¡Œæ—¶è®¾ç½®LAN IPåœ°å€"
          exit 1
        fi
        
        # éªŒè¯IPåœ°å€æ ¼å¼
        if ! [[ $SET_IP =~ ^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$ ]]; then
            echo "âŒ é”™è¯¯ï¼šIPåœ°å€æ ¼å¼æ— æ•ˆ: $SET_IP"
            echo "è¯·è¾“å…¥æœ‰æ•ˆçš„IPv4åœ°å€ï¼Œå¦‚: 192.168.1.1"
            exit 1
        fi
        
        # ä¿®æ”¹é»˜è®¤IPåœ°å€
        sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" package/base-files/files/bin/config_generate
        
        # ä¿®æ”¹LuCIç›¸å…³IP
        if [ -d "feeds/luci/modules/luci-mod-system" ]; then
          find feeds/luci/modules/luci-mod-system -type f -name "flash.js" -exec sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" {} + 2>/dev/null || true
        fi
        
        echo "IP_ADDR=$SET_IP" >> $GITHUB_ENV
        echo "======================================"
        echo "LAN IP åœ°å€è®¾ç½®ä¸º: $SET_IP"
        echo "======================================"

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      id: package
      run: |
        cd ImmortalWrt
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        echo "======================================"
        echo "è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"
        echo "======================================"

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd ImmortalWrt
        echo -e "$(nproc) çº¿ç¨‹ç¼–è¯‘"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        echo "======================================"
        echo "å›ºä»¶ç¼–è¯‘å®Œæˆ"
        echo "======================================"

    - name: æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
      if: (!cancelled())
      run: df -hT

    - name: ä¸Šä¼ binç›®å½•
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && github.event.inputs.UPLOAD_BIN_DIR == 'true'
      with:
        name: ImmortalWrt_bin_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}
        path: ImmortalWrt/bin

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: github.event.inputs.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd ImmortalWrt/bin/targets/*/*
        rm -rf packages
        # åˆ é™¤ä¸éœ€è¦çš„æ–‡ä»¶
        find . -type f -name "*.buildinfo" -o -name "*.manifest" -o -name "*kernel.bin" -o -name "*rootfs.tar.gz" -o -name "*.dtb" | xargs rm -f
        # é‡å‘½åå›ºä»¶æ–‡ä»¶
        for file in *; do
          if [[ -f "$file" ]]; then
            new_name="${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-${file#*${{ env.DEVICE_NAME }}-}"
            mv "$file" "$new_name" 2>/dev/null || mv "$file" "${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-$file"
          fi
        done
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        echo "======================================"
        echo "å›ºä»¶æ•´ç†å®Œæˆï¼Œæ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -lh
        echo "======================================"

    - name: ABIå¯¹æ¯”åˆ†æž
      if: steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        echo "======================================"
        echo "ðŸ” ABI å¯¹æ¯”åˆ†æž"
        echo "======================================"
        
        cd ImmortalWrt
        
        # èŽ·å–å½“å‰ç¼–è¯‘çš„ç‰ˆæœ¬ä¿¡æ¯
        CURRENT_VERSION=""
        if [ -f "include/version.mk" ]; then
          CURRENT_VERSION=$(grep 'VERSION_NUMBER' include/version.mk | cut -d'=' -f2 | tr -d ' ' | head -1 || echo "unknown")
        fi
        
        if [ -f "Makefile" ]; then
          VERSION=$(grep '^VERSION' Makefile | head -1 | cut -d'=' -f2 | tr -d ' ')
          PATCHLEVEL=$(grep '^PATCHLEVEL' Makefile | head -1 | cut -d'=' -f2 | tr -d ' ')
          SUBLEVEL=$(grep '^SUBLEVEL' Makefile | head -1 | cut -d'=' -f2 | tr -d ' ')
          if [ -n "$VERSION" ]; then
            CURRENT_VERSION="${VERSION}.${PATCHLEVEL}.${SUBLEVEL}"
          fi
        fi
        
        echo "ðŸ“‹ å½“å‰ç¼–è¯‘ç‰ˆæœ¬: $CURRENT_VERSION"
        echo "ðŸ”– æºç ç‰ˆæœ¬: $REPO_VERSION"
        
        # èŽ·å–ç›®æ ‡è®¾å¤‡ä¿¡æ¯
        TARGET_INFO=$(grep '^CONFIG_TARGET_BOARD' .config | cut -d'=' -f2 | tr -d '"' | head -1)
        SUBTARGET_INFO=$(grep '^CONFIG_TARGET_SUBTARGET' .config | cut -d'=' -f2 | tr -d '"' | head -1)
        PROFILE_INFO=$(grep '^CONFIG_TARGET_PROFILE' .config | cut -d'=' -f2 | tr -d '"' | head -1)
        
        echo "ðŸŽ¯ ç›®æ ‡è®¾å¤‡: $TARGET_INFO/$SUBTARGET_INFO"
        echo "ðŸ“± è®¾å¤‡é…ç½®: $PROFILE_INFO"
        
        # æ£€æŸ¥å†…æ ¸é…ç½®å·®å¼‚
        echo ""
        echo "ðŸ“Š å†…æ ¸é…ç½®å¯¹æ¯”:"
        if [ -f ".config" ] && [ -f "config.buildinfo" ]; then
          echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶"
          # è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„é…ç½®å¯¹æ¯”é€»è¾‘
        else
          echo "â„¹ï¸  é…ç½®æ–‡ä»¶å¯¹æ¯”éœ€è¦å®Œæ•´çš„æž„å»ºä¿¡æ¯"
        fi
        
        # æ£€æŸ¥è½¯ä»¶åŒ…ç‰ˆæœ¬
        echo ""
        echo "ðŸ“¦ å…³é”®è½¯ä»¶åŒ…ç‰ˆæœ¬:"
        
        # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬
        KERNEL_VERSION=$(grep '^LINUX_VERSION' include/kernel-version.mk 2>/dev/null | cut -d'=' -f2 | tr -d ' ' | head -1 || echo "unknown")
        echo "â–ªï¸  å†…æ ¸ç‰ˆæœ¬: $KERNEL_VERSION"
        
        # æ£€æŸ¥GCCç‰ˆæœ¬
        GCC_VERSION=$(grep '^GCC_VERSION' include/toolchain-build.mk 2>/dev/null | cut -d'=' -f2 | tr -d ' ' | head -1 || echo "unknown")
        echo "â–ªï¸  GCCç‰ˆæœ¬: $GCC_VERSION"
        
        # æ£€æŸ¥muslç‰ˆæœ¬ï¼ˆå¦‚æžœä½¿ç”¨muslï¼‰
        MUSL_VERSION=$(grep '^PKG_VERSION' toolchain/musl/Makefile 2>/dev/null | cut -d'=' -f2 | tr -d ' ' | head -1 || echo "unknown")
        if [ "$MUSL_VERSION" != "unknown" ]; then
          echo "â–ªï¸  muslç‰ˆæœ¬: $MUSL_VERSION"
        fi
        
        # ç”ŸæˆABIå…¼å®¹æ€§æŠ¥å‘Š
        echo ""
        echo "ðŸ”¬ ABIå…¼å®¹æ€§åˆ†æž:"
        
        # æ£€æŸ¥å…³é”®ABIç›¸å…³é…ç½®
        ABI_CHECK_PASS=true
        
        # æ£€æŸ¥å†…æ ¸ABIç‰ˆæœ¬
        if [ -f "bin/targets/$TARGET_INFO/$SUBTARGET_INFO/config.buildinfo" ]; then
          echo "âœ… æž„å»ºé…ç½®æ–‡ä»¶å­˜åœ¨"
          
          # æ£€æŸ¥CONFIG_VERSION_CODEï¼ˆå†…æ ¸ABIç‰ˆæœ¬ï¼‰
          KERNEL_ABI=$(grep 'CONFIG_VERSION_CODE' bin/targets/$TARGET_INFO/$SUBTARGET_INFO/config.buildinfo 2>/dev/null | cut -d'=' -f2 | head -1 || echo "unknown")
          if [ "$KERNEL_ABI" != "unknown" ]; then
            echo "â–ªï¸  å†…æ ¸ABIç‰ˆæœ¬: $KERNEL_ABI"
          fi
          
          # æ£€æŸ¥å…¶ä»–å…³é”®ABIé…ç½®
          KERNEL_RELEASE=$(grep 'KERNEL_PATCHVER' target/linux/$TARGET_INFO/Makefile 2>/dev/null | cut -d'=' -f2 | tr -d ' ' | head -1 || echo "unknown")
          echo "â–ªï¸  å†…æ ¸ç³»åˆ—: $KERNEL_RELEASE"
        else
          echo "âš ï¸  æž„å»ºé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•è¿›è¡Œè¯¦ç»†ABIåˆ†æž"
          ABI_CHECK_PASS=false
        fi
        
        # ç”Ÿæˆå»ºè®®
        echo ""
        echo "ðŸ’¡ å…¼å®¹æ€§å»ºè®®:"
        if [ "$ABI_CHECK_PASS" = "true" ]; then
          echo "âœ… å½“å‰ç¼–è¯‘é…ç½®ä¸Žå®˜æ–¹æºåŸºæœ¬å…¼å®¹"
          echo "â–ªï¸  å¯ä»¥å®‰è£…å¤§éƒ¨åˆ†å®˜æ–¹è½¯ä»¶åŒ…"
          echo "â–ªï¸  å»ºè®®ä½¿ç”¨ç›¸åŒå†…æ ¸ç‰ˆæœ¬çš„è½¯ä»¶åŒ…"
        else
          echo "âš ï¸  æ— æ³•å®Œæˆå®Œæ•´çš„ABIå…¼å®¹æ€§æ£€æŸ¥"
          echo "â–ªï¸  å»ºè®®æµ‹è¯•å…³é”®è½¯ä»¶åŒ…çš„å…¼å®¹æ€§"
          echo "â–ªï¸  å¦‚éœ€å®‰è£…ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…ï¼Œè¯·ç¡®è®¤ABIå…¼å®¹æ€§"
        fi
        
        # ä¸Žå®˜æ–¹å¿«ç…§ç‰ˆæœ¬å¯¹æ¯”
        echo ""
        echo "ðŸŒ å®˜æ–¹ç‰ˆæœ¬å‚è€ƒ:"
        OFFICIAL_SNAPSHOT_URL="https://downloads.immortalwrt.org/snapshots/targets/$TARGET_INFO/$SUBTARGET_INFO/"
        echo "â–ªï¸  å®˜æ–¹å¿«ç…§: $OFFICIAL_SNAPSHOT_URL"
        
        # ç”ŸæˆMD5æ ¡éªŒä¿¡æ¯
        echo ""
        echo "ðŸ”’ å›ºä»¶æ ¡éªŒä¿¡æ¯:"
        if [ -n "$FIRMWARE" ] && [ -d "$FIRMWARE" ]; then
          cd "$FIRMWARE"
          for file in *; do
            if [[ -f "$file" ]]; then
              MD5_SUM=$(md5sum "$file" | cut -d' ' -f1)
              echo "â–ªï¸  $file: $MD5_SUM"
            fi
          done
        fi
        
        echo "======================================"
        echo "ABIåˆ†æžå®Œæˆ"
        echo "======================================"
        
        # ä¿å­˜åˆ†æžç»“æžœåˆ°æ–‡ä»¶
        cat > abi_analysis_report.md <<EOF
        # ABI å…¼å®¹æ€§åˆ†æžæŠ¥å‘Š
        
        ## ç¼–è¯‘ä¿¡æ¯
        - **è®¾å¤‡**: ${{ env.DEVICE_FULL_NAME }}
        - **ç›®æ ‡å¹³å°**: $TARGET_INFO/$SUBTARGET_INFO
        - **ç¼–è¯‘æ—¶é—´**: ${{ env.FILE_DATE }}
        - **æºç ç‰ˆæœ¬**: $REPO_VERSION
        - **ç¼–è¯‘ç‰ˆæœ¬**: $CURRENT_VERSION
        
        ## æ ¸å¿ƒç»„ä»¶ç‰ˆæœ¬
        - **å†…æ ¸ç‰ˆæœ¬**: $KERNEL_VERSION
        - **å†…æ ¸ç³»åˆ—**: $KERNEL_RELEASE
        - **GCCç‰ˆæœ¬**: $GCC_VERSION
        - **Cåº“ç‰ˆæœ¬**: $MUSL_VERSION
        
        ## å…¼å®¹æ€§çŠ¶æ€
        $(if [ "$ABI_CHECK_PASS" = "true" ]; then echo "âœ… **åŸºæœ¬å…¼å®¹**"; else echo "âš ï¸ **éœ€è¦éªŒè¯**"; fi)
        
        ## å»ºè®®
        - ä½¿ç”¨ç›¸åŒå†…æ ¸ç‰ˆæœ¬çš„è½¯ä»¶åŒ…ä»¥ç¡®ä¿å…¼å®¹æ€§
        - æµ‹è¯•å…³é”®åŠŸèƒ½æ¨¡å—çš„å…¼å®¹æ€§
        - å‚è€ƒå®˜æ–¹å¿«ç…§ç‰ˆæœ¬: $OFFICIAL_SNAPSHOT_URL
        
        ## æ ¡éªŒä¿¡æ¯
        $(if [ -n "$FIRMWARE" ] && [ -d "$FIRMWARE" ]; then 
          cd "$FIRMWARE"
          for file in *; do
            if [[ -f "$file" ]]; then
              MD5_SUM=$(md5sum "$file" | cut -d' ' -f1)
              echo "- $file: \`$MD5_SUM\`"
            fi
          done
        fi)
        EOF
        
        echo "âœ… ABIåˆ†æžæŠ¥å‘Šå·²ç”Ÿæˆ: abi_analysis_report.md"

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifacts
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && github.event.inputs.UPLOAD_FIRMWARE == 'true'
      with:
        name: ${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-Firmware
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: github.event.inputs.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        echo "release_tag=${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT
        
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        cat > release.txt <<EOF
        # ${{ env.DEVICE_FULL_NAME }} å›ºä»¶
        
        ## ðŸ“‹ å›ºä»¶ä¿¡æ¯
        
        - **è®¾å¤‡åž‹å·**: ${{ env.DEVICE_FULL_NAME }}
        - **ç›®æ ‡å¹³å°**: ${{ env.TARGET_NAME }}
        - **ç¼–è¯‘æ—¶é—´**: ${{ env.FILE_DATE }}
        - **ç™»å½•åœ°å€**: ${{ env.IP_ADDR }}
        - **é»˜è®¤å¯†ç **: æ— å¯†ç æˆ– password
        
        ## ðŸ“¦ æºç ä¿¡æ¯
        
        - **æºç ä»“åº“**: ${{ env.REPO_URL }}
        - **æºç ç‰ˆæœ¬**: ${{ env.REPO_VERSION }}
        
        ---
        EOF

    - name: å‘å¸ƒå›ºä»¶åˆ°Release
      uses: softprops/action-gh-release@v2.1.0
      if: steps.tag.outputs.status == 'success' && github.event.inputs.UPLOAD_RELEASE == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: |
          ${{ env.FIRMWARE }}/*
          abi_analysis_report.md
        name: ${{ env.DEVICE_FULL_NAME }} - ${{ env.FILE_DATE }}
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        draft: false
        prerelease: false

    - name: åˆ é™¤æ—§çš„workflowè¿è¡Œè®°å½•
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 7
        keep_minimum_runs: 10

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@v0.3.2
      if: github.event.inputs.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 10
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
