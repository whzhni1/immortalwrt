#
# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# Description: Build ImmortalWrt using Official SDK
#

name: SDKç¼–è¯‘å›ºä»¶

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      REPO_VERSION:
        description: 'ImmortalWrt ç‰ˆæœ¬ (å¦‚: 24.10.3)'
        required: true
        default: '24.10.3'
        type: string
      DEVICE_MODEL:
        description: 'é€‰æ‹©è®¾å¤‡åž‹å·'
        required: true
        default: 'rax3000m'
        type: choice
        options:
          - rax3000m
          - ax6000
      LAN_IP:
        description: 'è®¾ç½®LAN IPåœ°å€'
        required: true
        default: '192.168.1.1'
      CUSTOM_PACKAGES:
        description: 'è‡ªå®šä¹‰è½¯ä»¶åŒ… (ç©ºæ ¼åˆ†éš”)'
        required: false
        default: 'luci-app-diskman luci-app-ttyd'
        type: string
      RUN_PART1:
        description: 'æ‰§è¡Œ Part1 è„šæœ¬'
        required: false
        default: true
        type: boolean
      RUN_PART2:
        description: 'æ‰§è¡Œ Part2 è„šæœ¬'
        required: false
        default: true
        type: boolean
      UPLOAD_BIN_DIR:
        description: 'ä¸Šä¼ binç›®å½•'
        required: false
        default: false
        type: boolean
      UPLOAD_FIRMWARE:
        description: 'ä¸Šä¼ å›ºä»¶åˆ°Artifacts'
        required: false
        default: true
        type: boolean
      UPLOAD_RELEASE:
        description: 'å‘å¸ƒå›ºä»¶åˆ°Release'
        required: false
        default: true
        type: boolean

env:
  FEEDS_CONF: feeds.conf.default
  DIY_P1_SH: part1.sh
  DIY_P2_SH: part2.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    
    permissions:
      contents: write
    
    steps:
    - name: æ£€æŸ¥é¡¹ç›®åˆ†æ”¯
      uses: actions/checkout@main

    - name: è®¾ç½®ç‰ˆæœ¬å˜é‡
      run: |
        # æ£€æŸ¥ç‰ˆæœ¬è¾“å…¥
        if [ -z "${{ github.event.inputs.REPO_VERSION }}" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæŒ‡å®šç‰ˆæœ¬ä¿¡æ¯"
          exit 1
        fi
        
        REPO_VERSION="${{ github.event.inputs.REPO_VERSION }}"
        echo "REPO_VERSION=$REPO_VERSION" >> $GITHUB_ENV
        
        echo "======================================"
        echo "ðŸ“‹ ç¼–è¯‘ä¿¡æ¯"
        echo "======================================"
        echo "SDKç‰ˆæœ¬: $REPO_VERSION"
        echo "ç¼–è¯‘æ¨¡å¼: SDK"
        echo "======================================"

    - name: è®¾ç½®è®¾å¤‡å˜é‡
      run: |
        DEVICE_MODEL="${{ github.event.inputs.DEVICE_MODEL }}"
        if [ -z "$DEVICE_MODEL" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæŒ‡å®šè®¾å¤‡åž‹å·"
          exit 1
        fi
        
        echo "DEVICE_MODEL=$DEVICE_MODEL" >> $GITHUB_ENV
        echo "CONFIG_FILE=${DEVICE_MODEL}.config" >> $GITHUB_ENV
        
        # æ ¹æ®è®¾å¤‡åž‹å·è®¾ç½®å˜é‡
        case "$DEVICE_MODEL" in
          "rax3000m")
            echo "DEVICE_NAME=cmcc_rax3000m" >> $GITHUB_ENV
            echo "DEVICE_PROFILE=cmcc_rax3000m" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=CMCC-RAX3000M" >> $GITHUB_ENV
            echo "TARGET_NAME=mediatek-filogic" >> $GITHUB_ENV
            ;;
          "ax6000")
            echo "DEVICE_NAME=jdcloud_re-cp-03" >> $GITHUB_ENV
            echo "DEVICE_PROFILE=jdcloud_re-cp-03" >> $GITHUB_ENV
            echo "DEVICE_FULL_NAME=JDCloud-AX6000" >> $GITHUB_ENV
            echo "TARGET_NAME=mediatek-filogic" >> $GITHUB_ENV
            ;;
          *)
            echo "âŒ é”™è¯¯ï¼šä¸æ”¯æŒçš„è®¾å¤‡åž‹å·: $DEVICE_MODEL"
            exit 1
            ;;
        esac
        
        echo "FILE_DATE=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV
        
        echo "======================================"
        echo "è®¾å¤‡åž‹å·: $DEVICE_MODEL"
        echo "è®¾å¤‡åç§°: $DEVICE_FULL_NAME"
        echo "ç›®æ ‡å¹³å°: $TARGET_NAME"
        echo "======================================"

    - name: åˆå§‹åŒ–ç¼–è¯‘çŽ¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y \
          build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 unzip wget \
          python3-distutils python3-setuptools python3-dev rsync \
          subversion swig time xsltproc zlib1g-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        echo "======================================"
        echo "âœ… ç¼–è¯‘çŽ¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
        echo "======================================"

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: ä¸‹è½½å®˜æ–¹SDK
      working-directory: /workdir
      run: |
        df -hT $PWD
        echo "======================================"
        echo "ðŸ“¦ ä¸‹è½½å®˜æ–¹ SDK"
        echo "======================================"
        
        VERSION="${{ github.event.inputs.REPO_VERSION }}"
        TARGET_PATH=$(echo "${{ env.TARGET_NAME }}" | tr '-' '/')
        
        # èŽ·å–SDKæ–‡ä»¶å
        SDK_INDEX="https://downloads.immortalwrt.org/releases/$VERSION/targets/$TARGET_PATH/"
        echo "èŽ·å–SDKåˆ—è¡¨: $SDK_INDEX"
        
        # æŸ¥æ‰¾SDKæ–‡ä»¶
        SDK_PAGE=$(wget -qO- "$SDK_INDEX")
        SDK_NAME=$(echo "$SDK_PAGE" | grep -o 'immortalwrt-sdk-[^"]*\.tar\.xz' | head -1)
        
        if [ -z "$SDK_NAME" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°SDKæ–‡ä»¶"
          echo "è¯·æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦æ­£ç¡®"
          exit 1
        fi
        
        SDK_URL="${SDK_INDEX}${SDK_NAME}"
        echo "SDKæ–‡ä»¶: $SDK_NAME"
        echo "ä¸‹è½½åœ°å€: $SDK_URL"
        
        # ä¸‹è½½SDK
        echo "å¼€å§‹ä¸‹è½½..."
        wget --show-progress "$SDK_URL" -O sdk.tar.xz
        
        # è§£åŽ‹SDK
        echo "è§£åŽ‹SDK..."
        tar -xf sdk.tar.xz
        
        # é‡å‘½åä¸ºç»Ÿä¸€çš„ç›®å½•å
        mv immortalwrt-sdk-* ImmortalWrt
        ln -sf /workdir/ImmortalWrt $GITHUB_WORKSPACE/ImmortalWrt
        
        cd ImmortalWrt
        
        # æ˜¾ç¤ºSDKä¿¡æ¯
        echo "======================================"
        echo "SDK ä¿¡æ¯:"
        if [ -f "version.buildinfo" ]; then
          echo "ç‰ˆæœ¬ä¿¡æ¯:"
          cat version.buildinfo
        fi
        
        if [ -f ".config" ]; then
          echo "é»˜è®¤é…ç½®å·²å­˜åœ¨"
        fi
        
        echo "ç›®å½•ç»“æž„:"
        ls -la
        
        echo "======================================"
        echo "âœ… SDK å‡†å¤‡å®Œæˆ"
        echo "======================================"

    - name: åŠ è½½è‡ªå®šä¹‰feedså’Œæ‰§è¡Œè„šæœ¬Part1
      if: ${{ github.event.inputs.RUN_PART1 == 'true' }}
      run: |
        # æ£€æŸ¥å¹¶åŠ è½½feedsé…ç½®
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF ImmortalWrt/feeds.conf.default
        
        # å¦‚æžœpart1.shå­˜åœ¨åˆ™æ‰§è¡Œ
        if [ -f "$DIY_P1_SH" ]; then
          chmod +x $DIY_P1_SH
          cd ImmortalWrt
          echo "======================================"
          echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ Part1..."
          echo "======================================"
          $GITHUB_WORKSPACE/$DIY_P1_SH
        else
          echo "Part1 è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi

    - name: æ›´æ–°å¹¶å®‰è£…feeds
      run: |
        cd ImmortalWrt
        
        # æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶æºï¼ˆå¯é€‰ï¼‰
        cat >> feeds.conf.default <<EOF
        # src-git kenzo https://github.com/kenzok8/openwrt-packages
        # src-git small https://github.com/kenzok8/small
        EOF
        
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        echo "======================================"
        echo "âœ… Feeds æ›´æ–°å®‰è£…å®Œæˆ"
        echo "======================================"

    - name: é…ç½®ç¼–è¯‘é€‰é¡¹
      run: |
        cd ImmortalWrt
        
        # ç”Ÿæˆé»˜è®¤é…ç½®
        make defconfig
        
        # æ£€æŸ¥å¹¶åŠ è½½è®¾å¤‡é…ç½®æ–‡ä»¶
        if [ -f "$GITHUB_WORKSPACE/${{ env.CONFIG_FILE }}" ]; then
          echo "======================================"
          echo "ðŸ“‹ åŠ è½½é…ç½®æ–‡ä»¶: ${{ env.CONFIG_FILE }}"
          echo "======================================"
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp "$GITHUB_WORKSPACE/${{ env.CONFIG_FILE }}" .config
          
          # æ˜¾ç¤ºé…ç½®æ–‡ä»¶çš„ä¸»è¦å†…å®¹
          echo "é…ç½®æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          grep -E "^CONFIG_TARGET_|^CONFIG_PACKAGE_luci-theme|^CONFIG_PACKAGE_default-settings" "$GITHUB_WORKSPACE/${{ env.CONFIG_FILE }}" | head -10
          
        else
          echo "âš ï¸ è­¦å‘Šï¼šé…ç½®æ–‡ä»¶ ${{ env.CONFIG_FILE }} ä¸å­˜åœ¨"
          echo "ä½¿ç”¨é»˜è®¤é…ç½®"
          
          # åªæœ‰åœ¨æ²¡æœ‰é…ç½®æ–‡ä»¶æ—¶æ‰æ·»åŠ åŸºç¡€é…ç½®
          cat >> .config <<EOF
        CONFIG_TARGET_mediatek=y
        CONFIG_TARGET_mediatek_filogic=y
        CONFIG_TARGET_mediatek_filogic_DEVICE_${{ env.DEVICE_PROFILE }}=y
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
        CONFIG_PACKAGE_default-settings-chn=y
        EOF
        fi
        
        # æ·»åŠ ç”¨æˆ·æŒ‡å®šçš„é¢å¤–è½¯ä»¶åŒ…ï¼ˆé€šè¿‡è¾“å…¥å‚æ•°ï¼‰
        if [ -n "${{ github.event.inputs.CUSTOM_PACKAGES }}" ]; then
          echo "======================================"
          echo "âž• æ·»åŠ é¢å¤–è½¯ä»¶åŒ…: ${{ github.event.inputs.CUSTOM_PACKAGES }}"
          echo "======================================"
          for pkg in ${{ github.event.inputs.CUSTOM_PACKAGES }}; do
            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤
            if ! grep -q "CONFIG_PACKAGE_$pkg" .config; then
              echo "CONFIG_PACKAGE_$pkg=y" >> .config
              echo "æ·»åŠ : $pkg"
            else
              echo "å·²å­˜åœ¨: $pkg"
            fi
          done
        fi
        
        # æ›´æ–°é…ç½®ï¼Œè§£å†³ä¾èµ–å…³ç³»
        make defconfig
        
        echo "======================================"
        echo "âœ… é…ç½®å®Œæˆ"
        echo "======================================"
        
        # æ˜¾ç¤ºæœ€ç»ˆé…ç½®çš„å…³é”®ä¿¡æ¯
        echo "æœ€ç»ˆé…ç½®æ‘˜è¦:"
        echo "- ç›®æ ‡è®¾å¤‡: $(grep 'CONFIG_TARGET_.*DEVICE' .config | grep '=y')"
        echo "- ä¸»é¢˜: $(grep 'CONFIG_PACKAGE_luci-theme' .config | grep '=y' | wc -l) ä¸ª"
        echo "- åº”ç”¨: $(grep 'CONFIG_PACKAGE_luci-app' .config | grep '=y' | wc -l) ä¸ª"
        echo "- RootFSå¤§å°: $(grep 'CONFIG_TARGET_ROOTFS_PARTSIZE' .config)"

    - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬Part2
      if: ${{ github.event.inputs.RUN_PART2 == 'true' }}
      run: |
        if [ -f "$DIY_P2_SH" ]; then
          chmod +x $DIY_P2_SH
          cd ImmortalWrt
          echo "======================================"
          echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ Part2..."
          echo "======================================"
          $GITHUB_WORKSPACE/$DIY_P2_SH
          
          # é‡æ–°ç”Ÿæˆé…ç½®
          make defconfig
        else
          echo "Part2 è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi

    - name: è®¾ç½®LAN IPåœ°å€
      run: |
        cd ImmortalWrt
        SET_IP="${{ github.event.inputs.LAN_IP }}"
        
        # æ£€æŸ¥IPåœ°å€è¾“å…¥
        if [ -z "$SET_IP" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæŒ‡å®šLAN IPåœ°å€"
          exit 1
        fi
        
        # éªŒè¯IPåœ°å€æ ¼å¼
        if ! [[ $SET_IP =~ ^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$ ]]; then
            echo "âŒ é”™è¯¯ï¼šIPåœ°å€æ ¼å¼æ— æ•ˆ: $SET_IP"
            exit 1
        fi
        
        # SDKæ¨¡å¼ä¸‹é€šè¿‡filesç›®å½•è®¾ç½®é»˜è®¤IP
        mkdir -p files/etc/config
        cat > files/etc/config/network <<EOF
        config interface 'lan'
            option ipaddr '$SET_IP'
            option netmask '255.255.255.0'
        EOF
        
        echo "IP_ADDR=$SET_IP" >> $GITHUB_ENV
        echo "======================================"
        echo "âœ… LAN IP è®¾ç½®ä¸º: $SET_IP"
        echo "======================================"

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      id: package
      run: |
        cd ImmortalWrt
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        echo "======================================"
        echo "âœ… è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"
        echo "======================================"

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd ImmortalWrt
        echo "======================================"
        echo "ðŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶ï¼ˆSDKæ¨¡å¼ï¼‰"
        echo "======================================"
        
        echo "ä½¿ç”¨ $(nproc) çº¿ç¨‹ç¼–è¯‘"
        
        # SDKç¼–è¯‘
        make -j$(nproc) || make -j1 || make -j1 V=s
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æžœ
        if [ -d "bin/targets" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "======================================"
          echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
          echo "======================================"
          
          # æ˜¾ç¤ºç¼–è¯‘ç»“æžœ
          echo "ç¼–è¯‘äº§ç‰©:"
          find bin/targets -type f -name "*.bin" -o -name "*.img.gz" | head -10
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆå›ºä»¶"
          exit 1
        fi

    - name: æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
      if: (!cancelled())
      run: df -hT

    - name: èŽ·å–å®˜æ–¹ABIå¯¹æ¯”
      run: |
        echo "======================================"
        echo "ðŸ” ABI ä¿¡æ¯èŽ·å–"
        echo "======================================"
        
        cd ImmortalWrt
        
        VERSION="${{ github.event.inputs.REPO_VERSION }}"
        TARGET_NAME="${{ env.TARGET_NAME }}"
        TARGET_PATH=$(echo "$TARGET_NAME" | tr '-' '/')
        
        # èŽ·å–å®˜æ–¹ABI
        OFFICIAL_MANIFEST_URL="https://downloads.immortalwrt.org/releases/$VERSION/targets/$TARGET_PATH/immortalwrt-$VERSION-$TARGET_NAME.manifest"
        echo "èŽ·å–å®˜æ–¹manifest: $OFFICIAL_MANIFEST_URL"
        
        if wget -q -O official.manifest "$OFFICIAL_MANIFEST_URL"; then
          OFFICIAL_ABI=$(grep '^kernel ' official.manifest | awk '{print $3}' | head -1)
          echo "å®˜æ–¹ ABI: ${OFFICIAL_ABI:-èŽ·å–å¤±è´¥}"
          echo "OFFICIAL_ABI=$OFFICIAL_ABI" >> $GITHUB_ENV
        else
          echo "å®˜æ–¹ ABI: èŽ·å–å¤±è´¥"
          echo "OFFICIAL_ABI=èŽ·å–å¤±è´¥" >> $GITHUB_ENV
        fi
        
        # èŽ·å–æœ¬åœ°ç¼–è¯‘çš„ABI
        LOCAL_MANIFEST=$(find bin/targets -name "*.manifest" 2>/dev/null | head -1)
        if [ -n "$LOCAL_MANIFEST" ]; then
          LOCAL_ABI=$(grep '^kernel ' "$LOCAL_MANIFEST" | awk '{print $3}' | head -1)
          echo "æœ¬åœ° ABI: ${LOCAL_ABI:-èŽ·å–å¤±è´¥}"
          echo "LOCAL_ABI=$LOCAL_ABI" >> $GITHUB_ENV
        else
          echo "æœ¬åœ° ABI: èŽ·å–å¤±è´¥"
          echo "LOCAL_ABI=èŽ·å–å¤±è´¥" >> $GITHUB_ENV
        fi
        
        # ABIå¯¹æ¯”
        echo "======================================"
        if [ -n "$OFFICIAL_ABI" ] && [ "$OFFICIAL_ABI" != "èŽ·å–å¤±è´¥" ] && [ -n "$LOCAL_ABI" ] && [ "$LOCAL_ABI" != "èŽ·å–å¤±è´¥" ]; then
          if [ "$OFFICIAL_ABI" = "$LOCAL_ABI" ]; then
            echo "âœ… ABI å¯¹æ¯”ç»“æžœ: å®Œå…¨ä¸€è‡´"
            echo "ABI_STATUS=âœ… ä¸€è‡´" >> $GITHUB_ENV
          else
            echo "âŒ ABI å¯¹æ¯”ç»“æžœ: ä¸ä¸€è‡´"
            echo "å®˜æ–¹: $OFFICIAL_ABI"
            echo "æœ¬åœ°: $LOCAL_ABI"
            echo "ABI_STATUS=âŒ ä¸ä¸€è‡´" >> $GITHUB_ENV
          fi
        else
          echo "âš ï¸ ABI å¯¹æ¯”ç»“æžœ: æ— æ³•å¯¹æ¯”"
          echo "ABI_STATUS=âš ï¸ æ— æ³•å¯¹æ¯”" >> $GITHUB_ENV
        fi
        echo "======================================"

    - name: ä¸Šä¼ binç›®å½•
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && github.event.inputs.UPLOAD_BIN_DIR == 'true'
      with:
        name: ImmortalWrt_SDK_bin_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}
        path: ImmortalWrt/bin

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: github.event.inputs.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd ImmortalWrt/bin/targets/*/*
        rm -rf packages
        
        # é‡å‘½åå›ºä»¶æ–‡ä»¶
        for file in *; do
          if [[ -f "$file" ]]; then
            # æå–æ–‡ä»¶æ‰©å±•å
            ext="${file##*.}"
            # æ ¹æ®æ–‡ä»¶ç±»åž‹é‡å‘½å
            case "$file" in
              *sysupgrade*)
                new_name="${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-sysupgrade.$ext"
                ;;
              *factory*)
                new_name="${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-factory.$ext"
                ;;
              *)
                new_name="${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-${file#*${{ env.DEVICE_NAME }}-}"
                ;;
            esac
            mv "$file" "$new_name" 2>/dev/null || mv "$file" "${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-$file"
          fi
        done
        
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        
        echo "======================================"
        echo "ðŸ“¦ å›ºä»¶æ–‡ä»¶åˆ—è¡¨:"
        echo "======================================"
        ls -lh *.bin *.img.gz 2>/dev/null || ls -lh
        echo "======================================"

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifacts
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && github.event.inputs.UPLOAD_FIRMWARE == 'true'
      with:
        name: ${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-SDK-Firmware
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: github.event.inputs.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        echo "release_tag=${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-SDK" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT
        
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        cat > release.txt <<EOF
        # ${{ env.DEVICE_FULL_NAME }} å›ºä»¶ (SDKç¼–è¯‘)
        
        ## ðŸ“‹ å›ºä»¶ä¿¡æ¯
        
        - **è®¾å¤‡åž‹å·**: ${{ env.DEVICE_FULL_NAME }}
        - **ç¼–è¯‘æ–¹å¼**: å®˜æ–¹SDK
        - **ç›®æ ‡å¹³å°**: ${{ env.TARGET_NAME }}
        - **ç¼–è¯‘æ—¶é—´**: ${{ env.FILE_DATE }}
        - **ç™»å½•åœ°å€**: ${{ env.IP_ADDR }}
        - **é»˜è®¤å¯†ç **: æ— å¯†ç æˆ– password
        
        ## ðŸ“¦ ç‰ˆæœ¬ä¿¡æ¯
        
        - **SDKç‰ˆæœ¬**: ${{ env.REPO_VERSION }}
        - **è‡ªå®šä¹‰è½¯ä»¶åŒ…**: ${{ github.event.inputs.CUSTOM_PACKAGES }}
        
        ## ðŸ” ABI ä¿¡æ¯
        
        - **å®˜æ–¹ ABI**: ${{ env.OFFICIAL_ABI }}
        - **æœ¬åœ° ABI**: ${{ env.LOCAL_ABI }}
        - **å¯¹æ¯”ç»“æžœ**: ${{ env.ABI_STATUS }}
        
        ## âš ï¸ æ³¨æ„äº‹é¡¹
        
        - æ­¤å›ºä»¶ä½¿ç”¨å®˜æ–¹SDKç¼–è¯‘ï¼ŒABIä¸Žå®˜æ–¹å›ºä»¶ä¸€è‡´
        - å¯ä»¥ç›´æŽ¥å®‰è£…å®˜æ–¹ä»“åº“çš„å†…æ ¸æ¨¡å—
        - å‡çº§å‰è¯·å¤‡ä»½é‡è¦é…ç½®
        
        ---
        *è‡ªåŠ¨æž„å»º by GitHub Actions*
        EOF

    - name: å‘å¸ƒå›ºä»¶åˆ°Release
      uses: softprops/action-gh-release@v2.1.0
      if: steps.tag.outputs.status == 'success' && github.event.inputs.UPLOAD_RELEASE == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.FIRMWARE }}/*
        name: ${{ env.DEVICE_FULL_NAME }} - ${{ env.FILE_DATE }} (SDK)
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        draft: false
        prerelease: false

    - name: åˆ é™¤æ—§çš„workflowè¿è¡Œè®°å½•
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 7
        keep_minimum_runs: 10

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@v0.3.2
      if: github.event.inputs.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 10
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
