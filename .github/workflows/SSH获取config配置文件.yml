name: Codespaces èœå•é…ç½®æ¨¡å¼

on:
  workflow_dispatch:
    inputs:
      REPO_VERSION:
        description: 'è¾“å…¥ ImmortalWrt ç‰ˆæœ¬ï¼ˆå¦‚ v24.10.2ï¼‰'
        required: false
        default: 'v24.10'
        type: string
      CONFIG_NAME:
        description: 'é…ç½®æ–‡ä»¶åï¼ˆä¸å«.configåç¼€ï¼‰'
        required: true
        default: 'my-config'
        type: string
      LOAD_CUSTOM_FEEDS:
        description: 'åŠ è½½è‡ªå®šä¹‰æ’ä»¶åº“ï¼ˆæ‰§è¡Œpart1.shï¼‰'
        required: false
        default: false
        type: boolean

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  TZ: Asia/Shanghai

jobs:
  codespaces-menuconfig:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: æ£€æŸ¥é¡¹ç›®åˆ†æ”¯
      uses: actions/checkout@main

    - name: è®¾ç½®å˜é‡
      run: |
        REPO_VERSION="${{ github.event.inputs.REPO_VERSION || 'v24.10' }}"
        CONFIG_NAME="${{ github.event.inputs.CONFIG_NAME }}"
        LOAD_CUSTOM_FEEDS="${{ github.event.inputs.LOAD_CUSTOM_FEEDS }}"
        
        echo "REPO_BRANCH=$REPO_VERSION" >> $GITHUB_ENV
        echo "CONFIG_NAME=$CONFIG_NAME" >> $GITHUB_ENV
        echo "LOAD_CUSTOM_FEEDS=$LOAD_CUSTOM_FEEDS" >> $GITHUB_ENV
        
        echo "ä½¿ç”¨ç‰ˆæœ¬: $REPO_VERSION"
        echo "é…ç½®æ–‡ä»¶å: $CONFIG_NAME.config"
        echo "åŠ è½½è‡ªå®šä¹‰æ’ä»¶åº“: $LOAD_CUSTOM_FEEDS"

    - name: å®‰è£…ç¼–è¯‘ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses5-dev \
          git \
          python3 \
          python3-pip \
          rsync \
          file \
          unzip \
          wget \
          curl \
          time

    - name: ä¸‹è½½ ImmortalWrt æºç 
      run: |
        echo "æ­£åœ¨å…‹éš† ImmortalWrt æºç ..."
        echo "ç‰ˆæœ¬: $REPO_BRANCH"
        
        if git clone --depth 1 "$REPO_URL" -b "$REPO_BRANCH" ImmortalWrt; then
          echo "âœ… æºç å…‹éš†æˆåŠŸ"
        else
          echo "âš ï¸  æŒ‡å®šç‰ˆæœ¬ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤åˆ†æ”¯"
          git clone --depth 1 "$REPO_URL" ImmortalWrt
          cd ImmortalWrt
          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          echo "å®é™…ä½¿ç”¨åˆ†æ”¯: $DEFAULT_BRANCH"
          echo "REPO_BRANCH=$DEFAULT_BRANCH" >> $GITHUB_ENV
          cd ..
        fi
        
        echo "æºç å¤§å°: $(du -sh ImmortalWrt | cut -f1)"

    - name: åŠ è½½è‡ªå®šä¹‰æ’ä»¶åº“
      if: env.LOAD_CUSTOM_FEEDS == 'true'
      run: |
        echo "åŠ è½½è‡ªå®šä¹‰æ’ä»¶åº“..."
        if [ -f "part1.sh" ]; then
          chmod +x part1.sh
          cd ImmortalWrt
          ../part1.sh
          echo "âœ… è‡ªå®šä¹‰æ’ä»¶åº“åŠ è½½å®Œæˆ"
        else
          echo "âš ï¸  æœªæ‰¾åˆ° part1.sh æ–‡ä»¶"
        fi

    - name: æ›´æ–°å¹¶å®‰è£… feeds
      run: |
        cd ImmortalWrt
        echo "æ›´æ–° feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "âœ… feeds æ›´æ–°å®Œæˆ"

    - name: åˆ›å»ºäº¤äº’å¼é…ç½®è„šæœ¬
      run: |
        cat > interactive-menuconfig.sh << 'EOF'
#!/bin/bash
set -e

echo "=========================================="
echo "       ImmortalWrt èœå•é…ç½®å·¥å…·"
echo "=========================================="
echo "ç‰ˆæœ¬: $REPO_BRANCH"
echo "é…ç½®å°†ä¿å­˜ä¸º: $CONFIG_NAME.config"
echo ""

cd ImmortalWrt

# æ£€æŸ¥æ˜¯å¦å·²æœ‰é…ç½®
if [ -f .config ]; then
  echo "å‘ç°ç°æœ‰é…ç½®ï¼Œåˆ›å»ºå¤‡ä»½..."
  cp .config .config.backup
  echo "âœ… åŸé…ç½®å·²å¤‡ä»½ä¸º .config.backup"
fi

echo "æ­£åœ¨å¯åŠ¨ menuconfig..."
echo "è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š"
echo "1. é€‰æ‹© Target System â†’ MediaTek Ralink ARM"
echo "2. é€‰æ‹©å¯¹åº”çš„ Subtarget å’Œ Target Profile"
echo "3. é€‰æ‹©éœ€è¦çš„è½¯ä»¶åŒ…"
echo "4. æŒ‰ ESC é€€å‡ºï¼Œé€‰æ‹© Yes ä¿å­˜é…ç½®"
echo ""

# è®¾ç½®ç»ˆç«¯ç¯å¢ƒ
export TERM=xterm-256color
make menuconfig

if [ -f .config ]; then
  echo ""
  echo "âœ… é…ç½®ä¿å­˜æˆåŠŸï¼"
  echo "é…ç½®æ–‡ä»¶æ‘˜è¦:"
  echo "=========================================="
  
  # æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
  DEVICE=$(grep -E "CONFIG_TARGET.*DEVICE.*=y" .config | head -1 | sed 's/CONFIG_TARGET_//' | sed 's/_DEVICE.*//' || echo "æœªçŸ¥è®¾å¤‡")
  echo "ç›®æ ‡è®¾å¤‡: $DEVICE"
  
  PACKAGE_COUNT=$(grep -c "CONFIG_PACKAGE.*=y" .config || echo "0")
  echo "é€‰æ‹©çš„è½¯ä»¶åŒ…: $PACKAGE_COUNT ä¸ª"
  
  # å¤åˆ¶é…ç½®åˆ°å·¥ä½œç›®å½•
  cp .config "../$CONFIG_NAME.config"
  echo "âœ… é…ç½®æ–‡ä»¶å·²ä¿å­˜ä¸º: $CONFIG_NAME.config"
  
  # æ˜¾ç¤ºä¸€äº›å…³é”®é…ç½®
  echo ""
  echo "å…³é”®é…ç½®é€‰é¡¹:"
  grep -E "^(CONFIG_TARGET|CONFIG_BUSYBOX|CONFIG_LUCI)" .config | head -10 || true
  
else
  echo "âŒ æœªæ£€æµ‹åˆ°é…ç½®æ–‡ä»¶ï¼Œè¯·ç¡®ä¿åœ¨ menuconfig ä¸­é€‰æ‹©äº†ä¿å­˜"
  exit 1
fi

echo "=========================================="
EOF

        chmod +x interactive-menuconfig.sh
        
        # åˆ›å»ºä½¿ç”¨è¯´æ˜
        cat > USAGE.md << EOF
# èœå•é…ç½®å·¥å…·ä½¿ç”¨è¯´æ˜

## å¿«é€Ÿå¼€å§‹

è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨é…ç½®ç•Œé¢ï¼š

\`\`\`bash
./interactive-menuconfig.sh
\`\`\`

## æ‰‹åŠ¨æ­¥éª¤

å¦‚æœä¸Šè¿°è„šæœ¬ä¸å·¥ä½œï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œï¼š

\`\`\`bash
cd ImmortalWrt
make menuconfig
\`\`\`

é…ç½®å®Œæˆåï¼Œæ‰‹åŠ¨ä¿å­˜ï¼š

\`\`\`bash
cp ImmortalWrt/.config $CONFIG_NAME.config
\`\`\`

## ä¸‹ä¸€æ­¥

é…ç½®å®Œæˆåï¼Œå·¥ä½œæµå°†è‡ªåŠ¨ä¸Šä¼ é…ç½®æ–‡ä»¶åˆ° GitHub Releaseã€‚

EOF

        echo "âœ… äº¤äº’å¼è„šæœ¬åˆ›å»ºå®Œæˆ"

    - name: å‡†å¤‡ä¸Šä¼ ç¯å¢ƒ
      run: |
        # åˆ›å»ºä¸´æ—¶é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
        if [ ! -f "$CONFIG_NAME.config" ]; then
          echo "åˆ›å»ºç©ºçš„é…ç½®æ–‡ä»¶æ¨¡æ¿..."
          cat > "$CONFIG_NAME.config" << 'EOF'
# ImmortalWrt é…ç½®æ–‡ä»¶
# ç”Ÿæˆæ—¶é—´: $(date)
# ç‰ˆæœ¬: $REPO_BRANCH
# ä½¿ç”¨ ./interactive-menuconfig.sh ç”Ÿæˆå®Œæ•´é…ç½®

# åŸºç¡€é…ç½®ï¼ˆé€šè¿‡ menuconfig ç”Ÿæˆå®Œæ•´é…ç½®ï¼‰
EOF
        fi

    - name: æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
      run: |
        echo "=========================================="
        echo "       èœå•é…ç½®ç¯å¢ƒå‡†å¤‡å®Œæˆ"
        echo "=========================================="
        echo ""
        echo "ğŸ“ æºç ç‰ˆæœ¬: $REPO_BRANCH"
        echo "ğŸ“„ é…ç½®å°†ä¿å­˜ä¸º: $CONFIG_NAME.config"
        echo "ğŸ”Œ è‡ªå®šä¹‰æ’ä»¶: $LOAD_CUSTOM_FEEDS"
        echo ""
        echo "ğŸš€ å¯åŠ¨é…ç½®:"
        echo "   ./interactive-menuconfig.sh"
        echo ""
        echo "ğŸ“– æŸ¥çœ‹è¯´æ˜:"
        echo "   cat USAGE.md"
        echo ""
        echo "ğŸ”§ æ‰‹åŠ¨é…ç½®:"
        echo "   cd ImmortalWrt && make menuconfig"
        echo ""
        echo "ğŸ“‹ é…ç½®æ–‡ä»¶ä½ç½®:"
        echo "   ImmortalWrt/.config (åŸå§‹)"
        echo "   $CONFIG_NAME.config (å‰¯æœ¬)"
        echo ""
        echo "â³ é…ç½®å®Œæˆåï¼Œå·¥ä½œæµå°†è‡ªåŠ¨ç»§ç»­..."
        echo "=========================================="

    - name: ç­‰å¾…äººå·¥é…ç½®ï¼ˆæš‚åœç‚¹ï¼‰
      run: |
        echo "â¸ï¸  è¯·åœ¨æ­¤æ­¥éª¤è¿›è¡Œæ‰‹åŠ¨é…ç½®"
        echo "è¿è¡Œ ./interactive-menuconfig.sh å®Œæˆé…ç½®å"
        echo "å–æ¶ˆä¸‹ä¸€è¡Œçš„æ³¨é‡Šä»¥ç»§ç»­å·¥ä½œæµ"
        # å–æ¶ˆä¸‹ä¸€è¡Œçš„æ³¨é‡Šä»¥ç»§ç»­
        # echo "ç»§ç»­æ‰§è¡Œ..."

    - name: æ£€æŸ¥é…ç½®æ–‡ä»¶
      id: check-config
      run: |
        if [ -f "$CONFIG_NAME.config" ] && [ -s "$CONFIG_NAME.config" ]; then
          CONFIG_SIZE=$(wc -l < "$CONFIG_NAME.config")
          if [ "$CONFIG_SIZE" -gt 10 ]; then
            echo "âœ… æ£€æµ‹åˆ°æœ‰æ•ˆçš„é…ç½®æ–‡ä»¶"
            echo "æ–‡ä»¶è¡Œæ•°: $CONFIG_SIZE"
            echo "status=valid" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  é…ç½®æ–‡ä»¶è¿‡å°ï¼Œå¯èƒ½æœªæ­£ç¡®é…ç½®"
            echo "status=small" >> $GITHUB_OUTPUT
          fi
        else
          echo "âŒ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶"
          echo "status=missing" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
  if: steps.check-config.outputs.status == 'valid'
  id: create-release
  uses: actions/create-release@v1
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  with:
    tag_name: config-${{ env.CONFIG_NAME }}-${{ env.BUILD_DATE }}
    release_name: "é…ç½®æ–‡ä»¶ - ${{ env.CONFIG_NAME }}"
    body: |
      ImmortalWrt èœå•é…ç½®ç”Ÿæˆçš„æ–‡ä»¶
      
      ç”Ÿæˆä¿¡æ¯:
      - æ—¶é—´: ${{ env.BUILD_DATE }}
      - æºç ç‰ˆæœ¬: ${{ env.REPO_BRANCH }}
      - è‡ªå®šä¹‰æ’ä»¶åº“: ${{ env.LOAD_CUSTOM_FEEDS }}
      - é…ç½®æ–‡ä»¶: ${{ env.CONFIG_NAME }}.config
      
      ä½¿ç”¨è¯´æ˜:
      1. ä¸‹è½½æ­¤é…ç½®æ–‡ä»¶
      2. é‡å‘½åä¸ºå¯¹åº”çš„è®¾å¤‡é…ç½®æ–‡ä»¶ï¼ˆå¦‚ rax3000m.configï¼‰
      3. æ”¾ç½®åœ¨ç¼–è¯‘ä»“åº“çš„æ ¹ç›®å½•
      4. è§¦å‘è‡ªåŠ¨ç¼–è¯‘å·¥ä½œæµ
      
      æŠ€æœ¯ä¿¡æ¯:
      - åŸºäº ${{ env.REPO_BRANCH }} ç‰ˆæœ¬ç”Ÿæˆ
      - åŒ…å«å®Œæ•´çš„èœå•é…ç½®é€‰é¡¹
    draft: false
    prerelease: false


    - name: ä¸Šä¼ é…ç½®æ–‡ä»¶
      if: steps.check-config.outputs.status == 'valid'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create-release.outputs.upload_url }}
        asset_path: ${{ env.CONFIG_NAME }}.config
        asset_name: ${{ env.CONFIG_NAME }}.config
        asset_content_type: text/plain

    - name: æ˜¾ç¤ºå®Œæˆä¿¡æ¯
      if: steps.check-config.outputs.status == 'valid'
      run: |
        echo "=========================================="
        echo "           é…ç½®å®Œæˆ"
        echo "=========================================="
        echo "âœ… é…ç½®æ–‡ä»¶å·²ä¸Šä¼ åˆ° GitHub Release"
        echo "ğŸ“ æ–‡ä»¶å: $CONFIG_NAME.config"
        echo "ğŸ”— å‘å¸ƒåœ°å€: ${{ steps.create-release.outputs.html_url }}"
        echo "ğŸ·ï¸  æºç ç‰ˆæœ¬: $REPO_BRANCH"
        echo "ğŸ”§ è‡ªå®šä¹‰æ’ä»¶: $LOAD_CUSTOM_FEEDS"
        echo ""
        echo "ä¸‹ä¸€æ­¥æ“ä½œ:"
        echo "1. ä¸‹è½½é…ç½®æ–‡ä»¶"
        echo "2. é‡å‘½åä¸ºè®¾å¤‡å.configï¼ˆå¦‚ rax3000m.configï¼‰"
        echo "3. æäº¤åˆ°ä»“åº“æ ¹ç›®å½•"
        echo "4. è§¦å‘ç¼–è¯‘å·¥ä½œæµ"
        echo "=========================================="

    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -f interactive-menuconfig.sh USAGE.md
        echo "æ¸…ç†å®Œæˆ"
