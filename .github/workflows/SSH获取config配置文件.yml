name: çº¯èœå•é…ç½®æ¨¡å¼

on:
  workflow_dispatch:
    inputs:
      REPO_VERSION:
        description: 'è¾“å…¥ ImmortalWrt ç‰ˆæœ¬ï¼ˆå¦‚ v24.10.2ï¼‰'
        required: false
        default: 'v24.10.2'
        type: string
      CONFIG_NAME:
        description: 'è®¾ç½®é…ç½®æ–‡ä»¶åï¼ˆä¸å«.configåç¼€ï¼‰'
        required: true
        default: 'my-config'
        type: string
      LOAD_CUSTOM_FEEDS:
        description: 'åŠ è½½è‡ªå®šä¹‰æ’ä»¶åº“ï¼ˆæ‰§è¡Œpart1.shï¼‰'
        required: false
        default: false
        type: boolean

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  TZ: Asia/Shanghai

jobs:
  pure-menuconfig:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
    - name: æ£€æŸ¥é¡¹ç›®åˆ†æ”¯
      uses: actions/checkout@main

    - name: è®¾ç½®å˜é‡
      run: |
        # å¤„ç†ç‰ˆæœ¬è¾“å…¥ï¼ˆç›´æ¥ä½¿ç”¨ v24.10 æ ¼å¼çš„æ ‡ç­¾ï¼‰
        REPO_VERSION="${{ github.event.inputs.REPO_VERSION }}"
        if [ -z "$REPO_VERSION" ]; then
          REPO_VERSION="v24.10"
        fi
        
        # ç›´æ¥ä½¿ç”¨è¾“å…¥çš„æ ‡ç­¾/åˆ†æ”¯å
        REPO_BRANCH="$REPO_VERSION"
        
        CONFIG_NAME="${{ github.event.inputs.CONFIG_NAME }}"
        LOAD_CUSTOM_FEEDS="${{ github.event.inputs.LOAD_CUSTOM_FEEDS }}"
        
        echo "REPO_BRANCH=$REPO_BRANCH" >> $GITHUB_ENV
        echo "CONFIG_NAME=$CONFIG_NAME" >> $GITHUB_ENV
        echo "LOAD_CUSTOM_FEEDS=$LOAD_CUSTOM_FEEDS" >> $GITHUB_ENV
        
        echo "ä½¿ç”¨ç‰ˆæœ¬: $REPO_BRANCH"
        echo "é…ç½®æ–‡ä»¶å: $CONFIG_NAME.config"
        echo "åŠ è½½è‡ªå®šä¹‰æ’ä»¶åº“: $LOAD_CUSTOM_FEEDS"

    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses5-dev \
          git \
          python3 \
          rsync
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: ä¸‹è½½æºç 
      working-directory: /workdir
      run: |
        echo "æ­£åœ¨å…‹éš† ImmortalWrt æºç ..."
        echo "ç‰ˆæœ¬/æ ‡ç­¾: $REPO_BRANCH"
        
        # ç›´æ¥ä½¿ç”¨è¾“å…¥çš„æ ‡ç­¾/åˆ†æ”¯å
        if git clone --depth 1 "$REPO_URL" -b "$REPO_BRANCH" ImmortalWrt; then
          echo "âœ… æºç å…‹éš†æˆåŠŸ: ä½¿ç”¨ $REPO_BRANCH"
        else
          echo "âŒ æ ‡ç­¾/åˆ†æ”¯ '$REPO_BRANCH' ä¸å­˜åœ¨ï¼Œå°è¯•é»˜è®¤åˆ†æ”¯..."
          git clone --depth 1 "$REPO_URL" ImmortalWrt
          cd ImmortalWrt
          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          echo "ä½¿ç”¨é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"
          cd ..
        fi
        
        ln -sf /workdir/ImmortalWrt $GITHUB_WORKSPACE/ImmortalWrt
        echo "æºç å‡†å¤‡å®Œæˆ"

    - name: åŠ è½½è‡ªå®šä¹‰æ’ä»¶åº“ï¼ˆå¦‚æœå¯ç”¨ï¼‰
      if: env.LOAD_CUSTOM_FEEDS == 'true'
      run: |
        echo "æ­£åœ¨åŠ è½½è‡ªå®šä¹‰æ’ä»¶åº“..."
        cd ImmortalWrt
        
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨part1.sh
        if [ -f "$GITHUB_WORKSPACE/part1.sh" ]; then
          echo "æ‰§è¡Œ part1.sh..."
          chmod +x "$GITHUB_WORKSPACE/part1.sh"
          "$GITHUB_WORKSPACE/part1.sh"
          echo "è‡ªå®šä¹‰æ’ä»¶åº“åŠ è½½å®Œæˆ"
        else
          echo "æœªæ‰¾åˆ° part1.shï¼Œè·³è¿‡è‡ªå®šä¹‰æ’ä»¶åº“åŠ è½½"
        fi

    - name: æ›´æ–°å¹¶å®‰è£…feeds
      run: |
        cd ImmortalWrt
        echo "æ›´æ–°feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "feedsæ›´æ–°å®Œæˆ"

    - name: åˆå§‹åŒ–é…ç½®ç¯å¢ƒ
      run: |
        cd ImmortalWrt
        echo "åˆå§‹åŒ–é…ç½®ç¯å¢ƒ..."
        # æ¸…ç†ä»»ä½•ç°æœ‰é…ç½®
        rm -f .config .config.old
        echo "ç¯å¢ƒå‡†å¤‡å®Œæˆï¼Œå¯è¿›è¡Œèœå•é…ç½®"

    - name: SSHè¿æ¥è¿›è¡Œçº¯å‡€èœå•é…ç½®
      uses: P3TERX/ssh2actions@v1.0.0
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      with:
        command: |
          cd /workdir/ImmortalWrt
          echo "=========================================="
          echo "       çº¯å‡€èœå•é…ç½®æ¨¡å¼"
          echo "=========================================="
          echo "æºç ç‰ˆæœ¬: $REPO_BRANCH"
          echo "è‡ªå®šä¹‰æ’ä»¶åº“: $LOAD_CUSTOM_FEEDS"
          echo ""
          
          if [ "$LOAD_CUSTOM_FEEDS" = "true" ]; then
            echo "âœ… å·²åŠ è½½è‡ªå®šä¹‰æ’ä»¶åº“"
            echo "å¯ç”¨æ’ä»¶å·²åŒ…å«part1.shä¸­å®šä¹‰çš„ä»“åº“"
          else
            echo "â„¹ï¸  ä»…ä½¿ç”¨å®˜æ–¹æ’ä»¶åº“"
          fi
          
          echo ""
          echo "è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š"
          echo "1. è¿è¡Œ: make menuconfig"
          echo "2. åœ¨èœå•ä¸­é€‰æ‹©:"
          echo "   - Target System: MediaTek Ralink ARM"
          echo "   - Subtarget: æ ¹æ®è®¾å¤‡é€‰æ‹©"
          echo "   - Target Profile: é€‰æ‹©å…·ä½“è®¾å¤‡"
          echo "   - é€‰æ‹©éœ€è¦çš„è½¯ä»¶åŒ…"
          echo "3. æŒ‰ESCé€€å‡ºï¼Œé€‰æ‹©Yesä¿å­˜é…ç½®"
          echo "4. è¿è¡Œ: exit é€€å‡ºSSHä¼šè¯"
          echo ""
          echo "é…ç½®å°†è‡ªåŠ¨ä¿å­˜åˆ°GitHub Release"
          echo "=========================================="
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export TERM=xterm-256color
          export PS1='[\u@menuconfig \W]\$ '
          
          # ä¿æŒSSHä¼šè¯
          while true; do
            sleep 3600
          done

    - name: æ£€æŸ¥å¹¶å‡†å¤‡é…ç½®æ–‡ä»¶
      run: |
        cd ImmortalWrt
        if [ ! -f .config ]; then
          echo "âŒ æœªç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œè¯·ç¡®ä¿åœ¨menuconfigä¸­ä¿å­˜äº†é…ç½®"
          exit 1
        fi
        
        echo "âœ… æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶"
        echo "é…ç½®æ–‡ä»¶å†…å®¹æ‘˜è¦:"
        echo "=========================================="
        # æ˜¾ç¤ºå…³é”®é…ç½®ä¿¡æ¯
        echo "ç›®æ ‡è®¾å¤‡:"
        grep -E "CONFIG_TARGET.*DEVICE.*=y" .config || echo "æœªè®¾ç½®è®¾å¤‡"
        echo ""
        echo "é€‰æ‹©çš„è½¯ä»¶åŒ…æ•°é‡:"
        grep -c "CONFIG_PACKAGE.*=y" .config || echo "0"
        echo "=========================================="
        
        # é‡å‘½åé…ç½®æ–‡ä»¶
        cp .config "/tmp/$CONFIG_NAME.config"
        echo "é…ç½®æ–‡ä»¶å·²ä¿å­˜ä¸º: $CONFIG_NAME.config"

    - name: åˆ›å»ºé…ç½®å‘å¸ƒç‰ˆæœ¬
      id: create-release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: config-${{ env.CONFIG_NAME }}-$(date +%Y%m%d-%H%M%S)
        release_name: "é…ç½®æ–‡ä»¶ - ${{ env.CONFIG_NAME }}"
        body: |
          é€šè¿‡èœå•é…ç½®ç”Ÿæˆçš„é…ç½®æ–‡ä»¶
          
          ç”Ÿæˆä¿¡æ¯:
          - æ—¶é—´: $(date)
          - æºç ç‰ˆæœ¬: ${{ env.REPO_BRANCH }}
          - è‡ªå®šä¹‰æ’ä»¶åº“: ${{ env.LOAD_CUSTOM_FEEDS }}
          - é…ç½®æ–‡ä»¶: ${{ env.CONFIG_NAME }}.config
          
          ä½¿ç”¨è¯´æ˜:
          1. ä¸‹è½½æ­¤é…ç½®æ–‡ä»¶
          2. é‡å‘½åä¸º: rax3000m.config æˆ– ax6000.config
          3. æ”¾åœ¨ç¼–è¯‘ä»“åº“çš„æ ¹ç›®å½•
          4. è§¦å‘ç¼–è¯‘å·¥ä½œæµå³å¯ä½¿ç”¨æ­¤é…ç½®
          
          æ³¨: æ­¤é…ç½®åŸºäº ${{ env.REPO_BRANCH }} ç‰ˆæœ¬ç”Ÿæˆ
        draft: false
        prerelease: false

    - name: ä¸Šä¼ é…ç½®æ–‡ä»¶åˆ°Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create-release.outputs.upload_url }}
        asset_path: /tmp/${{ env.CONFIG_NAME }}.config
        asset_name: ${{ env.CONFIG_NAME }}.config
        asset_content_type: text/plain

    - name: æ˜¾ç¤ºå®Œæˆä¿¡æ¯
      run: |
        echo "=========================================="
        echo "           é…ç½®å®Œæˆ"
        echo "=========================================="
        echo "âœ… é…ç½®æ–‡ä»¶å·²ç”Ÿæˆå¹¶ä¸Šä¼ åˆ°Release"
        echo "ğŸ“ æ–‡ä»¶å: $CONFIG_NAME.config"
        echo "ğŸ”— ä¸‹è½½åœ°å€: ${{ steps.create-release.outputs.html_url }}"
        echo "ğŸ·ï¸  æºç ç‰ˆæœ¬: $REPO_BRANCH"
        echo "ğŸ”Œ è‡ªå®šä¹‰æ’ä»¶: $LOAD_CUSTOM_FEEDS"
        echo ""
        echo "ä½¿ç”¨è¯´æ˜:"
        echo "1. ä¸‹è½½ä¸Šé¢çš„é…ç½®æ–‡ä»¶"
        echo "2. é‡å‘½åä¸ºå¯¹åº”è®¾å¤‡å.config"
        echo "3. æ”¾å…¥ä»“åº“æ ¹ç›®å½•"
        echo "4. è§¦å‘ç¼–è¯‘å·¥ä½œæµ"
        echo "=========================================="
