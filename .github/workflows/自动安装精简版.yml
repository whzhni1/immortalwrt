name: è‡ªåŠ¨å®‰è£…ç²¾ç®€ç‰ˆ
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      REPO_VERSION:
        description: 'é€‰æ‹© ImmortalWrt ç‰ˆæœ¬ (æ ¼å¼: 24.10.2 æˆ–åˆ†æ”¯å)'
        required: true
        default: '24.10.2'
        type: string
      DEVICE_MODEL:
        description: 'é€‰æ‹©é…ç½®æ–‡ä»¶'
        required: true
        default: 'rax3000m'
        type: choice
        options:
          - rax3000m
          - ax6000
      LAN_IP:
        description: 'è®¾ç½®LAN IPåœ°å€'
        required: true
        default: '192.168.1.1'
      FIX_VERMAGIC:
        description: 'ä¿®å¤ vermagic ä»¥å…¼å®¹å®˜æ–¹è½¯ä»¶æº'
        required: false
        default: true
        type: boolean
      UPLOAD_BIN_DIR:
        description: 'ä¸Šä¼ binç›®å½•'
        required: false
        default: false
        type: boolean
      UPLOAD_FIRMWARE:
        description: 'ä¸Šä¼ å›ºä»¶åˆ°Artifacts'
        required: false
        default: true
        type: boolean
      UPLOAD_RELEASE:
        description: 'å‘å¸ƒå›ºä»¶åˆ°Release'
        required: false
        default: true
        type: boolean

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  FEEDS_CONF: feeds.conf.default
  DIY_P1_SH: part1.sh
  DIY_P2_SH: part2.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    
    steps:
    - name: æ£€æŸ¥é¡¹ç›®åˆ†æ”¯
      uses: actions/checkout@main

    - name: åˆå§‹åŒ–ç¯å¢ƒå’Œå˜é‡
      run: |
        # éªŒè¯å¿…è¦è¾“å…¥
        if [ -z "${{ github.event.inputs.REPO_VERSION }}" ] || [ -z "${{ github.event.inputs.DEVICE_MODEL }}" ]; then
          echo "âŒ é”™è¯¯ï¼šå¿…é¡»æŒ‡å®šç‰ˆæœ¬å’Œè®¾å¤‡å‹å·"
          exit 1
        fi

        # è®¾ç½®ç‰ˆæœ¬å’Œè®¾å¤‡å˜é‡
        REPO_VERSION="${{ github.event.inputs.REPO_VERSION }}"
        DEVICE_MODEL="${{ github.event.inputs.DEVICE_MODEL }}"
        
        # è®¾å¤‡æ˜ å°„
        case "$DEVICE_MODEL" in
          "rax3000m")
            DEVICE_NAME="cmcc_rax3000m"
            DEVICE_FULL_NAME="CMCC-RAX3000M"
            ;;
          "ax6000")
            DEVICE_NAME="jdcloud_re-cp-03" 
            DEVICE_FULL_NAME="JDCloud-AX6000"
            ;;
          *)
            echo "âŒ é”™è¯¯ï¼šä¸æ”¯æŒçš„è®¾å¤‡å‹å·: $DEVICE_MODEL"
            exit 1
            ;;
        esac

        # è®¾ç½®ç¯å¢ƒå˜é‡
        cat >> $GITHUB_ENV << EOF
        REPO_VERSION=$REPO_VERSION
        DEVICE_MODEL=$DEVICE_MODEL
        DEVICE_NAME=$DEVICE_NAME
        DEVICE_FULL_NAME=$DEVICE_FULL_NAME
        CONFIG_FILE=${DEVICE_MODEL}.config
        FILE_DATE=$(date +"%Y.%m.%d-%H%M")
        EOF

        echo "======================================"
        echo "ç‰ˆæœ¬: $REPO_VERSION"
        echo "è®¾å¤‡: $DEVICE_FULL_NAME"
        echo "é…ç½®æ–‡ä»¶: ${DEVICE_MODEL}.config"
        echo "======================================"

    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
          git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
          libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
          mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools \
          libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
          vim wget xmlto xxd zlib1g-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: ä¸‹è½½æºç 
      working-directory: /workdir
      run: |
        df -hT $PWD
        echo "æ­£åœ¨å…‹éš† ImmortalWrt æºç ..."
        
        # æ£€æµ‹ç‰ˆæœ¬ç±»å‹å¹¶å…‹éš†
        if git ls-remote --tags "$REPO_URL" | grep -q "refs/tags/$REPO_VERSION$"; then
          echo "âœ… æ£€æµ‹åˆ° Tag: $REPO_VERSION"
          git clone --depth 1 "$REPO_URL" -b "$REPO_VERSION" ImmortalWrt
        elif [[ "$REPO_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
          VERSION_WITH_V="v$REPO_VERSION"
          if git ls-remote --tags "$REPO_URL" | grep -q "refs/tags/$VERSION_WITH_V$"; then
            echo "âœ… æ£€æµ‹åˆ° Tag: $VERSION_WITH_V"
            git clone --depth 1 "$REPO_URL" -b "$VERSION_WITH_V" ImmortalWrt
            echo "REPO_VERSION=$VERSION_WITH_V" >> $GITHUB_ENV
          elif git ls-remote --heads "$REPO_URL" | grep -q "refs/heads/$REPO_VERSION$"; then
            echo "âœ… æ£€æµ‹åˆ° Branch: $REPO_VERSION"
            git clone --depth 1 "$REPO_URL" -b "$REPO_VERSION" ImmortalWrt
          else
            echo "âŒ é”™è¯¯ï¼šç‰ˆæœ¬ '$REPO_VERSION' ä¸å­˜åœ¨"
            exit 1
          fi
        elif git ls-remote --heads "$REPO_URL" | grep -q "refs/heads/$REPO_VERSION$"; then
          echo "âœ… æ£€æµ‹åˆ° Branch: $REPO_VERSION"
          git clone --depth 1 "$REPO_URL" -b "$REPO_VERSION" ImmortalWrt
        else
          echo "âŒ é”™è¯¯ï¼šç‰ˆæœ¬ '$REPO_VERSION' ä¸å­˜åœ¨"
          exit 1
        fi
        
        ln -sf /workdir/ImmortalWrt $GITHUB_WORKSPACE/ImmortalWrt
        cd ImmortalWrt
        
        echo "æºç ä¿¡æ¯: $(git rev-parse --short HEAD)"

    - name: åŠ è½½é…ç½®å¹¶è®¾ç½®ç›®æ ‡ä¿¡æ¯
      run: |
        echo "ğŸ“‹ åŠ è½½é…ç½®æ–‡ä»¶å¹¶æå–ç›®æ ‡ä¿¡æ¯"
        
        if [ ! -f "${{ env.CONFIG_FILE }}" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ ${{ env.CONFIG_FILE }}"
          exit 1
        fi
        
        # æå– TARGET ä¿¡æ¯
        TARGET_LINE=$(grep "^CONFIG_TARGET_.*_DEVICE_.*=y" "${{ env.CONFIG_FILE }}" | head -1)
        if [ -n "$TARGET_LINE" ]; then
          TARGET_NAME=$(echo "$TARGET_LINE" | awk -F'_' '{print $3"_"$4}')
          TARGET_PATH=$(echo "$TARGET_NAME" | tr '_' '/')
          echo "TARGET_NAME=$TARGET_NAME" >> $GITHUB_ENV
          echo "TARGET_PATH=$TARGET_PATH" >> $GITHUB_ENV
        else
          echo "âš ï¸ ä½¿ç”¨é»˜è®¤ç›®æ ‡å€¼"
          echo "TARGET_NAME=mediatek_filogic" >> $GITHUB_ENV
          echo "TARGET_PATH=mediatek/filogic" >> $GITHUB_ENV
        fi

    - name: è·å–å®˜æ–¹ vermagic
      if: ${{ github.event.inputs.FIX_VERMAGIC == 'true' }}
      run: |
        echo "ğŸ” è·å–å®˜æ–¹ vermagic"
        
        cd ImmortalWrt
        CLEAN_VERSION=$(echo "${{ env.REPO_VERSION }}" | sed 's/^v//')
        KMODS_BASE_URL="https://downloads.immortalwrt.org/releases/$CLEAN_VERSION/targets/${{ env.TARGET_PATH }}/kmods/"
        
        KERNEL_DIR=$(wget -qO- "$KMODS_BASE_URL" | grep -oP '(?<=href=")[0-9.]+-[0-9]+-[0-9a-f]+(?=/)' | head -1)
        OFFICIAL_VERMAGIC=$(echo "$KERNEL_DIR" | grep -oE '[0-9a-f]{32}')
        
        if [ -n "$OFFICIAL_VERMAGIC" ]; then
          echo "$OFFICIAL_VERMAGIC" > .vermagic
          echo "KERNEL_DIR=$KERNEL_DIR" >> $GITHUB_ENV
          echo "OFFICIAL_VERMAGIC=$OFFICIAL_VERMAGIC" >> $GITHUB_ENV
          echo "VERMAGIC_STATUS=âœ… å·²è·å–" >> $GITHUB_ENV
        else
          echo "âŒ æ— æ³•è·å–å®˜æ–¹ vermagic"
          exit 1
        fi

    - name: ä¿®æ”¹å†…æ ¸ç¼–è¯‘è„šæœ¬
      if: ${{ github.event.inputs.FIX_VERMAGIC == 'true' && env.VERMAGIC_STATUS == 'âœ… å·²è·å–' }}
      run: |
        echo "ğŸ”§ ä¿®æ”¹å†…æ ¸ç¼–è¯‘è„šæœ¬"
        
        cd ImmortalWrt
        KERNEL_DEFAULTS_FILE="include/kernel-defaults.mk"
        
        if [ -f "$KERNEL_DEFAULTS_FILE" ]; then
          cp "$KERNEL_DEFAULTS_FILE" "${KERNEL_DEFAULTS_FILE}.backup"
          awk '/> \$(LINUX_DIR)\/\.vermagic/ {print "\tcp $(TOPDIR)/.vermagic $(LINUX_DIR)/.vermagic"; next} 1' \
            "$KERNEL_DEFAULTS_FILE" > "${KERNEL_DEFAULTS_FILE}.tmp"
          mv "${KERNEL_DEFAULTS_FILE}.tmp" "$KERNEL_DEFAULTS_FILE"
          echo "âœ… å†…æ ¸è„šæœ¬ä¿®æ”¹æˆåŠŸ"
        else
          echo "âŒ å†…æ ¸è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi

    - name: åˆ›å»ºè‡ªåŠ¨å®‰è£…è„šæœ¬
      if: ${{ github.event.inputs.FIX_VERMAGIC == 'true' && env.VERMAGIC_STATUS == 'âœ… å·²è·å–' }}
      run: |
        echo "ğŸ”§ åˆ›å»ºè‡ªåŠ¨å®‰è£…è„šæœ¬"
        
        cd ImmortalWrt
        CLEAN_VERSION=$(echo "${{ env.REPO_VERSION }}" | sed 's/^v//')
        KMODS_URL="src/gz immortalwrt_kmods https://mirrors.vsean.net/openwrt/releases/$CLEAN_VERSION/targets/${{ env.TARGET_PATH }}/kmods/${{ env.KERNEL_DIR }}"
        
        # è¯»å–è½¯ä»¶åŒ…åˆ—è¡¨
        if [ -f "$GITHUB_WORKSPACE/packages.txt" ]; then
            PACKAGES_LIST=$(grep -v '^#' "$GITHUB_WORKSPACE/packages.txt" | grep -v '^$' | tr '\n' ' ')
        else
            PACKAGES_LIST="luci-i18n-base-zh-cn luci-i18n-firewall-zh-cn wget-ssl curl"
        fi
        
        # å¤åˆ¶å¹¶é…ç½®è‡ªåŠ¨å®‰è£…è„šæœ¬
        if [ -f "$GITHUB_WORKSPACE/auto-setup-init.sh" ]; then
            mkdir -p files/etc/init.d files/etc/rc.d
            cp "$GITHUB_WORKSPACE/auto-setup-init.sh" files/etc/init.d/auto-setup
            sed -i "s|KMODS_URL_PLACEHOLDER|$KMODS_URL|g" files/etc/init.d/auto-setup
            sed -i "s|PACKAGES_LIST_PLACEHOLDER|$PACKAGES_LIST|g" files/etc/init.d/auto-setup
            chmod +x files/etc/init.d/auto-setup
            ln -sf ../init.d/auto-setup files/etc/rc.d/S99auto-setup
            echo "âœ… è‡ªåŠ¨å®‰è£…è„šæœ¬é…ç½®å®Œæˆ"
        fi

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®å’Œè„šæœ¬
      run: |
        # å¤åˆ¶ feeds é…ç½®
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF ImmortalWrt/feeds.conf.default
        
        # æ‰§è¡Œç¬¬ä¸€éƒ¨åˆ†è„šæœ¬
        chmod +x $DIY_P1_SH
        cd ImmortalWrt
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: æ›´æ–°å¹¶å®‰è£…feeds
      run: |
        cd ImmortalWrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: é…ç½®å’Œç¼–è¯‘å‡†å¤‡
      run: |
        echo "ğŸ“‹ é…ç½®å’Œç¼–è¯‘å‡†å¤‡"
        
        # å¤åˆ¶è®¾å¤‡é…ç½®
        cp ${{ env.CONFIG_FILE }} ImmortalWrt/.config
        
        # è®¾ç½®LAN IP
        SET_IP="${{ github.event.inputs.LAN_IP }}"
        if [[ $SET_IP =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          cd ImmortalWrt
          sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" package/base-files/files/bin/config_generate
          echo "IP_ADDR=$SET_IP" >> $GITHUB_ENV
          echo "âœ… LAN IP è®¾ç½®ä¸º: $SET_IP"
          cd ..
        fi
        
        # æ‰§è¡Œç¬¬äºŒéƒ¨åˆ†è„šæœ¬
        chmod +x $DIY_P2_SH
        cd ImmortalWrt
        $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: ä¸‹è½½è½¯ä»¶åŒ…å¹¶ç¼–è¯‘
      run: |
        cd ImmortalWrt
        make defconfig
        make download -j8
        find dl -size -1024c -delete
        echo "å¼€å§‹ç¼–è¯‘..."
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT

    - name: æ•´ç†å’ŒéªŒè¯å›ºä»¶
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd ImmortalWrt/bin/targets/*/*
        rm -rf packages
        
        # é‡å‘½åå›ºä»¶æ–‡ä»¶
        for file in *; do
          if [[ -f "$file" ]]; then
            new_name="${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-${file#*${{ env.DEVICE_NAME }}-}"
            mv "$file" "$new_name" 2>/dev/null || mv "$file" "${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-$file"
          fi
        done
        
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        echo "å›ºä»¶æ–‡ä»¶:"
        ls -lh

    - name: ä¸Šä¼ binç›®å½•
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && github.event.inputs.UPLOAD_BIN_DIR == 'true'
      with:
        name: ImmortalWrt_bin_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}
        path: ImmortalWrt/bin

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifacts
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && github.event.inputs.UPLOAD_FIRMWARE == 'true'
      with:
        name: ${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-Firmware
        path: ${{ env.FIRMWARE }}

    - name: å‘å¸ƒåˆ°Release
      uses: softprops/action-gh-release@v2.1.0
      if: steps.organize.outputs.status == 'success' && github.event.inputs.UPLOAD_RELEASE == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.FIRMWARE }}/*
        name: ${{ env.DEVICE_FULL_NAME }} - ${{ env.FILE_DATE }}
        tag_name: ${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}
        body: |
          # ${{ env.DEVICE_FULL_NAME }} å›ºä»¶
          
          ## å›ºä»¶ä¿¡æ¯
          - **è®¾å¤‡**: ${{ env.DEVICE_FULL_NAME }}
          - **å¹³å°**: ${{ env.TARGET_PATH }}
          - **æ—¶é—´**: ${{ env.FILE_DATE }}
          - **ç™»å½•**: ${{ env.IP_ADDR }}
          - **æºç **: ${{ env.REPO_URL }}@${{ env.REPO_VERSION }}
        draft: false
        prerelease: false

    - name: æ¸…ç†æ—§æ•°æ®
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 7
        keep_minimum_runs: 10

    - name: æ¸…ç†æ—§Release
      uses: dev-drprasad/delete-older-releases@v0.3.2
      if: github.event.inputs.UPLOAD_RELEASE == 'true'
      with:
        keep_latest: 10
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
