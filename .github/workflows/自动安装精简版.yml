name: Ëá™Âä®ÂÆâË£ÖÁ≤æÁÆÄÁâà
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      REPO_VERSION:
        description: 'ÈÄâÊã© ImmortalWrt ÁâàÊú¨ (Ê†ºÂºè: 24.10.2 ÊàñÂàÜÊîØÂêç)'
        required: true
        default: '24.10.2'
        type: string
      DEVICE_MODEL:
        description: 'ÈÄâÊã©ÈÖçÁΩÆÊñá‰ª∂'
        required: true
        default: 'rax3000m'
        type: choice
        options:
          - rax3000m
          - ax6000
      LAN_IP:
        description: 'ËÆæÁΩÆLAN IPÂú∞ÂùÄ'
        required: true
        default: '192.168.1.1'
      FIX_VERMAGIC:
        description: '‰øÆÂ§ç vermagic ‰ª•ÂÖºÂÆπÂÆòÊñπËΩØ‰ª∂Ê∫ê'
        required: false
        default: true
        type: boolean
      UPLOAD_BIN_DIR:
        description: '‰∏ä‰º†binÁõÆÂΩï'
        required: false
        default: false
        type: boolean
      UPLOAD_FIRMWARE:
        description: '‰∏ä‰º†Âõ∫‰ª∂Âà∞Artifacts'
        required: false
        default: true
        type: boolean
      UPLOAD_RELEASE:
        description: 'ÂèëÂ∏ÉÂõ∫‰ª∂Âà∞Release'
        required: false
        default: true
        type: boolean

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  FEEDS_CONF: feeds.conf.default
  DIY_P1_SH: part1.sh
  DIY_P2_SH: part2.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    
    steps:
    - name: Ê£ÄÊü•È°πÁõÆÂàÜÊîØ
      uses: actions/checkout@main

    - name: ÂàùÂßãÂåñÁéØÂ¢ÉÂíåÂèòÈáè
      run: |
        # È™åËØÅÂøÖË¶ÅËæìÂÖ•
        if [ -z "${{ github.event.inputs.REPO_VERSION }}" ] || [ -z "${{ github.event.inputs.DEVICE_MODEL }}" ]; then
          echo "‚ùå ÈîôËØØÔºöÂøÖÈ°ªÊåáÂÆöÁâàÊú¨ÂíåËÆæÂ§áÂûãÂè∑"
          exit 1
        fi

        # ËÆæÁΩÆÁâàÊú¨ÂíåËÆæÂ§áÂèòÈáè
        REPO_VERSION="${{ github.event.inputs.REPO_VERSION }}"
        DEVICE_MODEL="${{ github.event.inputs.DEVICE_MODEL }}"
        
        # ËÆæÂ§áÊò†Â∞Ñ
        case "$DEVICE_MODEL" in
          "rax3000m")
            DEVICE_NAME="cmcc_rax3000m"
            DEVICE_FULL_NAME="CMCC-RAX3000M"
            ;;
          "ax6000")
            DEVICE_NAME="jdcloud_re-cp-03" 
            DEVICE_FULL_NAME="JDCloud-AX6000"
            ;;
          *)
            echo "‚ùå ÈîôËØØÔºö‰∏çÊîØÊåÅÁöÑËÆæÂ§áÂûãÂè∑: $DEVICE_MODEL"
            exit 1
            ;;
        esac

        # ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè
        cat >> $GITHUB_ENV << EOF
        REPO_VERSION=$REPO_VERSION
        DEVICE_MODEL=$DEVICE_MODEL
        DEVICE_NAME=$DEVICE_NAME
        DEVICE_FULL_NAME=$DEVICE_FULL_NAME
        CONFIG_FILE=${DEVICE_MODEL}.config
        FILE_DATE=$(date +"%Y.%m.%d-%H%M")
        EOF

        echo "======================================"
        echo "ÁâàÊú¨: $REPO_VERSION"
        echo "ËÆæÂ§á: $DEVICE_FULL_NAME"
        echo "ÈÖçÁΩÆÊñá‰ª∂: ${DEVICE_MODEL}.config"
        echo "======================================"

    - name: ÂàùÂßãÂåñÁºñËØëÁéØÂ¢É
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
          git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
          libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
          mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools \
          libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
          vim wget xmlto xxd zlib1g-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: Ê∏ÖÁêÜÁ£ÅÁõòÁ©∫Èó¥
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: ‰∏ãËΩΩÊ∫êÁ†Å
      working-directory: /workdir
      run: |
        df -hT $PWD
        echo "Ê≠£Âú®ÂÖãÈöÜ ImmortalWrt Ê∫êÁ†Å..."
        
        # Ê£ÄÊµãÁâàÊú¨Á±ªÂûãÂπ∂ÂÖãÈöÜ
        if git ls-remote --tags "$REPO_URL" | grep -q "refs/tags/$REPO_VERSION$"; then
          echo "‚úÖ Ê£ÄÊµãÂà∞ Tag: $REPO_VERSION"
          git clone --depth 1 "$REPO_URL" -b "$REPO_VERSION" ImmortalWrt
        elif [[ "$REPO_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
          VERSION_WITH_V="v$REPO_VERSION"
          if git ls-remote --tags "$REPO_URL" | grep -q "refs/tags/$VERSION_WITH_V$"; then
            echo "‚úÖ Ê£ÄÊµãÂà∞ Tag: $VERSION_WITH_V"
            git clone --depth 1 "$REPO_URL" -b "$VERSION_WITH_V" ImmortalWrt
            echo "REPO_VERSION=$VERSION_WITH_V" >> $GITHUB_ENV
          elif git ls-remote --heads "$REPO_URL" | grep -q "refs/heads/$REPO_VERSION$"; then
            echo "‚úÖ Ê£ÄÊµãÂà∞ Branch: $REPO_VERSION"
            git clone --depth 1 "$REPO_URL" -b "$REPO_VERSION" ImmortalWrt
          else
            echo "‚ùå ÈîôËØØÔºöÁâàÊú¨ '$REPO_VERSION' ‰∏çÂ≠òÂú®"
            exit 1
          fi
        elif git ls-remote --heads "$REPO_URL" | grep -q "refs/heads/$REPO_VERSION$"; then
          echo "‚úÖ Ê£ÄÊµãÂà∞ Branch: $REPO_VERSION"
          git clone --depth 1 "$REPO_URL" -b "$REPO_VERSION" ImmortalWrt
        else
          echo "‚ùå ÈîôËØØÔºöÁâàÊú¨ '$REPO_VERSION' ‰∏çÂ≠òÂú®"
          exit 1
        fi
        
        ln -sf /workdir/ImmortalWrt $GITHUB_WORKSPACE/ImmortalWrt
        cd ImmortalWrt
        
        echo "Ê∫êÁ†Å‰ø°ÊÅØ: $(git rev-parse --short HEAD)"

    - name: Âä†ËΩΩÈÖçÁΩÆÂπ∂ËÆæÁΩÆÁõÆÊ†á‰ø°ÊÅØ
      run: |
        echo "üìã Âä†ËΩΩÈÖçÁΩÆÊñá‰ª∂Âπ∂ÊèêÂèñÁõÆÊ†á‰ø°ÊÅØ"
        
        if [ ! -f "${{ env.CONFIG_FILE }}" ]; then
          echo "‚ùå ÈîôËØØÔºöÊú™ÊâæÂà∞ÈÖçÁΩÆÊñá‰ª∂ ${{ env.CONFIG_FILE }}"
          exit 1
        fi
        
        # ÊèêÂèñ TARGET ‰ø°ÊÅØ
        TARGET_LINE=$(grep "^CONFIG_TARGET_.*_DEVICE_.*=y" "${{ env.CONFIG_FILE }}" | head -1)
        if [ -n "$TARGET_LINE" ]; then
          TARGET_NAME=$(echo "$TARGET_LINE" | awk -F'_' '{print $3"_"$4}')
          TARGET_PATH=$(echo "$TARGET_NAME" | tr '_' '/')
          echo "TARGET_NAME=$TARGET_NAME" >> $GITHUB_ENV
          echo "TARGET_PATH=$TARGET_PATH" >> $GITHUB_ENV
        else
          echo "‚ö†Ô∏è ‰ΩøÁî®ÈªòËÆ§ÁõÆÊ†áÂÄº"
          echo "TARGET_NAME=mediatek_filogic" >> $GITHUB_ENV
          echo "TARGET_PATH=mediatek/filogic" >> $GITHUB_ENV
        fi

    - name: Ëé∑ÂèñÂÆòÊñπ vermagic
      if: ${{ github.event.inputs.FIX_VERMAGIC == 'true' }}
      run: |
        echo "üîç Ëé∑ÂèñÂÆòÊñπ vermagic"
        
        cd ImmortalWrt
        CLEAN_VERSION=$(echo "${{ env.REPO_VERSION }}" | sed 's/^v//')
        KMODS_BASE_URL="https://downloads.immortalwrt.org/releases/$CLEAN_VERSION/targets/${{ env.TARGET_PATH }}/kmods/"
        
        KERNEL_DIR=$(wget -qO- "$KMODS_BASE_URL" | grep -oP '(?<=href=")[0-9.]+-[0-9]+-[0-9a-f]+(?=/)' | head -1)
        OFFICIAL_VERMAGIC=$(echo "$KERNEL_DIR" | grep -oE '[0-9a-f]{32}')
        
        if [ -n "$OFFICIAL_VERMAGIC" ]; then
          echo "$OFFICIAL_VERMAGIC" > .vermagic
          echo "KERNEL_DIR=$KERNEL_DIR" >> $GITHUB_ENV
          echo "OFFICIAL_VERMAGIC=$OFFICIAL_VERMAGIC" >> $GITHUB_ENV
          echo "VERMAGIC_STATUS=‚úÖ Â∑≤Ëé∑Âèñ" >> $GITHUB_ENV
        else
          echo "‚ùå Êó†Ê≥ïËé∑ÂèñÂÆòÊñπ vermagic"
          exit 1
        fi

    - name: ‰øÆÊîπÂÜÖÊ†∏ÁºñËØëËÑöÊú¨
      if: ${{ github.event.inputs.FIX_VERMAGIC == 'true' && env.VERMAGIC_STATUS == '‚úÖ Â∑≤Ëé∑Âèñ' }}
      run: |
        echo "üîß ‰øÆÊîπÂÜÖÊ†∏ÁºñËØëËÑöÊú¨"
        
        cd ImmortalWrt
        KERNEL_DEFAULTS_FILE="include/kernel-defaults.mk"
        
        if [ -f "$KERNEL_DEFAULTS_FILE" ]; then
          cp "$KERNEL_DEFAULTS_FILE" "${KERNEL_DEFAULTS_FILE}.backup"
          awk '/> \$(LINUX_DIR)\/\.vermagic/ {print "\tcp $(TOPDIR)/.vermagic $(LINUX_DIR)/.vermagic"; next} 1' \
            "$KERNEL_DEFAULTS_FILE" > "${KERNEL_DEFAULTS_FILE}.tmp"
          mv "${KERNEL_DEFAULTS_FILE}.tmp" "$KERNEL_DEFAULTS_FILE"
          echo "‚úÖ ÂÜÖÊ†∏ËÑöÊú¨‰øÆÊîπÊàêÂäü"
        else
          echo "‚ùå ÂÜÖÊ†∏ËÑöÊú¨Êñá‰ª∂‰∏çÂ≠òÂú®"
          exit 1
        fi

    - name: ÂàõÂª∫Ëá™Âä®ÂÆâË£ÖËÑöÊú¨
      if: ${{ github.event.inputs.FIX_VERMAGIC == 'true' && env.VERMAGIC_STATUS == '‚úÖ Â∑≤Ëé∑Âèñ' }}
      run: |
        echo "üîß ÂàõÂª∫Ëá™Âä®ÂÆâË£ÖËÑöÊú¨"
        
        cd ImmortalWrt
        CLEAN_VERSION=$(echo "${{ env.REPO_VERSION }}" | sed 's/^v//')
        KMODS_URL="src/gz immortalwrt_kmods https://mirrors.vsean.net/openwrt/releases/$CLEAN_VERSION/targets/${{ env.TARGET_PATH }}/kmods/${{ env.KERNEL_DIR }}"
        
        # ËØªÂèñËΩØ‰ª∂ÂåÖÂàóË°®
        if [ -f "$GITHUB_WORKSPACE/packages.txt" ]; then
            PACKAGES_LIST=$(grep -v '^#' "$GITHUB_WORKSPACE/packages.txt" | grep -v '^$' | tr '\n' ' ')
        else
            PACKAGES_LIST="luci-i18n-base-zh-cn luci-i18n-firewall-zh-cn wget-ssl curl"
        fi
        
        # Â§çÂà∂Âπ∂ÈÖçÁΩÆËá™Âä®ÂÆâË£ÖËÑöÊú¨
        if [ -f "$GITHUB_WORKSPACE/auto-setup-init.sh" ]; then
            mkdir -p files/etc/init.d files/etc/rc.d
            cp "$GITHUB_WORKSPACE/auto-setup-init.sh" files/etc/init.d/auto-setup
            sed -i "s|KMODS_URL_PLACEHOLDER|$KMODS_URL|g" files/etc/init.d/auto-setup
            sed -i "s|PACKAGES_LIST_PLACEHOLDER|$PACKAGES_LIST|g" files/etc/init.d/auto-setup
            chmod +x files/etc/init.d/auto-setup
            ln -sf ../init.d/auto-setup files/etc/rc.d/S99auto-setup
            echo "‚úÖ Ëá™Âä®ÂÆâË£ÖËÑöÊú¨ÈÖçÁΩÆÂÆåÊàê"
        fi

    - name: Âä†ËΩΩËá™ÂÆö‰πâÈÖçÁΩÆÂíåËÑöÊú¨
      run: |
        # Â§çÂà∂ feeds ÈÖçÁΩÆ
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF ImmortalWrt/feeds.conf.default
        
        # ÊâßË°åÁ¨¨‰∏ÄÈÉ®ÂàÜËÑöÊú¨
        chmod +x $DIY_P1_SH
        cd ImmortalWrt
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: Êõ¥Êñ∞Âπ∂ÂÆâË£Öfeeds
      run: |
        cd ImmortalWrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: ÈÖçÁΩÆÂíåÁºñËØëÂáÜÂ§á
      run: |
        echo "üìã ÈÖçÁΩÆÂíåÁºñËØëÂáÜÂ§á"
        
        # Â§çÂà∂ËÆæÂ§áÈÖçÁΩÆ
        cp ${{ env.CONFIG_FILE }} ImmortalWrt/.config
        
        # ËÆæÁΩÆLAN IP
        SET_IP="${{ github.event.inputs.LAN_IP }}"
        if [[ $SET_IP =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          cd ImmortalWrt
          sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" package/base-files/files/bin/config_generate
          echo "IP_ADDR=$SET_IP" >> $GITHUB_ENV
          echo "‚úÖ LAN IP ËÆæÁΩÆ‰∏∫: $SET_IP"
          cd ..
        fi
        
        # ÊâßË°åÁ¨¨‰∫åÈÉ®ÂàÜËÑöÊú¨
        chmod +x $DIY_P2_SH
        cd ImmortalWrt
        $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: ‰∏ãËΩΩËΩØ‰ª∂ÂåÖÂπ∂ÁºñËØë
      run: |
        cd ImmortalWrt
        make defconfig
        make download -j8
        find dl -size -1024c -delete
        echo "ÂºÄÂßãÁºñËØë..."
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Êï¥ÁêÜÂíåÈ™åËØÅÂõ∫‰ª∂
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd ImmortalWrt/bin/targets/*/*
        rm -rf packages
        
        # ÈáçÂëΩÂêçÂõ∫‰ª∂Êñá‰ª∂
        for file in *; do
          if [[ -f "$file" ]]; then
            new_name="${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-${file#*${{ env.DEVICE_NAME }}-}"
            mv "$file" "$new_name" 2>/dev/null || mv "$file" "${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-$file"
          fi
        done
        
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        echo "Âõ∫‰ª∂Êñá‰ª∂:"
        ls -lh

    - name: ‰∏ä‰º†binÁõÆÂΩï
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && github.event.inputs.UPLOAD_BIN_DIR == 'true'
      with:
        name: ImmortalWrt_bin_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}
        path: ImmortalWrt/bin

    - name: ‰∏ä‰º†Âõ∫‰ª∂Âà∞Artifacts
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && github.event.inputs.UPLOAD_FIRMWARE == 'true'
      with:
        name: ${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-Firmware
        path: ${{ env.FIRMWARE }}

    - name: ÂèëÂ∏ÉÂà∞Release
      uses: softprops/action-gh-release@v2.1.0
      if: steps.organize.outputs.status == 'success' && github.event.inputs.UPLOAD_RELEASE == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.FIRMWARE }}/*
        name: ${{ env.DEVICE_FULL_NAME }} - ${{ env.FILE_DATE }}
        tag_name: ${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}
        body: |
          # ${{ env.DEVICE_FULL_NAME }} Âõ∫‰ª∂
          
          ## Âõ∫‰ª∂‰ø°ÊÅØ
          - **ËÆæÂ§á**: ${{ env.DEVICE_FULL_NAME }}
          - **Âπ≥Âè∞**: ${{ env.TARGET_PATH }}
          - **Êó∂Èó¥**: ${{ env.FILE_DATE }}
          - **ÁôªÂΩï**: ${{ env.IP_ADDR }}
          - **Ê∫êÁ†Å**: ${{ env.REPO_URL }}@${{ env.REPO_VERSION }}
        draft: false
        prerelease: false
