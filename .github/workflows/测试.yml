name: è·å–å®˜æ–¹ABI

on:
  workflow_dispatch:
    inputs:
      REPO_VERSION:
        description: 'é€‰æ‹© ImmortalWrt ç‰ˆæœ¬ (æ ¼å¼: v24.10.3)'
        required: true
        default: '24.10.3'
        type: string
      TARGET_NAME:
        description: 'å¹³å° (ä¾‹å¦‚ mediatek-filogic)'
        required: true
        default: 'mediatek-filogic'
        type: string

jobs:
  fetch-abi:
    runs-on: ubuntu-22.04
    steps:
      - name: æ‹¼æ¥å¹¶ä¸‹è½½å®˜æ–¹ manifest
        run: |
          echo "======================================"
          echo "ğŸ” å¼€å§‹è·å–å®˜æ–¹ ABI"
          echo "======================================"

          VERSION="${{ github.event.inputs.REPO_VERSION }}"
          TARGET_NAME="${{ github.event.inputs.TARGET_NAME }}"
          TARGET_PATH=$(echo "$TARGET_NAME" | tr '-' '/')

          # æ‹¼æ¥ URL
          OFFICIAL_MANIFEST_URL="https://downloads.immortalwrt.org/releases/$VERSION/targets/$TARGET_PATH/immortalwrt-$VERSION-$TARGET_NAME.manifest"

          echo "æ‹¼æ¥çš„å®˜æ–¹åœ°å€: $OFFICIAL_MANIFEST_URL"

          # ä¸‹è½½ manifest
          if wget -q -O official.manifest "$OFFICIAL_MANIFEST_URL"; then
            echo "âœ… å®˜æ–¹ manifest ä¸‹è½½æˆåŠŸ"
            echo "------ manifest å‰10è¡Œ ------"
            head -10 official.manifest
            echo "-----------------------------"

            # æå– kernel è¡Œ
            KERNEL_LINE=$(grep '^kernel ' official.manifest | head -1)
            echo "æå–åˆ°çš„ kernel è¡Œ: $KERNEL_LINE"

            # æå– 32 ä½åå…­è¿›åˆ¶å“ˆå¸Œ
            OFFICIAL_VERMAGIC=$(echo "$KERNEL_LINE" | grep -oE '[0-9a-f]{32}')
            echo "è§£æå‡ºçš„ ABI: $OFFICIAL_VERMAGIC"

            # æµ‹è¯•1
            KERNEL_LINE="kernel - 5.15.189-1-dab81cfed92fb4881f7b4fec9f787850"
            echo "æµ‹è¯•1æå–åˆ°çš„ kernel è¡Œ: $KERNEL_LINE"
            TEST1_VERMAGIC=$(echo "$KERNEL_LINE" | grep -oE '[0-9a-f]{32}')
            echo "æµ‹è¯•1è§£æå‡ºçš„ ABI: $TEST1_VERMAGIC"

            # æµ‹è¯•2
            KERNEL_LINE="kernel - 6.6.93~2ccac7a75355327cb6dfb4df1ecb575e-r1"
            echo "æµ‹è¯•2æå–åˆ°çš„ kernel è¡Œ: $KERNEL_LINE"
            TEST2_VERMAGIC=$(echo "$KERNEL_LINE" | grep -oE '[0-9a-f]{32}')
            echo "æµ‹è¯•2è§£æå‡ºçš„ ABI: $TEST2_VERMAGIC"


            
          else
            echo "âŒ å®˜æ–¹ manifest ä¸‹è½½å¤±è´¥"
            exit 1
          fi

          echo "======================================"
          echo "ä»»åŠ¡å®Œæˆ"
          echo "======================================"
