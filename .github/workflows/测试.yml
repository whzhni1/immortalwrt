name: è·å–å®˜æ–¹ABI

on:
  workflow_dispatch:
    inputs:
      REPO_VERSION:
        description: 'é€‰æ‹© ImmortalWrt ç‰ˆæœ¬ (æ ¼å¼: v24.10.3)'
        required: true
        default: '24.10.3'
        type: string
      TARGET_NAME:
        description: 'å¹³å° (ä¾‹å¦‚ mediatek-filogic)'
        required: true
        default: 'mediatek-filogic'
        type: string

jobs:
  fetch-abi:
    runs-on: ubuntu-22.04
    steps:
      - name: æ‹¼æ¥å¹¶ä¸‹è½½å®˜æ–¹ manifest
        run: |
          echo "======================================"
          echo "ğŸ” å¼€å§‹è·å–å®˜æ–¹ ABI"
          echo "======================================"

          VERSION="${{ github.event.inputs.REPO_VERSION }}"
          TARGET_NAME="${{ github.event.inputs.TARGET_NAME }}"
          TARGET_PATH=$(echo "$TARGET_NAME" | tr '-' '/')

          # æ‹¼æ¥ URL
          OFFICIAL_MANIFEST_URL="https://downloads.immortalwrt.org/releases/$VERSION/targets/$TARGET_PATH/immortalwrt-$VERSION-$TARGET_NAME.manifest"

          echo "æ‹¼æ¥çš„å®˜æ–¹åœ°å€: $OFFICIAL_MANIFEST_URL"

          # ä¸‹è½½ manifest
          if wget -q -O official.manifest "$OFFICIAL_MANIFEST_URL"; then
            echo "âœ… å®˜æ–¹ manifest ä¸‹è½½æˆåŠŸ"
            echo "------ manifest å‰10è¡Œ ------"
            head -10 official.manifest
            echo "-----------------------------"

            # æå– kernel è¡Œ
            KERNEL_LINE=$(grep '^kernel ' official.manifest | head -1)
            echo "æå–åˆ°çš„ kernel è¡Œ: $KERNEL_LINE"

            KERNEL_ABI=$(echo "$KERNEL_LINE" | awk -F'~' '{print $2}')
            echo "è§£æå‡ºçš„ ABI: $KERNEL_ABI"
          else
            echo "âŒ å®˜æ–¹ manifest ä¸‹è½½å¤±è´¥"
            exit 1
          fi

          echo "======================================"
          echo "ä»»åŠ¡å®Œæˆ"
          echo "======================================"
