name: 获取官方ABI

on:
  workflow_dispatch:
    inputs:
      REPO_VERSION:
        description: '选择 ImmortalWrt 版本 (格式: v24.10.3)'
        required: true
        default: '24.10.3'
        type: string
      TARGET_NAME:
        description: '平台 (例如 mediatek-filogic)'
        required: true
        default: 'mediatek-filogic'
        type: string

jobs:
  fetch-abi:
    runs-on: ubuntu-22.04
    steps:
      - name: 拼接并下载官方 manifest
        run: |
          echo "======================================"
          echo "🔍 开始获取官方 ABI"
          echo "======================================"

          VERSION="${{ github.event.inputs.REPO_VERSION }}"
          TARGET_NAME="${{ github.event.inputs.TARGET_NAME }}"
          TARGET_PATH=$(echo "$TARGET_NAME" | tr '-' '/')

          # 拼接 URL
          OFFICIAL_MANIFEST_URL="https://downloads.immortalwrt.org/releases/$VERSION/targets/$TARGET_PATH/immortalwrt-$VERSION-$TARGET_NAME.manifest"

          echo "拼接的官方地址: $OFFICIAL_MANIFEST_URL"

          # 下载 manifest
          if wget -q -O official.manifest "$OFFICIAL_MANIFEST_URL"; then
            echo "✅ 官方 manifest 下载成功"
            echo "------ manifest 前10行 ------"
            head -10 official.manifest
            echo "-----------------------------"

            # 提取 kernel 行
            KERNEL_LINE=$(grep '^kernel ' official.manifest | head -1)
            echo "提取到的 kernel 行: $KERNEL_LINE"

            # 提取 32 位十六进制哈希
            OFFICIAL_VERMAGIC=$(echo "$KERNEL_LINE" | grep -oE '[0-9a-f]{32}')
            echo "解析出的 ABI: $OFFICIAL_VERMAGIC"

            # 测试1
            KERNEL_LINE="kernel - 5.15.189-1-dab81cfed92fb4881f7b4fec9f787850"
            echo "测试1提取到的 kernel 行: $KERNEL_LINE"
            TEST1_VERMAGIC=$(echo "$KERNEL_LINE" | grep -oE '[0-9a-f]{32}')
            echo "测试1解析出的 ABI: $TEST1_VERMAGIC"

            # 测试2
            KERNEL_LINE="kernel - 6.6.93~2ccac7a75355327cb6dfb4df1ecb575e-r1"
            echo "测试2提取到的 kernel 行: $KERNEL_LINE"
            TEST2_VERMAGIC=$(echo "$KERNEL_LINE" | grep -oE '[0-9a-f]{32}')
            echo "测试2解析出的 ABI: $TEST2_VERMAGIC"


            
          else
            echo "❌ 官方 manifest 下载失败"
            exit 1
          fi

          echo "======================================"
          echo "任务完成"
          echo "======================================"
