name: 获取官方ABI

on:
  workflow_dispatch:
    inputs:
      REPO_VERSION:
        description: '选择 ImmortalWrt 版本 (格式: v24.10.3)'
        required: true
        default: '24.10.3'
        type: string
      TARGET_NAME:
        description: '平台 (例如 mediatek-filogic)'
        required: true
        default: 'mediatek-filogic'
        type: string

jobs:
  fetch-abi:
    runs-on: ubuntu-22.04
    steps:
      - name: 拼接并下载官方 manifest
        run: |
          echo "======================================"
          echo "🔍 开始获取官方 ABI"
          echo "======================================"

          VERSION="${{ github.event.inputs.REPO_VERSION }}"
          TARGET_NAME="${{ github.event.inputs.TARGET_NAME }}"
          TARGET_PATH=$(echo "$TARGET_NAME" | tr '-' '/')

          # 拼接 URL
          OFFICIAL_MANIFEST_URL="https://downloads.immortalwrt.org/releases/$VERSION/targets/$TARGET_PATH/immortalwrt-$VERSION-$TARGET_NAME.manifest"

          echo "拼接的官方地址: $OFFICIAL_MANIFEST_URL"

          # 下载 manifest
          if wget -q -O official.manifest "$OFFICIAL_MANIFEST_URL"; then
            echo "✅ 官方 manifest 下载成功"
            echo "------ manifest 前10行 ------"
            head -10 official.manifest
            echo "-----------------------------"

            # 提取 kernel 行
            KERNEL_LINE=$(grep '^kernel ' official.manifest | head -1)
            echo "提取到的 kernel 行: $KERNEL_LINE"

            KERNEL_ABI=$(echo "$KERNEL_LINE" | awk -F'~' '{print $2}')
            echo "解析出的 ABI: $KERNEL_ABI"
          else
            echo "❌ 官方 manifest 下载失败"
            exit 1
          fi

          echo "======================================"
          echo "任务完成"
          echo "======================================"
