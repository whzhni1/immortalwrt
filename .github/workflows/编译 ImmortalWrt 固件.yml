#
# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-ImmortalWrt
# Description: Build ImmortalWrt for Multiple Devices
#

name: ç¼–è¯‘ ImmortalWrt å›ºä»¶

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      REPO_VERSION:
        description: 'é€‰æ‹© ImmortalWrt ç‰ˆæœ¬ (æ ¼å¼: v24.10.2 æˆ–åˆ†æ”¯å)'
        required: false
        default: 'v24.10'
        type: string
      DEVICE_MODEL:
        description: 'é€‰æ‹©è·¯ç”±å™¨åž‹å·'
        required: true
        default: 'rax3000m'
        type: choice
        options:
          - rax3000m
          - ax6000
      LAN_IP:
        description: 'è®¾ç½®LAN IPåœ°å€'
        required: true
        default: '192.168.1.1'
      SSH_CONNECTION:
        description: 'SSHè¿žæŽ¥åˆ°Actions'
        required: false
        default: false
        type: boolean
      UPLOAD_BIN_DIR:
        description: 'ä¸Šä¼ binç›®å½•'
        required: false
        default: false
        type: boolean
      UPLOAD_FIRMWARE:
        description: 'ä¸Šä¼ å›ºä»¶åˆ°Artifacts'
        required: false
        default: true
        type: boolean
      UPLOAD_RELEASE:
        description: 'å‘å¸ƒå›ºä»¶åˆ°Release'
        required: false
        default: true
        type: boolean
  schedule:
    - cron: 0 16 * * 5

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: ${{ github.event.inputs.REPO_VERSION || env.DEFAULT_VERSION }}
  FEEDS_CONF: feeds.conf.default
  DIY_P1_SH: part1.sh
  DIY_P2_SH: part2.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    
    permissions:
      contents: write
    
    steps:
    - name: æ£€æŸ¥é¡¹ç›®åˆ†æ”¯
      uses: actions/checkout@main

    - name: è®¾ç½®ç‰ˆæœ¬å˜é‡
      run: |
        # å¤„ç†ç‰ˆæœ¬è¾“å…¥
        if [ -n "${{ github.event.inputs.REPO_VERSION }}" ]; then
          REPO_VERSION="${{ github.event.inputs.REPO_VERSION }}"
          echo "ç”¨æˆ·æŒ‡å®šçš„ç‰ˆæœ¬: $REPO_VERSION"
          # ç›´æŽ¥ä½¿ç”¨è¾“å…¥çš„åˆ†æ”¯å
          echo "REPO_BRANCH=$REPO_VERSION" >> $GITHUB_ENV
        else
          echo "ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: immortalwrt-24.10"
          echo "REPO_BRANCH=immortalwrt-24.10" >> $GITHUB_ENV
        fi
        
        # æµ‹è¯•æ‹¼æŽ¥çš„æºç åœ°å€
        echo "======================================"
        echo "æºç ä»“åº“: $REPO_URL"
        echo "ç›®æ ‡åˆ†æ”¯: $REPO_BRANCH"
        echo "å®Œæ•´åœ°å€: $REPO_URL/tree/$REPO_BRANCH"
        echo "======================================"
        
        # éªŒè¯åˆ†æ”¯æ˜¯å¦å­˜åœ¨ï¼ˆå¯é€‰ï¼‰
        echo "æ­£åœ¨éªŒè¯åˆ†æ”¯æ˜¯å¦å­˜åœ¨..."
        if curl -s -I "$REPO_URL/tree/$REPO_BRANCH" | head -n 1 | grep -q "200"; then
          echo "âœ… ç‰ˆæœ¬éªŒè¯æˆåŠŸ: $REPO_BRANCH å­˜åœ¨"
        elif curl -s -I "$REPO_URL/releases/tag/$REPO_BRANCH" | head -n 1 | grep -q "200"; then
          echo "âœ… æ ‡ç­¾éªŒè¯æˆåŠŸ: $REPO_BRANCH å­˜åœ¨"
        else
          echo "âš ï¸  ç‰ˆæœ¬éªŒè¯: æ— æ³•ç›´æŽ¥éªŒè¯ $REPO_BRANCHï¼Œå°†ç»§ç»­å°è¯•å…‹éš†"
        fi
        
    - name: è®¾ç½®è®¾å¤‡å˜é‡
      run: |
        # è®¾ç½®è®¾å¤‡ç›¸å…³å˜é‡
        DEVICE_MODEL="${{ github.event.inputs.DEVICE_MODEL }}"
        if [ -z "$DEVICE_MODEL" ]; then
          DEVICE_MODEL="rax3000m"
        fi
        
        echo "DEVICE_MODEL=$DEVICE_MODEL" >> $GITHUB_ENV
        echo "CONFIG_FILE=${DEVICE_MODEL}.config" >> $GITHUB_ENV
        
        # æ ¹æ®è®¾å¤‡åž‹å·è®¾ç½®å˜é‡
        if [ "$DEVICE_MODEL" = "rax3000m" ]; then
          echo "DEVICE_NAME=cmcc_rax3000m" >> $GITHUB_ENV
          echo "DEVICE_FULL_NAME=CMCC-RAX3000M" >> $GITHUB_ENV
          echo "TARGET_NAME=mediatek-filogic" >> $GITHUB_ENV
        elif [ "$DEVICE_MODEL" = "ax6000" ]; then
          echo "DEVICE_NAME=jdcloud_re-cp-03" >> $GITHUB_ENV
          echo "DEVICE_FULL_NAME=JDCloud-AX6000" >> $GITHUB_ENV
          echo "TARGET_NAME=mediatek-filogic" >> $GITHUB_ENV
        fi
        
        echo "FILE_DATE=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV
        
        echo "======================================"
        echo "è®¾å¤‡åž‹å·: $DEVICE_MODEL"
        echo "é…ç½®æ–‡ä»¶: ${DEVICE_MODEL}.config"
        echo "======================================"

    - name: åˆå§‹åŒ–ç¼–è¯‘çŽ¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
          git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
          libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
          mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools \
          libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
          vim wget xmlto xxd zlib1g-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        echo "======================================"
        echo "ç¼–è¯‘çŽ¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
        echo "======================================"

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: ä¸‹è½½æºç 
      working-directory: /workdir
      run: |
        df -hT $PWD
        echo "æ­£åœ¨å…‹éš† ImmortalWrt æºç ..."
        echo "ä»“åº“: $REPO_URL"
        echo "åˆ†æ”¯/ç‰ˆæœ¬: $REPO_BRANCH"
        
        # æ˜¾ç¤ºå®Œæ•´çš„å…‹éš†å‘½ä»¤ç”¨äºŽè°ƒè¯•
        echo "æ‰§è¡Œå‘½ä»¤: git clone --depth 1 $REPO_URL -b $REPO_BRANCH ImmortalWrt"
        
        # å°è¯•å…‹éš†æŒ‡å®šçš„åˆ†æ”¯/ç‰ˆæœ¬
        if git clone --depth 1 "$REPO_URL" -b "$REPO_BRANCH" ImmortalWrt; then
          echo "âœ… æºç å…‹éš†æˆåŠŸ!"
          CLONE_STATUS="success"
        else
          echo "âŒ æŒ‡å®šçš„ç‰ˆæœ¬ '$REPO_BRANCH' å…‹éš†å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨é»˜è®¤åˆ†æ”¯..."
          if git clone --depth 1 "$REPO_URL" ImmortalWrt; then
            cd ImmortalWrt
            # æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯¥åˆ†æ”¯æˆ–æ ‡ç­¾
            if git show-ref --verify --quiet "refs/remotes/origin/$REPO_BRANCH" || git show-ref --verify --quiet "refs/tags/$REPO_BRANCH"; then
              echo "åˆ‡æ¢åˆ°ç‰ˆæœ¬ $REPO_BRANCH"
              git checkout "$REPO_BRANCH"
              CLONE_STATUS="success"
            else
              echo "âŒ ç‰ˆæœ¬ $REPO_BRANCH ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤åˆ†æ”¯"
              DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
              echo "ä½¿ç”¨é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"
              git checkout "$DEFAULT_BRANCH"
              CLONE_STATUS="fallback"
            fi
            cd ..
          else
            echo "âŒ æºç å…‹éš†å®Œå…¨å¤±è´¥!"
            CLONE_STATUS="failed"
            exit 1
          fi
        fi
        
        ln -sf /workdir/ImmortalWrt $GITHUB_WORKSPACE/ImmortalWrt
        cd ImmortalWrt
        
        # æ˜¾ç¤ºè¯¦ç»†çš„ç‰ˆæœ¬ä¿¡æ¯
        echo "======================================"
        echo "ImmortalWrt æºç ä¿¡æ¯:"
        echo "å½“å‰ç‰ˆæœ¬: $(git describe --tags 2>/dev/null || git branch --show-current)"
        echo "æœ€æ–°æäº¤: $(git log --oneline -1)"

        # æ˜¾ç¤ºæ˜¯åˆ†æ”¯è¿˜æ˜¯æ ‡ç­¾
        if git describe --exact-match --tags HEAD >/dev/null 2>&1; then
          echo "ç±»åž‹: æ ‡ç­¾ (Tag)"
        else
          echo "ç±»åž‹: åˆ†æ”¯ (Branch)"
        fi
        
        # å°è¯•èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
        if [ -f "include/version.mk" ]; then
          VERSION_NUMBER=$(grep 'VERSION_NUMBER' include/version.mk | cut -d'=' -f2 | tr -d ' ' || echo "æœªçŸ¥")
          echo "ç‰ˆæœ¬å·: $VERSION_NUMBER"
        fi
        
        if [ -f "Makefile" ]; then
          VERSION=$(grep '^VERSION' Makefile | head -1 | cut -d'=' -f2 | tr -d ' ' || echo "æœªçŸ¥")
          PATCHLEVEL=$(grep '^PATCHLEVEL' Makefile | head -1 | cut -d'=' -f2 | tr -d ' ' || echo "æœªçŸ¥")
          SUBLEVEL=$(grep '^SUBLEVEL' Makefile | head -1 | cut -d'=' -f2 | tr -d ' ' || echo "æœªçŸ¥")
          echo "ImmortalWrt ç‰ˆæœ¬: $VERSION.$PATCHLEVEL.$SUBLEVEL"
        fi
        
        echo "å…‹éš†çŠ¶æ€: $CLONE_STATUS"
        echo "======================================"

    - name: åˆ›å»ºé»˜è®¤è„šæœ¬
      run: |
        # å¦‚æžœ part1.sh ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤çš„
        if [ ! -f $DIY_P1_SH ]; then
          echo "åˆ›å»ºé»˜è®¤ part1.sh è„šæœ¬..."
          cat > $DIY_P1_SH <<'EOF'
        #!/bin/bash
        # DIY Part1 - åœ¨æ›´æ–°feedså‰æ‰§è¡Œ
        
        # Uncomment a feed source
        #sed -i 's/^#KATEX_INLINE_OPEN.*helloworldKATEX_INLINE_CLOSE/\1/' feeds.conf.default
        
        # Add feed sources
        #echo 'src-git helloworld https://github.com/fw876/helloworld' >> feeds.conf.default
        #echo 'src-git passwall https://github.com/xiaorouji/openwrt-passwall' >> feeds.conf.default
        
        # Add packages
        git clone --depth=1 https://github.com/gdy666/luci-app-lucky package/lucky
        git clone --depth=1 https://github.com/destan19/OpenAppFilter package/OpenAppFilter
        
        echo "Part1 è„šæœ¬æ‰§è¡Œå®Œæˆ!"
        EOF
        fi
        
        # å¦‚æžœ part2.sh ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤çš„
        if [ ! -f $DIY_P2_SH ]; then
          echo "åˆ›å»ºé»˜è®¤ part2.sh è„šæœ¬..."
          cat > $DIY_P2_SH <<'EOF'
        #!/bin/bash
        # DIY Part2 - åœ¨æ›´æ–°feedsåŽæ‰§è¡Œ
        
        # Modify default settings
        # sed -i 's/192.168.1.1/192.168.2.1/g' package/base-files/files/bin/config_generate
        
        echo "Part2 è„šæœ¬æ‰§è¡Œå®Œæˆ!"
        EOF
        fi

    - name: åŠ è½½è‡ªå®šä¹‰feedså’Œæ‰§è¡Œè„šæœ¬Part1
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF Immortalwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd ImmortalWrt
        echo "======================================"
        echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ Part1..."
        echo "======================================"
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: æ›´æ–°å¹¶å®‰è£…feeds
      run: |
        cd ImmortalWrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "======================================"
        echo "Feeds æ›´æ–°å®‰è£…å®Œæˆ"
        echo "======================================"

    - name: åŠ è½½è®¾å¤‡é…ç½®å’Œæ‰§è¡Œè„šæœ¬Part2
      run: |
        # æ£€æŸ¥è®¾å¤‡é…ç½®æ–‡ä»¶
        if [ ! -f "${{ env.CONFIG_FILE }}" ]; then
          echo "é”™è¯¯: æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ ${{ env.CONFIG_FILE }}"
          echo "åˆ›å»ºç¤ºä¾‹é…ç½®æ–‡ä»¶..."
          
          if [ "${{ env.DEVICE_MODEL }}" = "rax3000m" ]; then
            cat > ${{ env.CONFIG_FILE }} <<'EOF'
        CONFIG_TARGET_mediatek=y
        CONFIG_TARGET_mediatek_filogic=y
        CONFIG_TARGET_mediatek_filogic_DEVICE_cmcc_rax3000m=y
        EOF
          elif [ "${{ env.DEVICE_MODEL }}" = "ax6000" ]; then
            cat > ${{ env.CONFIG_FILE }} <<'EOF'
        CONFIG_TARGET_mediatek=y
        CONFIG_TARGET_mediatek_filogic=y
        CONFIG_TARGET_mediatek_filogic_DEVICE_jdcloud_re-cp-03=y
        EOF
          fi
        fi
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        echo "ä½¿ç”¨é…ç½®æ–‡ä»¶: ${{ env.CONFIG_FILE }}"
        cp ${{ env.CONFIG_FILE }} ImmortalWrt/.config
        
        # æ‰§è¡Œ Part2 è„šæœ¬
        chmod +x $DIY_P2_SH
        cd ImmortalWrt
        echo "======================================"
        echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ Part2..."
        echo "======================================"
        $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: è®¾ç½®LAN IPåœ°å€
      run: |
        cd ImmortalWrt
        SET_IP="${{ github.event.inputs.LAN_IP }}"
        if [ -z "$SET_IP" ]; then
          SET_IP="192.168.1.1"
        fi
        
        # éªŒè¯IPåœ°å€æ ¼å¼
        if [[ $SET_IP =~ ^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$ ]]; then
            # ä¿®æ”¹é»˜è®¤IPåœ°å€
            sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" package/base-files/files/bin/config_generate
            
            # ä¿®æ”¹LuCIç›¸å…³IP
            if [ -d "feeds/luci/modules/luci-mod-system" ]; then
              find feeds/luci/modules/luci-mod-system -type f -name "flash.js" -exec sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" {} + 2>/dev/null || true
            fi
            
            echo "IP_ADDR=$SET_IP" >> $GITHUB_ENV
            echo "======================================"
            echo "LAN IP åœ°å€è®¾ç½®ä¸º: $SET_IP"
            echo "======================================"
        else
            echo "IP_ADDR=192.168.1.1" >> $GITHUB_ENV
            echo "IPåœ°å€æ ¼å¼æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤: 192.168.1.1"
        fi

    - name: SSHè¿žæŽ¥åˆ°Actions
      uses: P3TERX/ssh2actions@v1.0.0
      if: github.event.inputs.SSH_CONNECTION == 'true'
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      id: package
      run: |
        cd ImmortalWrt
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        echo "======================================"
        echo "è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"
        echo "======================================"

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd ImmortalWrt
        echo -e "$(nproc) çº¿ç¨‹ç¼–è¯‘"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        echo "======================================"
        echo "å›ºä»¶ç¼–è¯‘å®Œæˆ"
        echo "======================================"

    - name: æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
      if: (!cancelled())
      run: df -hT

    - name: ä¸Šä¼ binç›®å½•
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && github.event.inputs.UPLOAD_BIN_DIR == 'true'
      with:
        name: ImmortalWrt_bin_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}
        path: ImmortalWrt/bin

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: github.event.inputs.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd ImmortalWrt/bin/targets/*/*
        rm -rf packages
        # åˆ é™¤ä¸éœ€è¦çš„æ–‡ä»¶
        find . -type f -name "*.buildinfo" -o -name "*.manifest" -o -name "*kernel.bin" -o -name "*rootfs.tar.gz" -o -name "*.dtb" | xargs rm -f
        # é‡å‘½åå›ºä»¶æ–‡ä»¶
        for file in *; do
          if [[ -f "$file" ]]; then
            new_name="${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-${file#*${{ env.DEVICE_NAME }}-}"
            mv "$file" "$new_name" 2>/dev/null || mv "$file" "${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-$file"
          fi
        done
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        echo "======================================"
        echo "å›ºä»¶æ•´ç†å®Œæˆï¼Œæ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -lh
        echo "======================================"

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifacts
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && github.event.inputs.UPLOAD_FIRMWARE == 'true'
      with:
        name: ${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}-Firmware
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: github.event.inputs.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        echo "release_tag=${{ env.FILE_DATE }}-${{ env.DEVICE_FULL_NAME }}" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT
        
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        cat > release.txt <<EOF
        # ${{ env.DEVICE_FULL_NAME }} å›ºä»¶
        
        ## ðŸ“‹ å›ºä»¶ä¿¡æ¯
        
        - **è®¾å¤‡åž‹å·**: ${{ env.DEVICE_FULL_NAME }}
        - **ç›®æ ‡å¹³å°**: ${{ env.TARGET_NAME }}
        - **ç¼–è¯‘æ—¶é—´**: ${{ env.FILE_DATE }}
        - **ç™»å½•åœ°å€**: ${{ env.IP_ADDR }}
        - **é»˜è®¤å¯†ç **: æ— å¯†ç æˆ– password
        
        ## ðŸ“¦ æºç ä¿¡æ¯
        
        - **æºç ä»“åº“**: ${{ env.REPO_URL }}
        - **æºç åˆ†æ”¯**: ${{ env.REPO_BRANCH }}
        
        ## âœ¨ ä¸»è¦åŠŸèƒ½
        
        æ ¹æ®é…ç½®æ–‡ä»¶åŒ…å«çš„æ’ä»¶ï¼š
        - LuCI ç®¡ç†ç•Œé¢
        - Lucky åŠ¨æ€åŸŸå
        - OpenAppFilter åº”ç”¨è¿‡æ»¤
        - Docker å®¹å™¨ç®¡ç†ï¼ˆå¦‚å·²é€‰æ‹©ï¼‰
        - PassWall / OpenClashï¼ˆå¦‚å·²é€‰æ‹©ï¼‰
        - å…¶ä»–è‡ªå®šä¹‰æ’ä»¶
        
        ## ðŸ“ åˆ·æœºè¯´æ˜Ž
        
        ### åŽŸåŽ‚å›ºä»¶åˆ·å…¥
        1. ä¸‹è½½å¯¹åº”çš„ \`factory.bin\` æ–‡ä»¶
        2. è¿›å…¥åŽŸåŽ‚å›ºä»¶ç®¡ç†ç•Œé¢
        3. é€‰æ‹©å›ºä»¶å‡çº§ï¼Œä¸Šä¼ æ–‡ä»¶
        4. ç­‰å¾…åˆ·æœºå®Œæˆï¼Œè‡ªåŠ¨é‡å¯
        
        ### ImmortalWrt å‡çº§
        1. ä¸‹è½½å¯¹åº”çš„ \`sysupgrade.bin\` æ–‡ä»¶
        2. è¿›å…¥ ç³»ç»Ÿ â†’ å¤‡ä»½/å‡çº§
        3. ä¸Šä¼ å›ºä»¶æ–‡ä»¶
        4. å–æ¶ˆå‹¾é€‰"ä¿ç•™é…ç½®"ï¼ˆå¦‚éœ€å…¨æ–°å®‰è£…ï¼‰
        5. ç‚¹å‡»"åˆ·å†™å›ºä»¶"
        
        ## âš ï¸ æ³¨æ„äº‹é¡¹
        
        - åˆ·æœºæœ‰é£Žé™©ï¼Œè¯·ç¡®ä¿è®¾å¤‡åž‹å·æ­£ç¡®
        - å»ºè®®å…ˆå¤‡ä»½åŽŸåŽ‚å›ºä»¶å’Œé‡è¦é…ç½®
        - åˆ·æœºè¿‡ç¨‹ä¸­è¯·å‹¿æ–­ç”µ
        - å¦‚é‡é—®é¢˜å¯å°è¯•æ¢å¤æ¨¡å¼é‡åˆ·
        
        ## ðŸ”— ç›¸å…³é“¾æŽ¥
        
        - [ImmortalWrt å®˜ç½‘](https://immortalwrt.org)
        - [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
        
        ---
        *æ­¤å›ºä»¶ç”± GitHub Actions è‡ªåŠ¨ç¼–è¯‘*
        EOF

    - name: å‘å¸ƒå›ºä»¶åˆ°Release
      uses: softprops/action-gh-release@v2.1.0
      if: steps.tag.outputs.status == 'success' && github.event.inputs.UPLOAD_RELEASE == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.FIRMWARE }}/*
        name: ${{ env.DEVICE_FULL_NAME }} - ${{ env.FILE_DATE }}
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        draft: false
        prerelease: false

    - name: åˆ é™¤æ—§çš„workflowè¿è¡Œè®°å½•
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 7
        keep_minimum_runs: 10

    - name: åˆ é™¤æ—§çš„Releases
      uses: dev-drprasad/delete-older-releases@v0.3.2
      if: github.event.inputs.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 10
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
